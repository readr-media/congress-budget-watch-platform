import{a,p as e,y as de,H as me}from"./chunk-4WY6JWTD-BhhSccj7.js";import{S as J,s as ge}from"./react-select.esm-C0Z57Klt.js";import{t as he,C as fe,m as ne,u as ae,f as U,a as pe,o as $,n as A,s as X,b as le,S as xe,B as ye,c as be,d as je,e as ve,g as Ce}from"./budget-by-legislator.schema-BLdalsXa.js";import{O as Z,u as ee,P as we,V as Ne,q as Se,l as Ae,j as ze}from"./gql-J0UfXxmj.js";import{l as Y}from"./floating-ui.dom-CHBx1iyJ.js";import{b as De}from"./index-DIRtge4E.js";import{p as ke,e as Pe}from"./visualization.queries-BPcNZc7Q.js";import{B as Me}from"./budget-detail-skeleton-BSMfEEnK.js";import"./hoist-non-react-statics.cjs-C4047zi0.js";import"./index-CAj4Y9Mz.js";import"./helpers-BOlTao1_.js";import"./index-BbHyWiA0.js";const Re=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],te=a.forwardRef((s,i)=>e.jsx("div",{className:"w-60",children:e.jsx(J,{ref:i,options:Re,...s})}));te.displayName="VisualizationSelector";const Ee=({activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${s==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${s==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(te,{options:y,value:h,onChange:m=>{m&&u(m)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),Ie=({activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u,isShowingAll:m,onToggleShowAll:l,legislatorOptions:f,selectedLegislator:c,onLegislatorChange:g,departmentOptions:p,selectedDepartment:x,onDepartmentChange:S})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:l,className:`rounded px-2.5 transition-colors ${m?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${s==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${s==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(te,{options:y,value:h,onChange:b=>{b&&u(b)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!m&&s==="legislator"&&(f.length>0?e.jsx(J,{className:"w-full",value:c,options:f,onChange:b=>{g(b??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!m&&s==="department"&&(p.length>0?e.jsx(J,{className:"w-full",value:x,options:p,onChange:b=>{S(b??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Le=s=>{var i;return(i=s.children)!=null&&i.length?s.depth===0?26:22:18},re=({data:s,width:i=928,height:y,onNodeClick:h,mode:u,transformedData:m,padding:l})=>{const f=a.useMemo(()=>m??he(s,u),[s,u,m]),c=a.useMemo(()=>l??Le,[l]);return Object.keys(f).length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:i},children:"無符合資料"}):e.jsx("div",{className:"flex flex-col items-center justify-center gap-y-8",children:Object.entries(f).map(([p,x])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:x.children&&x.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:p}),e.jsx(fe,{data:x,width:i,height:y??i,padding:c,onNodeClick:h})]})},p))})},oe=[{value:"114",label:"114年度 (2025)"},{value:"113",label:"113年度 (2024)"}],Oe=()=>{const[s,i]=a.useState("legislator"),[y,h]=a.useState("amount"),[u,m]=a.useState(oe[0]),[l,f]=a.useState(null),[c,g]=a.useState(null),p=a.useRef(null),x=a.useRef(null),[S,b]=a.useState(!0),[P,k]=a.useState(!0),j=De("(min-width: 768px)"),E=!j,M="id-asc",I=1,R=1e3,L=a.useCallback(()=>({year:{year:{equals:parseInt(u.value,10)}},mergedParentProposals:null,historicalParentProposals:null}),[u.value]),F=a.useMemo(()=>{const n=Y.find(ge,r=>r.value===M);if(!n)return[{id:Z.Desc}];const o=n.direction==="asc"?Z.Asc:Z.Desc;return[{[n.field]:o}]},[M]),{data:v,isLoading:G,isError:T}=ee({queryKey:ke.paginated(I,R,M,L(),parseInt(u.value,10)),queryFn:()=>ze(Pe,{skip:0,take:R,orderBy:F,where:L()}),placeholderData:Ae}),K=a.useCallback(n=>{i(n),j||(n==="legislator"?b(!0):k(!0))},[j]);a.useEffect(()=>{j&&(f(null),g(null),b(!0),k(!0))},[j]);const _=a.useCallback(n=>{m(n)},[]),Q=a.useCallback(n=>{f(n),b(!1),n&&(p.current=n)},[]),q=a.useCallback(n=>{g(n),k(!1),n&&(x.current=n)},[]),W=a.useCallback(()=>{s==="legislator"?l?(p.current=l,f(null),b(!1)):p.current&&(f(p.current),b(!1)):s==="department"&&(c?(x.current=c,g(null),k(!1)):x.current&&(g(x.current),k(!1)))},[s,l,c]),z=a.useMemo(()=>ne(v),[v]),O=a.useMemo(()=>{const n=new Map;return z.forEach(o=>{var N;const r=(N=o.proposers)==null?void 0:N[0],C=(r==null?void 0:r.id)??(r==null?void 0:r.name)??"",d=(r==null?void 0:r.name)??"未命名立委";C&&n.set(C,{value:C,label:d})}),Array.from(n.values()).sort((o,r)=>o.label.localeCompare(r.label,"zh-Hant"))},[z]),B=a.useMemo(()=>{const n=new Map;return z.forEach(o=>{var d,N;const r=(N=(d=o.government)==null?void 0:d.category)==null?void 0:N.trim(),C=r&&r.length>0?r:"未分類";n.set(C,{value:C,label:C})}),Array.from(n.values()).sort((o,r)=>o.label.localeCompare(r.label,"zh-Hant"))},[z]),t=a.useMemo(()=>{if(j||s!=="legislator"||!l)return null;const n=z.filter(o=>{var d;const r=(d=o.proposers)==null?void 0:d[0];return((r==null?void 0:r.id)??(r==null?void 0:r.name)??"")===l.value}).map(o=>o.id).filter(o=>!!o);return new Set(n)},[s,z,j,l]),w=a.useMemo(()=>{if(j||s!=="department"||!c)return null;const n=z.filter(o=>{var d,N;const r=(N=(d=o.government)==null?void 0:d.category)==null?void 0:N.trim();return(r&&r.length>0?r:"未分類")===c.value}).map(o=>o.id).filter(o=>!!o);return new Set(n)},[s,z,j,c]);a.useEffect(()=>{E&&(s==="legislator"?l&&O.some(o=>o.value===l.value)||(S&&O.length>0?f(O[0]):l&&f(null)):s==="department"&&(c&&B.some(o=>o.value===c.value)||(P&&B.length>0?g(B[0]):c&&g(null))))},[s,B,E,O,c,l,P,S]);const D=a.useMemo(()=>{var r;if(!v)return null;if(j)return v;let n=null;if(s==="legislator"&&t?n=t:s==="department"&&w&&(n=w),!n)return v;const o=((r=v.proposals)==null?void 0:r.filter(C=>{if(!C)return!1;const d=ae(Se,C),se=ae(Ne,d).id;return se!=null&&(n==null?void 0:n.has(se))}))??[];return{...v,proposals:o}},[s,v,w,t,j]),V=D??v??null,H=a.useMemo(()=>{const n=ne(D),o=Y.filter(n,d=>d.reductionAmount&&d.reductionAmount>0),r=Y.filter(n,d=>d.freezeAmount&&d.freezeAmount>0),C=Y.filter(n,d=>{var N;return(N=d.proposalTypes)==null?void 0:N.includes(we.Other)});return{totalReductionAmount:Y.sumBy(o,"reductionAmount"),reductionCount:o.length,totalFreezeAmount:Y.sumBy(r,"freezeAmount"),freezeCount:r.length,mainResolutionCount:C.length}},[D]),ie=U(H.totalReductionAmount),ue=U(H.totalFreezeAmount),ce=a.useMemo(()=>D?pe(D,y):null,[D,y]);return{activeTab:s,handleTabChange:K,mode:y,setMode:h,selectedYear:u,handleYearChange:_,yearOptions:oe,legislatorOptions:O,selectedLegislatorOption:l,handleLegislatorChange:Q,departmentOptions:B,selectedDepartmentOption:c,handleDepartmentChange:q,handleToggleShowAll:W,isShowingAll:s==="legislator"&&!l||s==="department"&&!c,isDesktop:j,isMobile:E,isLoading:G,isError:T,rawData:v,visualizationData:V,legislatorVisualizationData:ce,summaryStats:H,formattedReductionAmount:ie,formattedFreezeAmount:ue}},Be=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Ve=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Fe=({isDesktop:s})=>s?e.jsx(Be,{}):e.jsx(Ve,{}),Te=$({budgetYearId:X(),year:A()}),_e=$({reductionAmount:A(),reductionCount:A(),freezeAmount:A(),freezeCount:A(),otherCount:A()}),qe=$({governmentId:X(),name:X(),reductionAmount:A(),reductionCount:A(),freezeAmount:A(),freezeCount:A(),otherCount:A()}),Ye=$({yearInfo:Te,overall:_e,departments:le(qe)}),Ue=le(Ye),Ge=()=>{const[s,i]=a.useState(0),[y,h]=a.useState(300),u=a.useRef(null);return{ref:a.useCallback(l=>{if(u.current&&u.current.disconnect(),l){const c=requestAnimationFrame(()=>{const g=l.getBoundingClientRect().width;g>0&&(h(g),i(Math.round(g*9/16)))});return u.current=new ResizeObserver(g=>{const p=g[0];if(p){const x=p.contentRect.width;h(x),i(Math.round(x*9/16))}}),u.current.observe(l),()=>{cancelAnimationFrame(c)}}},[]),width:y,height:s}},$e=({activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u,mode:m,onModeChange:l,isShowingAll:f,onToggleShowAll:c,legislatorOptions:g,selectedLegislatorOption:p,onLegislatorChange:x,departmentOptions:S,selectedDepartmentOption:b,onDepartmentChange:P,isDesktop:k,isLoading:j,chartContainerRef:E,chartWidth:M,chartHeight:I,visualizationData:R,legislatorVisualizationData:L,legislatorSummary:F,departmentSummary:v,legislatorPadding:G,onNodeClick:T})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Ee,{activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u}),e.jsx(Ie,{activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u,isShowingAll:f,onToggleShowAll:c,legislatorOptions:g,selectedLegislator:p,onLegislatorChange:x,departmentOptions:S,selectedDepartment:b,onDepartmentChange:P}),e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:m==="amount",onChange:()=>l("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:m==="count",onChange:()=>l("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),e.jsx(xe,{summary:s==="legislator"?F:v}),e.jsx(ye,{items:be}),j&&e.jsx(Me,{isDesktop:k}),e.jsxs("div",{ref:E,className:"chart-container",children:[s==="legislator"&&L&&e.jsx(re,{data:R,transformedData:L,padding:G,onNodeClick:T,width:M,height:I,mode:m}),s==="department"&&e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"aspect-video md:aspect-video lg:aspect-video",children:e.jsx(re,{data:R,onNodeClick:T,width:M,height:I,mode:m})})})]})]})}),Ke=()=>{const{ref:s,width:i,height:y}=Ge(),h=me(),{activeTab:u,handleTabChange:m,mode:l,setMode:f,selectedYear:c,handleYearChange:g,yearOptions:p,legislatorOptions:x,selectedLegislatorOption:S,handleLegislatorChange:b,departmentOptions:P,selectedDepartmentOption:k,handleDepartmentChange:j,handleToggleShowAll:E,isShowingAll:M,isDesktop:I,isLoading:R,isError:L,visualizationData:F,legislatorVisualizationData:v}=Oe(),G=["budget","legislators",(S==null?void 0:S.value)??"all"],T=async()=>{const t=await fetch(je);if(!t.ok)throw new Error("無法載入立委預算資料");return ve.parse(await t.json())},K=async()=>{const t=await fetch(Ce);if(!t.ok)throw new Error("無法載入部會預算資料");return Ue.parse(await t.json())},{data:_}=ee({queryKey:G,queryFn:T,enabled:u==="legislator"}),Q=["budget","departments"],{data:q}=ee({queryKey:Q,queryFn:K,enabled:u==="department"}),W=a.useMemo(()=>{var V;const t=(V=_==null?void 0:_[0])==null?void 0:V.overall,w=(t==null?void 0:t.reductionAmount)??0,D=(t==null?void 0:t.freezeAmount)??0;return{formattedReductionAmount:U(w),formattedFreezeAmount:U(D),reductionCount:(t==null?void 0:t.reductionCount)??0,freezeCount:(t==null?void 0:t.freezeCount)??0,mainResolutionCount:(t==null?void 0:t.otherCount)??0}},[_]),z=a.useMemo(()=>{var V;const t=(V=q==null?void 0:q[0])==null?void 0:V.overall,w=(t==null?void 0:t.reductionAmount)??0,D=(t==null?void 0:t.freezeAmount)??0;return{formattedReductionAmount:U(w),formattedFreezeAmount:U(D),reductionCount:(t==null?void 0:t.reductionCount)??0,freezeCount:(t==null?void 0:t.freezeCount)??0,mainResolutionCount:(t==null?void 0:t.otherCount)??0}},[q]),O=a.useMemo(()=>{if(l==="amount")return t=>{var w;return(w=t.children)!=null&&w.length?t.depth===0?20:t.depth===1?36:18:10}},[l]),B=a.useCallback(t=>{var w;return t.proposalId?(h(`/budget/${t.proposalId}`),!0):t.proposerId&&!((w=t.children)!=null&&w.length)?(h(`/visualization/legislator/${t.proposerId}`),!0):!1},[h]);return R?e.jsx(Fe,{isDesktop:I}):L?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):F?e.jsx($e,{activeTab:u,onTabChange:m,yearOptions:p,selectedYear:c,onYearChange:g,mode:l,onModeChange:f,isShowingAll:M,onToggleShowAll:E,legislatorOptions:x,selectedLegislatorOption:S,onLegislatorChange:b,departmentOptions:P,selectedDepartmentOption:k,onDepartmentChange:j,isDesktop:I,isLoading:R,chartContainerRef:s,chartWidth:i,chartHeight:y,visualizationData:F,legislatorVisualizationData:v,legislatorSummary:W,departmentSummary:z,legislatorPadding:O,onNodeClick:B}):null},lt=de(Ke);export{lt as default};

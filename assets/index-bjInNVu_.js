import{a,p as e,H as fe,y as pe}from"./chunk-WWGJGFF6-C1k8rglg.js";import{t as de,G as xe,f as $,C as ae,S as ye,B as je,a as be,m as oe,u as ee,b as ve,c as Ce,d as we,o as Z,n as R,s as ne,e as me,g as Ne}from"./budget-by-legislator.schema-DjfUd6uW.js";import{B as Se}from"./budget-detail-skeleton-CmpMzIYN.js";import{S as X,Y as le}from"./react-select.esm-Ca9mRioo.js";import{u as re,P as Ae,V as ie,q as De,l as ze,j as Le}from"./gql-B77SbNtU.js";import{l as Q}from"./floating-ui.dom-0N10Lwd1.js";import"./helpers-DM_2piGp.js";import{b as Ee}from"./index-DrVPcFH7.js";import{p as Me,f as ke}from"./visualization.queries-BsSTzKn-.js";import"./index-CeHjcr3Z.js";import"./index-SkmILjJ3.js";import"./hoist-non-react-statics.cjs-1LUWegar.js";const Be=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],se=a.forwardRef((t,i)=>e.jsx("div",{className:"w-60",children:e.jsx(X,{ref:i,options:Be,...t})}));se.displayName="VisualizationSelector";var U=(t=>(t.Legislator="legislator",t.Department="department",t))(U||{}),ge=(t=>(t.Amount="amount",t.Count="count",t))(ge||{});const Re=({activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>i(U.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i(U.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(se,{options:d,value:m,onChange:f=>{f&&u(f)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),Pe=({activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u,isShowingAll:f,onToggleShowAll:c,legislatorOptions:r,selectedLegislator:n,onLegislatorChange:g,departmentOptions:x,selectedDepartment:C,onDepartmentChange:b})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:c,className:`rounded px-2.5 transition-colors ${f?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>i(U.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i(U.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(se,{options:d,value:m,onChange:p=>{p&&u(p)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!f&&t==="legislator"&&(r.length>0?e.jsx(X,{className:"w-full",value:n,options:r,onChange:p=>{g(p??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!f&&t==="department"&&(x.length>0?e.jsx(X,{className:"w-full",value:C,options:x,onChange:p=>{b(p??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Ie=t=>{var i;return(i=t.children)!=null&&i.length?t.depth===0?26:22:18},te=.45,ue=({data:t,width:i=928,height:d,onNodeClick:m,mode:u,transformedData:f,padding:c,selectedDepartmentCategorizedData:r,selectedDepartmentTitle:n,showSelectedDepartmentChart:g})=>{const x=a.useMemo(()=>f??de(t,u),[t,u,f]),C=a.useMemo(()=>c??Ie,[c]),b=a.useMemo(()=>{if(!r)return null;const j=Object.values(r).flatMap(v=>v.children??[]);if(!j.length)return null;const A=new Map;return j.forEach(v=>{var T;const h=[v.proposerId??v.name??"unknown",v.proposalType??"unknown-type"].join("-"),V=((T=v.name)==null?void 0:T.split(`
`)[0])??v.name??"無名提案者",F=v.value??0,P=F>0?Math.pow(F,1/te):0,M=xe[v.proposalType]??"",k=A.get(h);if(k){const w=k.totalAmount+P;A.set(h,{totalAmount:w,node:{...k.node,name:`${V}
${M}
${$(w)}`,value:Math.pow(w,te)}})}else A.set(h,{totalAmount:P,node:{...v,id:`merged-${h}`,name:`${V}
${M}
${$(P)}`,value:Math.pow(P,te)}})}),Array.from(A.values()).map(v=>v.node)},[r]),p=a.useMemo(()=>!b||!g?null:{id:`selected-department-${n??"selected"}`,name:n??"目前部會",children:b},[b,n,g]),z=Object.keys(x),D=p;return z.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:i},children:"無符合資料"}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-y-8",children:[D&&e.jsxs("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:[e.jsx("p",{className:"text-xl",children:"看全部"}),e.jsx(ae,{data:D,width:i,height:d??i,padding:C,onNodeClick:m})]},"selected-department-highlight"),Object.entries(x).map(([j,A])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:A.children&&A.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:j}),e.jsx(ae,{data:A,width:i,height:d??i,padding:C,onNodeClick:m})]})},j))]})},Ve=({mode:t,onModeChange:i})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:t==="amount",onChange:()=>i("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:t==="count",onChange:()=>i("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),Fe=({departmentOptions:t,selectedDepartmentOption:i,onDepartmentChange:d})=>t.length===0?e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"})}):e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx(X,{className:"w-full md:max-w-xl",value:i,options:t,onChange:m=>{d(m??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department-desktop"})}),Te=({activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u,mode:f,onModeChange:c,isShowingAll:r,onToggleShowAll:n,legislatorOptions:g,selectedLegislatorOption:x,onLegislatorChange:C,departmentOptions:b,selectedDepartmentOption:p,onDepartmentChange:z,isDesktop:D,isLoading:j,legislatorChartContainerRef:A,legislatorChartWidth:v,legislatorChartHeight:h,departmentChartContainerRef:V,departmentChartWidth:F,departmentChartHeight:P,visualizationData:M,legislatorVisualizationData:k,legislatorSummary:T,departmentSummary:w,legislatorPadding:E,selectedDepartmentCategorizedData:N,selectedDepartmentTitle:W,showSelectedDepartmentChart:G,onNodeClick:_})=>{const O=D&&t==="department",Y=t==="department"&&M,I=t==="legislator"&&k;return j?e.jsx(Se,{isDesktop:D}):e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Re,{activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u}),e.jsx(Pe,{activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u,isShowingAll:r,onToggleShowAll:n,legislatorOptions:g,selectedLegislator:x,onLegislatorChange:C,departmentOptions:b,selectedDepartment:p,onDepartmentChange:z}),e.jsx(Ve,{mode:f,onModeChange:c}),e.jsx(ye,{summary:t==="legislator"?T:w}),O&&e.jsx(Fe,{departmentOptions:b,selectedDepartmentOption:p,onDepartmentChange:z}),e.jsx(je,{items:be}),I&&e.jsx("div",{ref:A,className:"chart-container",children:e.jsx(ue,{data:M,transformedData:k,padding:E,onNodeClick:_,width:v,height:h,mode:f},"legislator-chart")}),Y&&e.jsx("div",{ref:V,className:"chart-container",children:e.jsx(ue,{data:M,onNodeClick:_,width:F,height:P,mode:f,selectedDepartmentCategorizedData:N,selectedDepartmentTitle:W??null,showSelectedDepartmentChart:G},"department-chart")})]})})},_e=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),$e=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Oe=({isDesktop:t})=>t?e.jsx(_e,{}):e.jsx($e,{}),ce=()=>{const d=Math.round(225),[m,u]=a.useState(d),[f,c]=a.useState(300),r=a.useRef(null);return{ref:a.useCallback(g=>{if(r.current&&r.current.disconnect(),!g)return;const C=requestAnimationFrame(()=>{const b=g.getBoundingClientRect().width;b<=0||(c(b),u(Math.round(b*.75)))});return r.current=new ResizeObserver(b=>{const p=b[0];if(!p)return;const z=p.contentRect.width;c(z),u(Math.round(z*.75))}),r.current.observe(g),()=>{cancelAnimationFrame(C)}},[]),width:f,height:m}},qe=()=>{const[t,i]=a.useState(U.Legislator),[d,m]=a.useState(ge.Amount),[u,f]=a.useState(le[0]),[c,r]=a.useState(null),[n,g]=a.useState(null),x=a.useRef(null),C=a.useRef(null),[b,p]=a.useState(!0),[z,D]=a.useState(!0),j=Ee("(min-width: 768px)"),A=!j,v=a.useCallback(()=>({year:{year:{equals:parseInt(u.value,10)}},mergedParentProposals:null,historicalParentProposals:null,result:{equals:"passed"}}),[u.value]),{data:h,isLoading:V,isError:F}=re({queryKey:Me.paginated(v(),parseInt(u.value,10)),queryFn:()=>Le(ke,{where:v()}),placeholderData:ze}),P=a.useCallback(s=>{if(i(s),!j){if(s==="legislator"){p(!0);return}D(!0)}},[j]);a.useEffect(()=>{j&&(r(null),g(null),p(!0),D(!0))},[j]);const M=a.useCallback(s=>{f(s)},[]),k=a.useCallback(s=>{r(s),p(!1),s&&(x.current=s)},[]),T=a.useCallback(s=>{g(s),D(!1),s&&(C.current=s)},[]),w=a.useMemo(()=>oe(h),[h]),E=a.useMemo(()=>{const s=new Map;return w.forEach(l=>{var L;const o=(L=l.proposers)==null?void 0:L[0],S=(o==null?void 0:o.id)??(o==null?void 0:o.name)??"",y=(o==null?void 0:o.name)??"未命名立委";S&&s.set(S,{value:S,label:y})}),Array.from(s.values()).sort((l,o)=>l.label.localeCompare(o.label,"zh-Hant"))},[w]),N=a.useMemo(()=>{const s=new Map;return w.forEach(l=>{var y,L;const o=(L=(y=l.government)==null?void 0:y.category)==null?void 0:L.trim(),S=o&&o.length>0?o:"未分類";s.set(S,{value:S,label:S})}),Array.from(s.values()).sort((l,o)=>l.label.localeCompare(o.label,"zh-Hant"))},[w]),W=a.useCallback(()=>{t==="legislator"?c?(x.current=c,r(null),p(!1)):x.current?(r(x.current),p(!1)):E.length>0&&(r(E[0]),p(!1)):t==="department"&&(n?(C.current=n,g(null),D(!1)):C.current?(g(C.current),D(!1)):N.length>0&&(g(N[0]),D(!1)))},[t,c,n,E,N]),G=a.useCallback(s=>{const l=s==null?void 0:s.trim();return l&&l.length>0?l:"未分類"},[]),_=a.useMemo(()=>{if(j||t!=="legislator"||!c)return null;const s=w.filter(l=>{var y;const o=(y=l.proposers)==null?void 0:y[0];return((o==null?void 0:o.id)??(o==null?void 0:o.name)??"")===c.value}).map(l=>l.id).filter(l=>!!l);return new Set(s)},[t,w,j,c]),O=a.useMemo(()=>{if(t!=="department"||!n)return null;const s=w.filter(l=>{var y,L;const o=(L=(y=l.government)==null?void 0:y.category)==null?void 0:L.trim();return(o&&o.length>0?o:"未分類")===n.value}).map(l=>l.id).filter(l=>!!l);return new Set(s)},[t,w,n]),Y=a.useMemo(()=>{var o;if(!h||t!=="department"||!n||!n.value)return null;const s=((o=h.proposals)==null?void 0:o.filter(S=>{var K;if(!S)return!1;const y=ee(ie,S);return G(((K=y.government)==null?void 0:K.category)??null)===n.value}))??[];if(!s.length)return null;const l={...h,proposals:s};return de(l,d)},[t,h,d,G,n]);a.useEffect(()=>{A&&(t==="legislator"?c&&E.some(l=>l.value===c.value)||(b&&E.length>0?r(E[0]):c&&r(null)):t==="department"&&(n&&N.some(l=>l.value===n.value)||(z&&N.length>0?g(N[0]):n&&g(null))))},[t,N,A,E,n,c,z,b]),a.useEffect(()=>{if(!j||t!=="department")return;!(n&&N.some(l=>l.value===n.value))&&N.length>0&&(g(N[0]),D(!1))},[t,N,j,n]);const I=a.useMemo(()=>{var o;if(!h)return null;let s=null;if(t==="legislator"&&_?s=_:t==="department"&&O&&(s=O),!s)return h;const l=((o=h.proposals)==null?void 0:o.filter(S=>{if(!S)return!1;const y=ee(ie,S),K=ee(De,y).id;return K!=null&&(s==null?void 0:s.has(K))}))??[];return{...h,proposals:l}},[t,h,O,_]),J=I??h??null,H=a.useMemo(()=>{const s=oe(I),l=Q.filter(s,y=>y.reductionAmount&&y.reductionAmount>0),o=Q.filter(s,y=>y.freezeAmount&&y.freezeAmount>0),S=Q.filter(s,y=>{var L;return(L=y.proposalTypes)==null?void 0:L.includes(Ae.Other)});return{totalReductionAmount:Q.sumBy(l,"reductionAmount"),reductionCount:l.length,totalFreezeAmount:Q.sumBy(o,"freezeAmount"),freezeCount:o.length,mainResolutionCount:S.length}},[I]),B=$(H.totalReductionAmount),q=$(H.totalFreezeAmount),he=a.useMemo(()=>I?ve(I,d):null,[I,d]);return{activeTab:t,handleTabChange:P,mode:d,setMode:m,selectedYear:u,handleYearChange:M,yearOptions:le,legislatorOptions:E,selectedLegislatorOption:c,handleLegislatorChange:k,departmentOptions:N,selectedDepartmentOption:n,handleDepartmentChange:T,handleToggleShowAll:W,isShowingAll:t==="legislator"&&!c||t==="department"&&!n,isDesktop:j,isMobile:A,isLoading:V,isError:F,rawData:h,visualizationData:J,legislatorVisualizationData:he,summaryStats:H,formattedReductionAmount:B,formattedFreezeAmount:q,selectedDepartmentCategorizedData:Y}},Ge=({selectedLegislatorOption:t,activeTab:i})=>{const d=["budget","legislators",(t==null?void 0:t.value)??"all"],m=async()=>{const n=await fetch(Ce);if(!n.ok)throw new Error("無法載入立委預算資料");return we.parse(await n.json())},{data:u,isLoading:f,isError:c}=re({queryKey:d,queryFn:m,enabled:i==="legislator"}),r=a.useMemo(()=>{var C;const n=(C=u==null?void 0:u[0])==null?void 0:C.overall,g=(n==null?void 0:n.reductionAmount)??0,x=(n==null?void 0:n.freezeAmount)??0;return{formattedReductionAmount:$(g),formattedFreezeAmount:$(x),reductionCount:(n==null?void 0:n.reductionCount)??0,freezeCount:(n==null?void 0:n.freezeCount)??0,mainResolutionCount:(n==null?void 0:n.otherCount)??0}},[u]);return{legislatorBudgetSummaryData:u,legislatorSummary:r,isLegislatorBudgetLoading:f,isLegislatorBudgetError:c}},Ue=Z({budgetYearId:ne(),year:R()}),We=Z({reductionAmount:R(),reductionCount:R(),freezeAmount:R(),freezeCount:R(),otherCount:R()}),Ye=Z({governmentId:ne(),name:ne(),reductionAmount:R(),reductionCount:R(),freezeAmount:R(),freezeCount:R(),otherCount:R()}),He=Z({yearInfo:Ue,overall:We,departments:me(Ye)}),Ke=me(He),Qe=({activeTab:t})=>{const i=async()=>{const r=await fetch(Ne);if(!r.ok)throw new Error("無法載入部會預算資料");return Ke.parse(await r.json())},d=["budget","departments"],{data:m,isLoading:u,isError:f}=re({queryKey:d,queryFn:i,enabled:t==="department"}),c=a.useMemo(()=>{var x;const r=(x=m==null?void 0:m[0])==null?void 0:x.overall,n=(r==null?void 0:r.reductionAmount)??0,g=(r==null?void 0:r.freezeAmount)??0;return{formattedReductionAmount:$(n),formattedFreezeAmount:$(g),reductionCount:(r==null?void 0:r.reductionCount)??0,freezeCount:(r==null?void 0:r.freezeCount)??0,mainResolutionCount:(r==null?void 0:r.otherCount)??0}},[m]);return{departmentBudgetSummaryData:m,departmentSummary:c,isDepartmentBudgetLoading:u,isDepartmentBudgetError:f}},Xe=({children:t})=>{const{ref:i,width:d,height:m}=ce(),{ref:u,width:f,height:c}=ce(),r=fe(),{activeTab:n,handleTabChange:g,mode:x,setMode:C,selectedYear:b,handleYearChange:p,yearOptions:z,legislatorOptions:D,selectedLegislatorOption:j,handleLegislatorChange:A,departmentOptions:v,selectedDepartmentOption:h,handleDepartmentChange:V,handleToggleShowAll:F,isShowingAll:P,isDesktop:M,isLoading:k,isError:T,visualizationData:w,legislatorVisualizationData:E,selectedDepartmentCategorizedData:N}=qe(),{legislatorSummary:W,isLegislatorBudgetLoading:G,isLegislatorBudgetError:_}=Ge({selectedLegislatorOption:j,activeTab:n}),{departmentSummary:O,isDepartmentBudgetLoading:Y,isDepartmentBudgetError:I}=Qe({activeTab:n}),J=a.useMemo(()=>{if(x==="amount")return B=>{var q;return(q=B.children)!=null&&q.length?B.depth===0?20:B.depth===1?36:18:10}},[x]),H=a.useCallback(B=>{var q;return B.proposalId?(r(`/budget/${B.proposalId}`),!0):B.proposerId&&!((q=B.children)!=null&&q.length)?(r(`/visualization/legislator/${B.proposerId}`),!0):!1},[r]);return k||G||Y?e.jsx(Oe,{isDesktop:M}):T||_||I?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):w?t({activeTab:n,onTabChange:g,yearOptions:z,selectedYear:b,onYearChange:p,mode:x,onModeChange:C,isShowingAll:P,onToggleShowAll:F,legislatorOptions:D,selectedLegislatorOption:j,onLegislatorChange:A,departmentOptions:v,selectedDepartmentOption:h,onDepartmentChange:V,isDesktop:M,isLoading:k,legislatorChartContainerRef:i,legislatorChartWidth:d,legislatorChartHeight:m,departmentChartContainerRef:u,departmentChartWidth:f,departmentChartHeight:c,visualizationData:w,legislatorVisualizationData:E,legislatorSummary:W,departmentSummary:O,legislatorPadding:J,selectedDepartmentCategorizedData:N,selectedDepartmentTitle:(h==null?void 0:h.label)??null,showSelectedDepartmentChart:!!N,onNodeClick:H}):null},Ze=()=>e.jsx(Xe,{children:t=>e.jsx(Te,{...t})}),mt=pe(Ze);export{mt as default};

import{a as n,p as e,y as ue,G as de}from"./chunk-4WY6JWTD-2Cr-QbDP.js";import{a as J,s as me}from"./options-COhGXY56.js";import{t as he,C as ge,m as te,u as se,f as ae,a as pe,T as U,b as H,c as Q,B as xe,d as fe}from"./tooltip-CDyB7B-4.js";import{O as K,u as je,P as be,V as ve,q as ye,l as Ne,j as Ce}from"./gql-HYPlJro8.js";import{l as O}from"./lodash-lK2eycnc.js";import{b as we}from"./index-Ck08PhAW.js";import{p as Se,e as ze,I as Z}from"./visualization.queries-gMEp7MMc.js";import{B as De}from"./budget-detail-skeleton-DMxLzU0j.js";import"./hoist-non-react-statics.cjs-BZ9oskQ4.js";import"./index-CtMSh7YR.js";import"./helpers-CUKl9yx0.js";import"./index-CSMLMQiO.js";const ke=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],X=n.forwardRef((s,i)=>e.jsx("div",{className:"w-60",children:e.jsx(J,{ref:i,options:ke,...s})}));X.displayName="VisualizationSelector";const Ae=({activeTab:s,onTabChange:i,yearOptions:x,selectedYear:f,onYearChange:o})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${s==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${s==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(X,{options:x,value:f,onChange:g=>{g&&o(g)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),Oe=({activeTab:s,onTabChange:i,yearOptions:x,selectedYear:f,onYearChange:o,isShowingAll:g,onToggleShowAll:r,legislatorOptions:m,selectedLegislator:c,onLegislatorChange:u,departmentOptions:h,selectedDepartment:p,onDepartmentChange:D})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:r,className:`rounded px-2.5 transition-colors ${g?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${s==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${s==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(X,{options:x,value:f,onChange:j=>{j&&o(j)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!g&&s==="legislator"&&(m.length>0?e.jsx(J,{className:"w-full",value:c,options:m,onChange:j=>{u(j??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!g&&s==="department"&&(h.length>0?e.jsx(J,{className:"w-full",value:p,options:h,onChange:j=>{D(j??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Me=s=>{var i;return(i=s.children)!=null&&i.length?s.depth===0?26:22:18},ne=({data:s,width:i=928,height:x,onNodeClick:f,mode:o,transformedData:g,padding:r})=>{const m=n.useMemo(()=>g??he(s,o),[s,o,g]),c=n.useMemo(()=>r??Me,[r]),u=Object.keys(m);return console.log({categories:u}),u.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:i},children:"無符合資料"}):e.jsx("div",{className:"flex flex-col items-center justify-center gap-y-8",children:Object.entries(m).map(([h,p])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:p.children&&p.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:h}),e.jsx(ge,{data:p,width:i,height:x??i,padding:c,onNodeClick:f})]})},h))})},le=[{value:"114",label:"114年度 (2025)"},{value:"113",label:"113年度 (2024)"}],Pe=()=>{const[s,i]=n.useState("legislator"),[x,f]=n.useState("amount"),[o,g]=n.useState(le[0]),[r,m]=n.useState(null),[c,u]=n.useState(null),h=n.useRef(null),p=n.useRef(null),[D,j]=n.useState(!0),[k,S]=n.useState(!0),b=we("(min-width: 768px)"),M=!b,P="id-asc",E=1,T=1e3,F=n.useCallback(()=>({year:{year:{equals:parseInt(o.value,10)}}}),[o.value]),I=n.useMemo(()=>{const t=O.find(me,a=>a.value===P);if(!t)return[{id:K.Desc}];const l=t.direction==="asc"?K.Asc:K.Desc;return[{[t.field]:l}]},[P]),{data:y,isLoading:R,isError:Y}=je({queryKey:Se.paginated(E,T,P,F(),parseInt(o.value,10)),queryFn:()=>Ce(ze,{skip:0,take:T,orderBy:I,where:F()}),placeholderData:Ne}),_=n.useCallback(t=>{i(t),b||(t==="legislator"?j(!0):S(!0))},[b]);n.useEffect(()=>{b&&(m(null),u(null),j(!0),S(!0))},[b]);const $=n.useCallback(t=>{g(t)},[]),B=n.useCallback(t=>{m(t),j(!1),t&&(h.current=t)},[]),C=n.useCallback(t=>{u(t),S(!1),t&&(p.current=t)},[]),z=n.useCallback(()=>{s==="legislator"?r?(h.current=r,m(null),j(!1)):h.current&&(m(h.current),j(!1)):s==="department"&&(c?(p.current=c,u(null),S(!1)):p.current&&(u(p.current),S(!1)))},[s,r,c]),w=n.useMemo(()=>te(y),[y]),L=n.useMemo(()=>{const t=new Map;return w.forEach(l=>{var N;const a=(N=l.proposers)==null?void 0:N[0],v=(a==null?void 0:a.id)??(a==null?void 0:a.name)??"",d=(a==null?void 0:a.name)??"未命名立委";v&&t.set(v,{value:v,label:d})}),Array.from(t.values()).sort((l,a)=>l.label.localeCompare(a.label,"zh-Hant"))},[w]),V=n.useMemo(()=>{const t=new Map;return w.forEach(l=>{var d,N;const a=(N=(d=l.government)==null?void 0:d.category)==null?void 0:N.trim(),v=a&&a.length>0?a:"未分類";t.set(v,{value:v,label:v})}),Array.from(t.values()).sort((l,a)=>l.label.localeCompare(a.label,"zh-Hant"))},[w]),q=n.useMemo(()=>{if(b||s!=="legislator"||!r)return null;const t=w.filter(l=>{var d;const a=(d=l.proposers)==null?void 0:d[0];return((a==null?void 0:a.id)??(a==null?void 0:a.name)??"")===r.value}).map(l=>l.id).filter(l=>!!l);return new Set(t)},[s,w,b,r]),G=n.useMemo(()=>{if(b||s!=="department"||!c)return null;const t=w.filter(l=>{var d,N;const a=(N=(d=l.government)==null?void 0:d.category)==null?void 0:N.trim();return(a&&a.length>0?a:"未分類")===c.value}).map(l=>l.id).filter(l=>!!l);return new Set(t)},[s,w,b,c]);n.useEffect(()=>{M&&(s==="legislator"?r&&L.some(l=>l.value===r.value)||(D&&L.length>0?m(L[0]):r&&m(null)):s==="department"&&(c&&V.some(l=>l.value===c.value)||(k&&V.length>0?u(V[0]):c&&u(null))))},[s,V,M,L,c,r,k,D]);const A=n.useMemo(()=>{var a;if(!y)return null;if(b)return y;let t=null;if(s==="legislator"&&q?t=q:s==="department"&&G&&(t=G),!t)return y;const l=((a=y.proposals)==null?void 0:a.filter(v=>{if(!v)return!1;const d=se(ye,v),ee=se(ve,d).id;return ee!=null&&(t==null?void 0:t.has(ee))}))??[];return{...y,proposals:l}},[s,y,G,q,b]),re=A??y??null,W=n.useMemo(()=>{const t=te(A),l=O.filter(t,d=>d.reductionAmount&&d.reductionAmount>0),a=O.filter(t,d=>d.freezeAmount&&d.freezeAmount>0),v=O.filter(t,d=>{var N;return(N=d.proposalTypes)==null?void 0:N.includes(be.Other)});return{totalReductionAmount:O.sumBy(l,"reductionAmount"),reductionCount:l.length,totalFreezeAmount:O.sumBy(a,"freezeAmount"),freezeCount:a.length,mainResolutionCount:v.length}},[A]),ie=ae(W.totalReductionAmount),oe=ae(W.totalFreezeAmount),ce=n.useMemo(()=>A?pe(A,x):null,[A,x]);return{activeTab:s,handleTabChange:_,mode:x,setMode:f,selectedYear:o,handleYearChange:$,yearOptions:le,legislatorOptions:L,selectedLegislatorOption:r,handleLegislatorChange:B,departmentOptions:V,selectedDepartmentOption:c,handleDepartmentChange:C,handleToggleShowAll:z,isShowingAll:s==="legislator"&&!r||s==="department"&&!c,isDesktop:b,isMobile:M,isLoading:R,isError:Y,rawData:y,visualizationData:re,legislatorVisualizationData:ce,summaryStats:W,formattedReductionAmount:ie,formattedFreezeAmount:oe}},Te=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Ie=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Re=({isDesktop:s})=>s?e.jsx(Te,{}):e.jsx(Ie,{}),Le=()=>{const[s,i]=n.useState(0),[x,f]=n.useState(300),o=n.useRef(null);return{ref:n.useCallback(r=>{if(o.current&&o.current.disconnect(),r){const c=requestAnimationFrame(()=>{const u=r.getBoundingClientRect().width;u>0&&(f(u),i(Math.round(u*9/16)))});return o.current=new ResizeObserver(u=>{const h=u[0];if(h){const p=h.contentRect.width;f(p),i(Math.round(p*9/16))}}),o.current.observe(r),()=>{cancelAnimationFrame(c)}}},[]),width:x,height:s}},Ve=()=>{const{ref:s,width:i,height:x}=Le(),f=de(),{activeTab:o,handleTabChange:g,mode:r,setMode:m,selectedYear:c,handleYearChange:u,yearOptions:h,legislatorOptions:p,selectedLegislatorOption:D,handleLegislatorChange:j,departmentOptions:k,selectedDepartmentOption:S,handleDepartmentChange:b,handleToggleShowAll:M,isShowingAll:P,isDesktop:E,isLoading:T,isError:F,visualizationData:I,legislatorVisualizationData:y,summaryStats:R,formattedReductionAmount:Y,formattedFreezeAmount:_}=Pe(),$=n.useMemo(()=>{if(r==="amount")return C=>{var z;return(z=C.children)!=null&&z.length?C.depth===0?20:C.depth===1?36:18:10}},[r]),B=n.useCallback(C=>{var z;return C.proposalId?(f(`/budget/${C.proposalId}`),!0):C.proposerId&&!((z=C.children)!=null&&z.length)?(f(`/visualization/legislator/${C.proposerId}`),!0):!1},[f]);return T?e.jsx(Re,{isDesktop:E}):F?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):I?e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Ae,{activeTab:o,onTabChange:g,yearOptions:h,selectedYear:c,onYearChange:u}),e.jsx(Oe,{activeTab:o,onTabChange:g,yearOptions:h,selectedYear:c,onYearChange:u,isShowingAll:P,onToggleShowAll:M,legislatorOptions:p,selectedLegislator:D,onLegislatorChange:j,departmentOptions:k,selectedDepartment:S,onDepartmentChange:b}),e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:r==="amount",onChange:()=>m("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:r==="count",onChange:()=>m("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),e.jsx("div",{className:"bg-surface-notice md:max-w-visualization-card flex flex-col items-center justify-center rounded-lg border-2 p-2.5 md:mx-auto",children:e.jsxs("div",{children:[e.jsxs("p",{children:["總共刪減"," ",e.jsx("span",{className:"text-budget-accent",children:Y}),"（",e.jsx("span",{className:"text-budget-accent",children:R.reductionCount}),"個提案）",e.jsxs(U,{children:[e.jsx(H,{asChild:!0,children:e.jsx("span",{className:"ml-1 inline-flex",children:e.jsx(Z,{src:"/icon/icon-explain.svg",alt:"說明",className:"h-4 w-4"})})}),e.jsx(Q,{className:"bg-black text-white",children:"刪減案相關說明"})]})]}),e.jsxs("p",{children:["凍結"," ",e.jsx("span",{className:"text-budget-accent",children:_}),"（",e.jsx("span",{className:"text-budget-accent",children:R.freezeCount}),"個提案）",e.jsxs(U,{children:[e.jsx(H,{asChild:!0,children:e.jsx("span",{className:"ml-1 inline-flex",children:e.jsx(Z,{src:"/icon/icon-explain.svg",alt:"說明",className:"h-4 w-4"})})}),e.jsx(Q,{className:"bg-black text-white",children:"凍結案相關說明"})]})]}),e.jsxs("p",{children:["主決議提案數：",e.jsx("span",{className:"text-budget-accent",children:R.mainResolutionCount}),"個",e.jsxs(U,{children:[e.jsx(H,{asChild:!0,children:e.jsx("span",{className:"ml-1 inline-flex",children:e.jsx(Z,{src:"/icon/icon-explain.svg",alt:"說明",className:"h-4 w-4"})})}),e.jsx(Q,{className:"bg-black text-white",children:"主決議提案相關說明"})]})]})]})}),e.jsx(xe,{items:fe}),T&&e.jsx(De,{isDesktop:E}),e.jsxs("div",{ref:s,className:"chart-container",children:[o==="legislator"&&y&&e.jsx(ne,{data:I,transformedData:y,padding:$,onNodeClick:B,width:i,height:x,mode:r}),o==="department"&&e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"aspect-video md:aspect-video lg:aspect-video",children:e.jsx(ne,{data:I,onNodeClick:B,width:i,height:x,mode:r})})})]})]})}):null},Ze=ue(Ve);export{Ze as default};

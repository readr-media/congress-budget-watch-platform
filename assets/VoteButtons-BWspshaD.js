var Q=s=>{throw TypeError(s)};var U=(s,e,t)=>e.has(s)||Q("Cannot "+t);var a=(s,e,t)=>(U(s,e,"read from private field"),t?t.call(s):e.get(s)),j=(s,e,t)=>e.has(s)?Q("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),V=(s,e,t,n)=>(U(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t),N=(s,e,t)=>(U(s,e,"access private method"),t);import{a as u,p as h}from"./chunk-OIYGIGL5-DIb7gZ_H.js";import{i as te,j as se,f as ne}from"./helpers-By--BNaP.js";import{U as oe,I as q}from"./visualization.queries-C3UqKk6-.js";import{z as ae,A as re,B as ie,w as ce,x as ue}from"./middleware-Q8Bez-TY.js";import{S as le,v as de,i as z,n as G,w as J,c as he,x as ge,j as pe}from"./gql-DSg_pHIo.js";import{g as ve}from"./mutation-DKViK3Km.js";var y,S,g,x,_,F,I,Y,fe=(Y=class extends le{constructor(e,t){super();j(this,_);j(this,y);j(this,S);j(this,g);j(this,x);V(this,y,e),this.setOptions(t),this.bindMethods(),N(this,_,F).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var n;const t=this.options;this.options=a(this,y).defaultMutationOptions(e),de(this.options,t)||a(this,y).getMutationCache().notify({type:"observerOptionsUpdated",mutation:a(this,g),observer:this}),t!=null&&t.mutationKey&&this.options.mutationKey&&z(t.mutationKey)!==z(this.options.mutationKey)?this.reset():((n=a(this,g))==null?void 0:n.state.status)==="pending"&&a(this,g).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=a(this,g))==null||e.removeObserver(this)}onMutationUpdate(e){N(this,_,F).call(this),N(this,_,I).call(this,e)}getCurrentResult(){return a(this,S)}reset(){var e;(e=a(this,g))==null||e.removeObserver(this),V(this,g,void 0),N(this,_,F).call(this),N(this,_,I).call(this)}mutate(e,t){var n;return V(this,x,t),(n=a(this,g))==null||n.removeObserver(this),V(this,g,a(this,y).getMutationCache().build(a(this,y),this.options)),a(this,g).addObserver(this),a(this,g).execute(e)}},y=new WeakMap,S=new WeakMap,g=new WeakMap,x=new WeakMap,_=new WeakSet,F=function(){var t;const e=((t=a(this,g))==null?void 0:t.state)??ve();V(this,S,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},I=function(e){G.batch(()=>{var t,n,r,c,i,p,E,v;if(a(this,x)&&this.hasListeners()){const d=a(this,S).variables,m=a(this,S).context,l={client:a(this,y),meta:this.options.meta,mutationKey:this.options.mutationKey};(e==null?void 0:e.type)==="success"?((n=(t=a(this,x)).onSuccess)==null||n.call(t,e.data,d,m,l),(c=(r=a(this,x)).onSettled)==null||c.call(r,e.data,null,d,m,l)):(e==null?void 0:e.type)==="error"&&((p=(i=a(this,x)).onError)==null||p.call(i,e.error,d,m,l),(v=(E=a(this,x)).onSettled)==null||v.call(E,void 0,e.error,d,m,l))}this.listeners.forEach(d=>{d(a(this,S))})})},Y);function me(s,e){const t=J(),[n]=u.useState(()=>new fe(t,s));u.useEffect(()=>{n.setOptions(s)},[n,s]);const r=u.useSyncExternalStore(u.useCallback(i=>n.subscribe(G.batchCalls(i)),[n]),()=>n.getCurrentResult(),()=>n.getCurrentResult()),c=u.useCallback((i,p)=>{n.mutate(i,p).catch(he)},[n]);if(r.error&&ge(n.options.throwOnError,[r.error]))throw r.error;return{...r,mutate:c,mutateAsync:r.mutate}}const be={votes:{},pending:{}},ye=()=>ue(be),B=()=>({react_good:0,react_angry:0,react_disappoint:0,react_whatever:0}),xe=s=>({react_good:s.react_good??0,react_angry:s.react_angry??0,react_disappoint:s.react_disappoint??0,react_whatever:s.react_whatever??0}),A=s=>(s.pending||(s.pending={}),s.pending),b=ae()(re(ie(ce(s=>({state:ye(),actions:{initProposal:e=>{s(t=>{const r=A(t.state)[e.id],c=r&&Object.keys(r).length>0;(!(e.id in t.state.votes)||!c)&&(t.state.votes[e.id]=xe(e))})},queueVote:(e,t)=>s(n=>{const r=A(n.state);e in n.state.votes||(n.state.votes[e]=B()),n.state.votes[e][t]+=1,e in r||(r[e]={}),r[e][t]=!0}),setProposalCounts:(e,t)=>s(n=>{n.state.votes[e]={...B(),...t}}),refreshProposalCounts:e=>s(t=>{const n=t.state.votes[e];n&&(t.state.votes[e]={...n})}),removePendingReactions:(e,t)=>s(n=>{const c=A(n.state)[e];c&&(t.forEach(i=>{delete c[i]}),Object.keys(c).length===0&&delete n.state.pending[e])}),clearProposalPending:e=>s(t=>{const n=A(t.state);delete n[e]})}})),{name:"vote-storage",partialize:s=>({state:{votes:s.state.votes,pending:s.state.pending}})}),{name:"vote-store",enabled:!1})),_e=()=>b(s=>s.actions),we=s=>b(e=>e.state.votes[s]),Ce=()=>{const s=J();return me({mutationFn:({proposalId:e,apiPayload:t})=>pe(oe,{where:{id:e},data:t}),onSettled:(e,t,n,r)=>{s.invalidateQueries({queryKey:["proposal",n.proposalId]}),s.invalidateQueries({queryKey:["proposals"]});try{const c=e;if(c!=null&&c.updateProposal){const i=c.updateProposal;b.getState().actions.setProposalCounts(n.proposalId,{react_good:i.react_good??0,react_angry:i.react_angry??0,react_disappoint:i.react_disappoint??0,react_whatever:i.react_whatever??0})}else b.getState().actions.refreshProposalCounts(n.proposalId)}catch{}}})},Se=2e3,Ee=(s=Se)=>{const{mutateAsync:e}=Ce(),t=u.useRef(null),n=u.useRef(!1),r=u.useRef(e),c=u.useRef(s);u.useEffect(()=>{r.current=e},[e]),u.useEffect(()=>{c.current=s},[s]);const i=u.useCallback(async()=>{if(n.current)return{success:!0,errors:[]};const v=[],d=[],m=Object.entries(b.getState().state.pending);if(!m.length)return{success:!0,errors:v};n.current=!0;try{for(const[l,w]of m){const f=Object.keys(w);if(!f.length){b.getState().actions.clearProposalPending(l);continue}const{votes:M}=b.getState().state,O=M[l];if(!O){b.getState().actions.clearProposalPending(l);continue}const C={};if(f.forEach(k=>{C[k]=O[k]}),!Object.keys(C).length){b.getState().actions.removePendingReactions(l,f);continue}try{await r.current({proposalId:l,apiPayload:C}),d.push({proposalId:l,reactions:f})}catch(k){v.push({proposalId:l,error:k})}}}finally{n.current=!1}if(d.length){const{removePendingReactions:l}=b.getState().actions;d.forEach(({proposalId:w,reactions:f})=>{l(w,f)})}return{success:v.length===0,errors:v}},[]),p=u.useCallback(()=>{t.current&&(window.clearTimeout(t.current),t.current=null)},[]),E=u.useCallback(()=>{p(),t.current=window.setTimeout(()=>{t.current=null,i()},c.current)},[p,i]);return u.useEffect(()=>{const v=()=>{document.visibilityState==="hidden"&&i()},d=()=>{i()};return window.addEventListener("beforeunload",d),document.addEventListener("visibilitychange",v),()=>{p(),window.removeEventListener("beforeunload",d),document.removeEventListener("visibilitychange",v),i()}},[p,i]),{scheduleFlush:E,cancelScheduledFlush:p,flushPending:i}},D={react_good:{default:"/image/vote-good-default.svg",hover:"/image/vote-good-hover.svg",active:"/image/vote-good-active.svg"},react_angry:{default:"/image/vote-angry-default.svg",hover:"/image/vote-angry-hover.svg",active:"/image/vote-angry-active.svg"},react_disappoint:{default:"/image/vote-sad-default.svg",hover:"/image/vote-sad-hover.svg",active:"/image/vote-sad-active.svg"},react_whatever:{default:"/image/vote-whatever-default.svg",hover:"/image/vote-whatever-hover.svg",active:"/image/vote-whatever-active.svg"}},H=[{type:"react_good",label:"我覺得很讚"},{type:"react_angry",label:"我感到生氣"},{type:"react_disappoint",label:"我有點失望"},{type:"react_whatever",label:"我不在意"}];function Te({proposal:s,shouldShowCount:e=!0,singleButtonStyle:t="",displayMode:n="inline"}){const{initProposal:r,queueVote:c}=_e(),{scheduleFlush:i,flushPending:p,cancelScheduledFlush:E}=Ee(),[v,d,m]=te(),l=u.useRef(null),{id:w,react_good:f,react_angry:M,react_disappoint:O,react_whatever:C}=s;se(l,()=>{m(!1),P(null),E(),p()});const W=u.useMemo(()=>({react_good:f??0,react_angry:M??0,react_disappoint:O??0,react_whatever:C??0}),[f,M,O,C]),X=we(w)??W,[R,Z]=u.useState(null),[ee,P]=u.useState(null),K=o=>R===o?D[o].active:ee===o?D[o].hover:D[o].default,$=o=>{Z(o),c(w,o),P(null),n==="popup"?(m(!1),E(),p()):i()};return u.useEffect(()=>{r({id:w,react_good:f,react_angry:M,react_disappoint:O,react_whatever:C})},[r,w,f,M,O,C]),n==="popup"?h.jsxs("div",{ref:l,className:"relative",children:[h.jsx("button",{onClick:o=>{o.preventDefault(),d()},className:`flex h-8 min-w-[68px] cursor-pointer items-center justify-center rounded-sm bg-white text-[8px] border-2 ${R?"border-transparent":"px-2 py-1"}`,children:R?h.jsx(q,{src:K(R),alt:"Selected reaction",className:"h-full w-auto"}):h.jsx("span",{children:"請支援心情"})}),v&&h.jsx("div",{className:"md: absolute right-0 bottom-0 z-10 w-[69px] rounded-[24px] border-2 bg-white p-2.5 text-[9px] md:translate-x-8 md:translate-y-[10.5rem] lg:translate-x-11 lg:translate-y-[10.5rem]",children:H.map(({type:o,label:T})=>h.jsxs("div",{onClick:()=>$(o),onMouseEnter:()=>P(o),onMouseLeave:()=>P(L=>L===o?null:L),className:`mt-1.5 flex cursor-pointer flex-col items-center justify-center first:mt-0 ${R===o?"shadow-lg":""}`,children:[h.jsx(q,{src:K(o),alt:T,className:"w-12"}),h.jsx("p",{children:T})]},o))})]}):(console.log({singleButtonStyle:t}),h.jsx("div",{className:"flex justify-center gap-4 px-3 py-2.5",children:H.map(({type:o,label:T})=>h.jsxs("div",{className:`flex w-[120px] flex-col items-center text-center ${t}`,onMouseEnter:()=>P(o),onMouseLeave:()=>P(L=>L===o?null:L),children:[h.jsx("p",{className:"text-sm font-medium",children:T}),e&&h.jsx("p",{className:"font-base text-base",children:ne(X[o])}),h.jsx("button",{type:"button",onClick:()=>$(o),className:`mt-3 flex w-full items-center justify-center rounded-lg bg-transparent transition-opacity ${R===o?"opacity-100":"opacity-80"}`,children:h.jsx(q,{src:K(o),alt:T,className:"w-[120px] max-w-full"})})]},o))}))}export{Te as V,we as u};

import{p as e,a as i,H as he,y as fe}from"./chunk-JZWAC4HX-Ct9RjdWh.js";import{V as ce,t as de,G as xe,f as H,C as ee,S as ye,B as be,a as je,m as ve,g as te,b as we,u as Q,c as Ne,d as Se,e as Ce,h as ke}from"./budget-endpoints-CFNdu5ts.js";import{B as De}from"./budget-detail-skeleton-BV1CDzah.js";import{S as X,c as ue,Y as ne}from"./react-select.esm-DdJz1C4J.js";import{b as me}from"./index-Y9OsAbSh.js";import{u as Y,k as pe,q as Ae,V as re,t as Le}from"./gql-O11rvESk.js";import{a as Ee,b as ze,p as Ie,g as Me}from"./visualization.queries-DcDuSFa6.js";import"./helpers-RynDArtI.js";import"./index-CGdvuWtd.js";import"./index-DWhu2-He.js";import"./hoist-non-react-statics.cjs-DwzeC8GI.js";var q=(t=>(t.Legislator="legislator",t.Department="department",t))(q||{}),T=(t=>(t.Amount="amount",t.Count="count",t))(T||{});const Pe=({activeTab:t,onTabChange:c,yearOptions:f,selectedYear:x,onYearChange:p})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>c(q.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>c(q.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ce,{options:f,value:x,onChange:n=>{n&&p(n)},"aria-label":"選擇年度",inputId:"visualization-year-desktop",variant:"year-dropdown",wrapperClassName:"w-[200px]"})})]}),se=t=>e.jsx(ue.DropdownIndicator,{...t,children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:`flex-none transition-transform duration-200 ${t.selectProps.menuIsOpen?"rotate-[180deg]":""}`,children:e.jsx("div",{className:"relative size-[12px]",children:e.jsx("div",{className:"absolute top-[8.33%] right-[12.79%] bottom-1/4 left-[12.79%]",children:e.jsx("svg",{className:"block size-full",fill:"none",preserveAspectRatio:"none",viewBox:"0 0 8.93119 8",children:e.jsx("path",{d:"M0.5 2.5L4.4656 6.5L8.4312 2.5H0.5Z",fill:"black"})})})})})})}),ae={control:t=>({...t,width:"172px",minHeight:"28px",height:"28px",backgroundColor:"white",border:"2px solid black",borderRadius:"8px",boxShadow:"none",cursor:"pointer",padding:"0 10px","&:hover":{border:"2px solid black"}}),valueContainer:t=>({...t,padding:"0",height:"28px"}),input:t=>({...t,margin:"0",padding:"0"}),indicatorSeparator:()=>({display:"none"}),indicatorsContainer:t=>({...t,height:"28px"}),dropdownIndicator:t=>({...t,padding:"0",paddingLeft:"10px"}),singleValue:t=>({...t,fontSize:"16px",fontFamily:"'Noto Sans T Chinese:Bold', sans-serif",fontWeight:"bold",color:"black",margin:"0"}),menu:t=>({...t,width:"172px",marginTop:"4px",borderRadius:"8px",border:"2px solid black",boxShadow:"none",overflow:"hidden",padding:"4px 0"}),menuList:t=>({...t,padding:"0",display:"flex",flexDirection:"column",gap:"8px"}),option:(t,c)=>({...t,fontSize:"18px",fontFamily:"'Noto Sans T Chinese:Medium', sans-serif",fontWeight:"500",textAlign:"center",backgroundColor:"white",color:c.isSelected?"#3e51ff":"black",cursor:"pointer",padding:"0","&:hover":{backgroundColor:"#f5f5f5"}})},Re=({activeTab:t,onTabChange:c,yearOptions:f,selectedYear:x,onYearChange:p,isShowingAll:n,onToggleShowAll:l,legislatorOptions:h,selectedLegislator:a,onLegislatorChange:o,departmentOptions:u,selectedDepartment:w,onDepartmentChange:g})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:l,className:`rounded px-2.5 transition-colors ${n?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>c(q.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>c(q.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ce,{options:f,value:x,onChange:y=>{y&&p(y)},"aria-label":"選擇年度",inputId:"visualization-year-mobile",variant:"year-dropdown",wrapperClassName:"w-[200px]"})}),!n&&t==="legislator"&&(h.length>0?e.jsx(X,{className:"flex w-full items-center justify-center",value:a,options:h,onChange:y=>{o(y??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator",styles:ae,components:{DropdownIndicator:se}}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!n&&t==="department"&&(u.length>0?e.jsx(X,{className:"flex w-full items-center justify-center",value:w,options:u,onChange:y=>{g(y??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department",styles:ae,components:{DropdownIndicator:se}}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Be=t=>{var c;return(c=t.children)!=null&&c.length?t.depth===0?26:22:18},Z=.45,oe=({data:t,width:c=928,height:f,onNodeClick:x,mode:p,transformedData:n,padding:l,selectedDepartmentCategorizedData:h,selectedDepartmentTitle:a,showSelectedDepartmentChart:o})=>{const u=i.useMemo(()=>n??de(t,p),[t,p,n]),w=i.useMemo(()=>l??Be,[l]),g=i.useMemo(()=>{if(!h)return null;const b=Object.values(h).flatMap(S=>S.children??[]);if(!b.length)return null;const A=new Map;return b.forEach(S=>{var V;const j=[S.proposerId??S.name??"unknown",S.proposalType??"unknown-type"].join("-"),R=((V=S.name)==null?void 0:V.split(`
`)[0])??S.name??"無名提案者",B=S.value??0,E=B>0?Math.pow(B,1/Z):0,z=xe[S.proposalType]??"",I=A.get(j);if(I){const k=I.totalAmount+E;A.set(j,{totalAmount:k,node:{...I.node,name:`${R}
${z}
${H(k)}`,value:Math.pow(k,Z)}})}else A.set(j,{totalAmount:E,node:{...S,id:`merged-${j}`,name:`${R}
${z}
${H(E)}`,value:Math.pow(E,Z)}})}),Array.from(A.values()).map(S=>S.node)},[h]),y=i.useMemo(()=>!g||!o?null:{id:`selected-department-${a??"selected"}`,name:a??"目前部會",children:g},[g,a,o]),d=Object.keys(u),v=y;return d.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:c},children:"無符合資料"}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-y-8",children:[v&&e.jsxs("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:[e.jsx("p",{className:"text-xl",children:"看全部"}),e.jsx(ee,{data:v,width:c,height:f??c,padding:w,onNodeClick:x})]},"selected-department-highlight"),Object.entries(u).map(([b,A])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:A.children&&A.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:b}),e.jsx(ee,{data:A,width:c,height:f??c,padding:w,onNodeClick:x})]})},b))]})},Ve=({mode:t,onModeChange:c})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:T.Amount,checked:t===T.Amount,onChange:()=>c(T.Amount),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:T.Count,checked:t===T.Count,onChange:()=>c(T.Count),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),Fe=t=>e.jsx(ue.DropdownIndicator,{...t,children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:`flex-none transition-transform ${t.selectProps.menuIsOpen?"rotate-180":""}`,children:e.jsx("div",{className:"relative size-[12px]",children:e.jsx("div",{className:"absolute bottom-1/4 left-[12.79%] right-[12.79%] top-[8.33%]",children:e.jsx("svg",{className:"block size-full",fill:"none",preserveAspectRatio:"none",viewBox:"0 0 8.93119 8",children:e.jsx("path",{d:"M0.5 2.5L4.4656 6.5L8.4312 2.5H0.5Z",fill:"black"})})})})})})}),_e=({departmentOptions:t,selectedDepartmentOption:c,onDepartmentChange:f})=>{const x=me("(min-width: 768px)"),p=i.useMemo(()=>({container:n=>({...n,width:"100%"}),control:n=>({...n,backgroundColor:"#fff",border:"0.5px solid black",borderRadius:"4px",minHeight:"auto",padding:"6px 12px",boxShadow:"none",cursor:"pointer","&:hover":{border:"0.5px solid black"}}),valueContainer:n=>({...n,padding:0,gap:"12px"}),input:n=>({...n,margin:0,padding:0}),singleValue:n=>({...n,color:"black",margin:0,fontFamily:"'Noto Serif Display Medium', sans-serif",fontSize:"15px",fontWeight:500,lineHeight:"normal"}),placeholder:n=>({...n,color:"black",margin:0,fontFamily:"'Noto Serif Display Medium', sans-serif",fontSize:"15px",fontWeight:500,lineHeight:"normal"}),indicatorSeparator:()=>({display:"none"}),indicatorsContainer:n=>({...n,padding:0}),dropdownIndicator:n=>({...n,padding:0}),menu:n=>({...n,marginTop:"4px",border:"0.5px solid black",borderRadius:"4px",boxShadow:"0 4px 6px rgba(0, 0, 0, 0.1)",zIndex:20}),menuList:n=>({...n,padding:0}),option:(n,l)=>({...n,backgroundColor:l.isSelected?"#f3f4f6":l.isFocused?"#f9fafb":"white",color:"black",padding:"12px",cursor:"pointer",fontFamily:"'Noto Serif Display Medium', sans-serif",fontSize:"15px",fontWeight:500,"&:active":{backgroundColor:"#e5e7eb"}})}),[]);return t.length===0?e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"})}):e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx(X,{className:"w-full md:max-w-md",value:c,options:t,onChange:n=>{f(n??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department-desktop",styles:x?p:void 0,components:x?{DropdownIndicator:Fe}:void 0})})},le="資料尚未建置完成或立法院尚在審議中，此處預算視覺化非最終通過狀態",Te=()=>{var n;const{data:t,isLoading:c,isError:f}=Y({queryKey:ze.latest(),queryFn:()=>pe(Ee,{skip:0,take:1}),staleTime:3e5});if(c||f)return null;const x=((n=t==null?void 0:t.budgetYears)==null?void 0:n[0])??null;return(x==null?void 0:x.dataProgress)!=="in-progress"?null:e.jsxs("div",{className:"w-full pt-9",children:[e.jsx("div",{className:"hidden justify-center md:flex",children:e.jsx("div",{className:"bg-budget-accent w-[488px] rounded-[11px] px-5 py-4",children:e.jsx("p",{className:"text-center text-[14px] font-medium text-black",children:le})})}),e.jsx("div",{className:"marquee-container bg-budget-accent max-w-screen py-[6px] md:hidden",children:e.jsx("p",{className:"animate-marquee px-[10px] text-[14px] font-normal text-black",children:le})})]})},Oe=({activeTab:t,onTabChange:c,yearOptions:f,selectedYear:x,onYearChange:p,mode:n,onModeChange:l,isShowingAll:h,onToggleShowAll:a,legislatorOptions:o,selectedLegislatorOption:u,onLegislatorChange:w,departmentOptions:g,selectedDepartmentOption:y,onDepartmentChange:d,isDesktop:v,isLoading:b,legislatorChartContainerRef:A,legislatorChartWidth:S,legislatorChartHeight:j,departmentChartContainerRef:R,departmentChartWidth:B,departmentChartHeight:E,visualizationData:z,legislatorVisualizationData:I,legislatorSummary:V,departmentSummary:k,legislatorPadding:L,selectedDepartmentCategorizedData:D,selectedDepartmentTitle:G,showSelectedDepartmentChart:O,onNodeClick:F})=>{const $=v&&t==="department",W=t==="department"&&z,_=t==="legislator"&&I;return b?e.jsx(De,{isDesktop:v}):e.jsxs("div",{children:[e.jsx(Te,{}),e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Pe,{activeTab:t,onTabChange:c,yearOptions:f,selectedYear:x,onYearChange:p}),e.jsx(Re,{activeTab:t,onTabChange:c,yearOptions:f,selectedYear:x,onYearChange:p,isShowingAll:h,onToggleShowAll:a,legislatorOptions:o,selectedLegislator:u,onLegislatorChange:w,departmentOptions:g,selectedDepartment:y,onDepartmentChange:d}),e.jsx(Ve,{mode:n,onModeChange:l}),e.jsx(ye,{summary:t==="legislator"?V:k}),$&&e.jsx(_e,{departmentOptions:g,selectedDepartmentOption:y,onDepartmentChange:d}),e.jsx(be,{items:je}),_&&e.jsx("div",{ref:A,className:"chart-container",children:e.jsx(oe,{data:z,transformedData:I,padding:L,onNodeClick:F,width:S,height:j,mode:n},"legislator-chart")}),W&&e.jsx("div",{ref:R,className:"chart-container",children:e.jsx(oe,{data:z,onNodeClick:F,width:B,height:E,mode:n,selectedDepartmentCategorizedData:D,selectedDepartmentTitle:G??null,showSelectedDepartmentChart:O},"department-chart")})]})]})},$e=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),qe=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Ge=({isDesktop:t})=>t?e.jsx($e,{}):e.jsx(qe,{}),ie=()=>{const f=Math.round(225),[x,p]=i.useState(f),[n,l]=i.useState(300),h=i.useRef(null);return{ref:i.useCallback(o=>{if(h.current&&h.current.disconnect(),!o)return;const w=requestAnimationFrame(()=>{const g=o.getBoundingClientRect().width;g<=0||(l(g),p(Math.round(g*.75)))});return h.current=new ResizeObserver(g=>{const y=g[0];if(!y)return;const d=y.contentRect.width;l(d),p(Math.round(d*.75))}),h.current.observe(o),()=>{cancelAnimationFrame(w)}},[]),width:n,height:x}},He=()=>{const[t,c]=i.useState(q.Legislator),[f,x]=i.useState(T.Amount),[p,n]=i.useState(ne[0]),[l,h]=i.useState(null),[a,o]=i.useState(null),u=i.useRef(null),w=i.useRef(null),[g,y]=i.useState(!0),[d,v]=i.useState(!0),b=me("(min-width: 768px)"),A=!b,S=i.useCallback(()=>({year:{year:{equals:parseInt(p.value,10)}},mergedParentProposals:null,historicalParentProposals:null,result:{equals:"passed"}}),[p.value]),{data:j,isLoading:R,isError:B}=Y({queryKey:Ie.paginated(S(),parseInt(p.value,10)),queryFn:()=>pe(Me,{where:S()}),placeholderData:Ae}),E=i.useCallback(r=>{if(c(r),!b){if(r==="legislator"){y(!0);return}v(!0)}},[b]);i.useEffect(()=>{b&&(h(null),o(null),y(!0),v(!0))},[b]);const z=i.useCallback(r=>{n(r)},[]),I=i.useCallback(r=>{h(r),y(!1),r&&(u.current=r)},[]),V=i.useCallback(r=>{o(r),v(!1),r&&(w.current=r)},[]),k=i.useMemo(()=>ve(j),[j]),L=i.useMemo(()=>{const r=new Map;return k.forEach(s=>{var C;((C=s.proposers)!=null&&C.length?s.proposers:[]).forEach((N,M)=>{const P=te(N,s.id,M);if(!P)return;const ge=(N==null?void 0:N.name)??"未命名立委";r.has(P)||r.set(P,{value:P,label:ge})})}),Array.from(r.values()).sort((s,m)=>s.label.localeCompare(m.label,"zh-Hant"))},[k]),D=i.useMemo(()=>{const r=new Map;return k.forEach(s=>{var N,M;const m=(M=(N=s.government)==null?void 0:N.category)==null?void 0:M.trim(),C=m&&m.length>0?m:"未分類";r.set(C,{value:C,label:C})}),Array.from(r.values()).sort((s,m)=>s.label.localeCompare(m.label,"zh-Hant"))},[k]),G=i.useCallback(()=>{t==="legislator"?l?(u.current=l,h(null),y(!1)):u.current?(h(u.current),y(!1)):L.length>0&&(h(L[0]),y(!1)):t==="department"&&(a?(w.current=a,o(null),v(!1)):w.current?(o(w.current),v(!1)):D.length>0&&(o(D[0]),v(!1)))},[t,l,a,L,D]),O=i.useCallback(r=>{const s=r==null?void 0:r.trim();return s&&s.length>0?s:"未分類"},[]),F=i.useMemo(()=>{if(b||t!=="legislator"||!l)return null;const r=k.filter(s=>{const m=s.proposers??[];return m.length===0?!1:m.some((C,N)=>te(C,s.id,N)===l.value)}).map(s=>s.id).filter(s=>!!s);return new Set(r)},[t,k,b,l]),$=i.useMemo(()=>{if(t!=="department"||!a)return null;const r=k.filter(s=>{var N,M;const m=(M=(N=s.government)==null?void 0:N.category)==null?void 0:M.trim();return(m&&m.length>0?m:"未分類")===a.value}).map(s=>s.id).filter(s=>!!s);return new Set(r)},[t,k,a]),W=i.useMemo(()=>{var m;if(!j||t!=="department"||!a||!a.value)return null;const r=((m=j.proposals)==null?void 0:m.filter(C=>{var P;if(!C)return!1;const N=Q(re,C);return O(((P=N.government)==null?void 0:P.category)??null)===a.value}))??[];if(!r.length)return null;const s={...j,proposals:r};return de(s,f)},[t,j,f,O,a]);i.useEffect(()=>{A&&(t==="legislator"?l&&L.some(s=>s.value===l.value)||(g&&L.length>0?h(L[0]):l&&h(null)):t==="department"&&(a&&D.some(s=>s.value===a.value)||(d&&D.length>0?o(D[0]):a&&o(null))))},[t,D,A,L,a,l,d,g]),i.useEffect(()=>{if(!b||t!=="department")return;!(a&&D.some(s=>s.value===a.value))&&D.length>0&&(o(D[0]),v(!1))},[t,D,b,a]);const _=i.useMemo(()=>{var m;if(!j)return null;let r=null;if(t==="legislator"&&F?r=F:t==="department"&&$&&(r=$),!r)return j;const s=((m=j.proposals)==null?void 0:m.filter(C=>{if(!C)return!1;const N=Q(re,C),P=Q(Le,N).id;return P!=null&&(r==null?void 0:r.has(P))}))??[];return{...j,proposals:s}},[t,j,$,F]),U=_??j??null,K=i.useMemo(()=>{if(!_)return null;const r=we(_,f);if(!(!b&&t==="legislator"&&l))return r;const m=r[""];if(!(m!=null&&m.children))return r;const C=m.children.filter(N=>N.proposerId===l.value||N.proposerKey===l.value);return{...r,"":{...m,children:C}}},[t,_,b,f,l]);return{activeTab:t,handleTabChange:E,mode:f,setMode:x,selectedYear:p,handleYearChange:z,yearOptions:ne,legislatorOptions:L,selectedLegislatorOption:l,handleLegislatorChange:I,departmentOptions:D,selectedDepartmentOption:a,handleDepartmentChange:V,handleToggleShowAll:G,isShowingAll:t==="legislator"&&!l||t==="department"&&!a,isDesktop:b,isMobile:A,isLoading:R,isError:B,rawData:j,visualizationData:U,legislatorVisualizationData:K,selectedDepartmentCategorizedData:W}},We=({selectedLegislatorOption:t,activeTab:c,isShowingAll:f,year:x})=>{const p=["budget","legislators",x],n=async()=>{const u=await fetch(Ne);if(!u.ok)throw new Error("無法載入立委預算資料");const w=await u.json(),g=Se.safeParse(w);if(!g.success)throw new Error("立委預算資料格式不符合預期");return g.data},{data:l,isLoading:h,isError:a}=Y({queryKey:p,queryFn:n,enabled:c==="legislator"}),o=i.useMemo(()=>{var y;const u=l==null?void 0:l.find(d=>d.yearInfo.year===x),w=u==null?void 0:u.overall,g=d=>{const v=(d==null?void 0:d.reductionAmount)??0,b=(d==null?void 0:d.freezeAmount)??0;return{formattedReductionAmount:H(v),formattedFreezeAmount:H(b),reductionCount:(d==null?void 0:d.reductionCount)??0,freezeCount:(d==null?void 0:d.freezeCount)??0,mainResolutionCount:(d==null?void 0:d.otherCount)??0}};if(c===q.Legislator&&!f&&t&&((y=u==null?void 0:u.legislators)!=null&&y.length)){const d=u.legislators.find(v=>v.peopleId===t.value)??u.legislators.find(v=>v.name===t.label);if(d){const v=d.allInvolved??d.proposerOnly;return g(v)}}return g(w)},[c,f,l,t,x]);return{legislatorBudgetSummaryData:l,legislatorSummary:o,isLegislatorBudgetLoading:h,isLegislatorBudgetError:a}},Ye=({activeTab:t,year:c})=>{const f=async()=>{const a=await fetch(Ce);if(!a.ok)throw new Error("無法載入部會預算資料");const o=await a.json(),u=ke.safeParse(o);if(!u.success)throw new Error("部會預算資料格式不符合預期");return u.data},x=["budget","departments",c],{data:p,isLoading:n,isError:l}=Y({queryKey:x,queryFn:f,enabled:t==="department"}),h=i.useMemo(()=>{const a=p==null?void 0:p.find(g=>g.yearInfo.year===c),o=a==null?void 0:a.overall,u=(o==null?void 0:o.reductionAmount)??0,w=(o==null?void 0:o.freezeAmount)??0;return{formattedReductionAmount:H(u),formattedFreezeAmount:H(w),reductionCount:(o==null?void 0:o.reductionCount)??0,freezeCount:(o==null?void 0:o.freezeCount)??0,mainResolutionCount:(o==null?void 0:o.otherCount)??0}},[p,c]);return{departmentBudgetSummaryData:p,departmentSummary:h,isDepartmentBudgetLoading:n,isDepartmentBudgetError:l}},Ue=({children:t})=>{const{ref:c,width:f,height:x}=ie(),{ref:p,width:n,height:l}=ie(),h=he(),{activeTab:a,handleTabChange:o,mode:u,setMode:w,selectedYear:g,handleYearChange:y,yearOptions:d,legislatorOptions:v,selectedLegislatorOption:b,handleLegislatorChange:A,departmentOptions:S,selectedDepartmentOption:j,handleDepartmentChange:R,handleToggleShowAll:B,isShowingAll:E,isDesktop:z,isLoading:I,isError:V,visualizationData:k,legislatorVisualizationData:L,selectedDepartmentCategorizedData:D}=He(),G=Number.parseInt(g.value,10),O=Number.isNaN(G)?0:G,{legislatorSummary:F,isLegislatorBudgetLoading:$,isLegislatorBudgetError:W}=We({selectedLegislatorOption:b,activeTab:a,isShowingAll:E,year:O}),{departmentSummary:_,isDepartmentBudgetLoading:U,isDepartmentBudgetError:K}=Ye({activeTab:a,year:O}),J=i.useMemo(()=>{if(u==="amount")return s=>{var m;return(m=s.children)!=null&&m.length?s.depth===0?20:s.depth===1?36:18:10}},[u]),r=i.useCallback(s=>{var m;if(s.proposalId)return h(`/budget/${s.proposalId}`),!0;if(s.proposerId&&!((m=s.children)!=null&&m.length)){const C=g.value,N=new URLSearchParams({year:C}).toString();return h(`/visualization/legislator/${s.proposerId}?${N}`),!0}return!1},[h,g.value]);return I||$||U?e.jsx(Ge,{isDesktop:z}):V||W||K?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):k?t({activeTab:a,onTabChange:o,yearOptions:d,selectedYear:g,onYearChange:y,mode:u,onModeChange:w,isShowingAll:E,onToggleShowAll:B,legislatorOptions:v,selectedLegislatorOption:b,onLegislatorChange:A,departmentOptions:S,selectedDepartmentOption:j,onDepartmentChange:R,isDesktop:z,isLoading:I,legislatorChartContainerRef:c,legislatorChartWidth:f,legislatorChartHeight:x,departmentChartContainerRef:p,departmentChartWidth:n,departmentChartHeight:l,visualizationData:k,legislatorVisualizationData:L,legislatorSummary:F,departmentSummary:_,legislatorPadding:J,selectedDepartmentCategorizedData:D,selectedDepartmentTitle:(j==null?void 0:j.label)??null,showSelectedDepartmentChart:!!D,onNodeClick:r}):null},Ke=()=>e.jsx(Ue,{children:t=>e.jsx(Oe,{...t})}),lt=fe(Ke);export{lt as default};

import{a,p as e,H as he,y as ge}from"./chunk-WWGJGFF6-C1k8rglg.js";import{t as ue,G as fe,f as G,C as ne,S as pe,B as xe,a as ye,m as je,g as se,u as Z,b as be,c as ve,d as Ce,o as K,n as M,s as ee,e as ce,h as we}from"./budget-by-legislator.schema-B6Vlf9E5.js";import{B as Se}from"./budget-detail-skeleton-CmpMzIYN.js";import{S as H}from"./react-select.esm-DmUF9zZp.js";import{u as te,V as ae,q as Ne,l as Ae,j as De}from"./gql-B77SbNtU.js";import{Y as le}from"./floating-ui.dom-CSgo-9lt.js";import"./helpers-DM_2piGp.js";import{b as Le}from"./index-DrVPcFH7.js";import{p as ze,f as Ee}from"./visualization.queries-Dq0fz9O0.js";import"./index-CeHjcr3Z.js";import"./index-SkmILjJ3.js";import"./hoist-non-react-statics.cjs-1LUWegar.js";const ke=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],re=a.forwardRef((t,o)=>e.jsx("div",{className:"w-60",children:e.jsx(H,{ref:o,options:ke,...t})}));re.displayName="VisualizationSelector";var U=(t=>(t.Legislator="legislator",t.Department="department",t))(U||{}),de=(t=>(t.Amount="amount",t.Count="count",t))(de||{});const Me=({activeTab:t,onTabChange:o,yearOptions:d,selectedYear:m,onYearChange:c})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>o(U.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>o(U.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(re,{options:d,value:m,onChange:f=>{f&&c(f)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),Be=({activeTab:t,onTabChange:o,yearOptions:d,selectedYear:m,onYearChange:c,isShowingAll:f,onToggleShowAll:i,legislatorOptions:s,selectedLegislator:r,onLegislatorChange:h,departmentOptions:y,selectedDepartment:C,onDepartmentChange:j})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:i,className:`rounded px-2.5 transition-colors ${f?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>o(U.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>o(U.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(re,{options:d,value:m,onChange:p=>{p&&c(p)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!f&&t==="legislator"&&(s.length>0?e.jsx(H,{className:"w-full",value:r,options:s,onChange:p=>{h(p??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!f&&t==="department"&&(y.length>0?e.jsx(H,{className:"w-full",value:C,options:y,onChange:p=>{j(p??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Ie=t=>{var o;return(o=t.children)!=null&&o.length?t.depth===0?26:22:18},J=.45,oe=({data:t,width:o=928,height:d,onNodeClick:m,mode:c,transformedData:f,padding:i,selectedDepartmentCategorizedData:s,selectedDepartmentTitle:r,showSelectedDepartmentChart:h})=>{const y=a.useMemo(()=>f??ue(t,c),[t,c,f]),C=a.useMemo(()=>i??Ie,[i]),j=a.useMemo(()=>{if(!s)return null;const x=Object.values(s).flatMap(b=>b.children??[]);if(!x.length)return null;const A=new Map;return x.forEach(b=>{var _;const g=[b.proposerId??b.name??"unknown",b.proposalType??"unknown-type"].join("-"),V=((_=b.name)==null?void 0:_.split(`
`)[0])??b.name??"無名提案者",F=b.value??0,B=F>0?Math.pow(F,1/J):0,E=fe[b.proposalType]??"",k=A.get(g);if(k){const w=k.totalAmount+B;A.set(g,{totalAmount:w,node:{...k.node,name:`${V}
${E}
${G(w)}`,value:Math.pow(w,J)}})}else A.set(g,{totalAmount:B,node:{...b,id:`merged-${g}`,name:`${V}
${E}
${G(B)}`,value:Math.pow(B,J)}})}),Array.from(A.values()).map(b=>b.node)},[s]),p=a.useMemo(()=>!j||!h?null:{id:`selected-department-${r??"selected"}`,name:r??"目前部會",children:j},[j,r,h]),L=Object.keys(y),D=p;return L.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:o},children:"無符合資料"}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-y-8",children:[D&&e.jsxs("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:[e.jsx("p",{className:"text-xl",children:"看全部"}),e.jsx(ne,{data:D,width:o,height:d??o,padding:C,onNodeClick:m})]},"selected-department-highlight"),Object.entries(y).map(([x,A])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:A.children&&A.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:x}),e.jsx(ne,{data:A,width:o,height:d??o,padding:C,onNodeClick:m})]})},x))]})},Re=({mode:t,onModeChange:o})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:t==="amount",onChange:()=>o("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:t==="count",onChange:()=>o("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),Pe=({departmentOptions:t,selectedDepartmentOption:o,onDepartmentChange:d})=>t.length===0?e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"})}):e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx(H,{className:"w-full md:max-w-xl",value:o,options:t,onChange:m=>{d(m??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department-desktop"})}),Ve=({activeTab:t,onTabChange:o,yearOptions:d,selectedYear:m,onYearChange:c,mode:f,onModeChange:i,isShowingAll:s,onToggleShowAll:r,legislatorOptions:h,selectedLegislatorOption:y,onLegislatorChange:C,departmentOptions:j,selectedDepartmentOption:p,onDepartmentChange:L,isDesktop:D,isLoading:x,legislatorChartContainerRef:A,legislatorChartWidth:b,legislatorChartHeight:g,departmentChartContainerRef:V,departmentChartWidth:F,departmentChartHeight:B,visualizationData:E,legislatorVisualizationData:k,legislatorSummary:_,departmentSummary:w,legislatorPadding:z,selectedDepartmentCategorizedData:S,selectedDepartmentTitle:W,showSelectedDepartmentChart:q,onNodeClick:$})=>{const O=D&&t==="department",Y=t==="department"&&E,T=t==="legislator"&&k;return x?e.jsx(Se,{isDesktop:D}):e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Me,{activeTab:t,onTabChange:o,yearOptions:d,selectedYear:m,onYearChange:c}),e.jsx(Be,{activeTab:t,onTabChange:o,yearOptions:d,selectedYear:m,onYearChange:c,isShowingAll:s,onToggleShowAll:r,legislatorOptions:h,selectedLegislator:y,onLegislatorChange:C,departmentOptions:j,selectedDepartment:p,onDepartmentChange:L}),e.jsx(Re,{mode:f,onModeChange:i}),e.jsx(pe,{summary:t==="legislator"?_:w}),O&&e.jsx(Pe,{departmentOptions:j,selectedDepartmentOption:p,onDepartmentChange:L}),e.jsx(xe,{items:ye}),T&&e.jsx("div",{ref:A,className:"chart-container",children:e.jsx(oe,{data:E,transformedData:k,padding:z,onNodeClick:$,width:b,height:g,mode:f},"legislator-chart")}),Y&&e.jsx("div",{ref:V,className:"chart-container",children:e.jsx(oe,{data:E,onNodeClick:$,width:F,height:B,mode:f,selectedDepartmentCategorizedData:S,selectedDepartmentTitle:W??null,showSelectedDepartmentChart:q},"department-chart")})]})})},Fe=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),_e=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),$e=({isDesktop:t})=>t?e.jsx(Fe,{}):e.jsx(_e,{}),ie=()=>{const d=Math.round(225),[m,c]=a.useState(d),[f,i]=a.useState(300),s=a.useRef(null);return{ref:a.useCallback(h=>{if(s.current&&s.current.disconnect(),!h)return;const C=requestAnimationFrame(()=>{const j=h.getBoundingClientRect().width;j<=0||(i(j),c(Math.round(j*.75)))});return s.current=new ResizeObserver(j=>{const p=j[0];if(!p)return;const L=p.contentRect.width;i(L),c(Math.round(L*.75))}),s.current.observe(h),()=>{cancelAnimationFrame(C)}},[]),width:f,height:m}},Te=()=>{const[t,o]=a.useState(U.Legislator),[d,m]=a.useState(de.Amount),[c,f]=a.useState(le[0]),[i,s]=a.useState(null),[r,h]=a.useState(null),y=a.useRef(null),C=a.useRef(null),[j,p]=a.useState(!0),[L,D]=a.useState(!0),x=Le("(min-width: 768px)"),A=!x,b=a.useCallback(()=>({year:{year:{equals:parseInt(c.value,10)}},mergedParentProposals:null,historicalParentProposals:null,result:{equals:"passed"}}),[c.value]),{data:g,isLoading:V,isError:F}=te({queryKey:ze.paginated(b(),parseInt(c.value,10)),queryFn:()=>De(Ee,{where:b()}),placeholderData:Ae}),B=a.useCallback(n=>{if(o(n),!x){if(n==="legislator"){p(!0);return}D(!0)}},[x]);a.useEffect(()=>{x&&(s(null),h(null),p(!0),D(!0))},[x]);const E=a.useCallback(n=>{f(n)},[]),k=a.useCallback(n=>{s(n),p(!1),n&&(y.current=n)},[]),_=a.useCallback(n=>{h(n),D(!1),n&&(C.current=n)},[]),w=a.useMemo(()=>je(g),[g]),z=a.useMemo(()=>{const n=new Map;return w.forEach(l=>{var N;((N=l.proposers)!=null&&N.length?l.proposers:[]).forEach((v,R)=>{const P=se(v,l.id,R);if(!P)return;const me=(v==null?void 0:v.name)??"未命名立委";n.has(P)||n.set(P,{value:P,label:me})})}),Array.from(n.values()).sort((l,u)=>l.label.localeCompare(u.label,"zh-Hant"))},[w]),S=a.useMemo(()=>{const n=new Map;return w.forEach(l=>{var v,R;const u=(R=(v=l.government)==null?void 0:v.category)==null?void 0:R.trim(),N=u&&u.length>0?u:"未分類";n.set(N,{value:N,label:N})}),Array.from(n.values()).sort((l,u)=>l.label.localeCompare(u.label,"zh-Hant"))},[w]),W=a.useCallback(()=>{t==="legislator"?i?(y.current=i,s(null),p(!1)):y.current?(s(y.current),p(!1)):z.length>0&&(s(z[0]),p(!1)):t==="department"&&(r?(C.current=r,h(null),D(!1)):C.current?(h(C.current),D(!1)):S.length>0&&(h(S[0]),D(!1)))},[t,i,r,z,S]),q=a.useCallback(n=>{const l=n==null?void 0:n.trim();return l&&l.length>0?l:"未分類"},[]),$=a.useMemo(()=>{if(x||t!=="legislator"||!i)return null;const n=w.filter(l=>{const u=l.proposers??[];return u.length===0?!1:u.some((N,v)=>se(N,l.id,v)===i.value)}).map(l=>l.id).filter(l=>!!l);return new Set(n)},[t,w,x,i]),O=a.useMemo(()=>{if(t!=="department"||!r)return null;const n=w.filter(l=>{var v,R;const u=(R=(v=l.government)==null?void 0:v.category)==null?void 0:R.trim();return(u&&u.length>0?u:"未分類")===r.value}).map(l=>l.id).filter(l=>!!l);return new Set(n)},[t,w,r]),Y=a.useMemo(()=>{var u;if(!g||t!=="department"||!r||!r.value)return null;const n=((u=g.proposals)==null?void 0:u.filter(N=>{var P;if(!N)return!1;const v=Z(ae,N);return q(((P=v.government)==null?void 0:P.category)??null)===r.value}))??[];if(!n.length)return null;const l={...g,proposals:n};return ue(l,d)},[t,g,d,q,r]);a.useEffect(()=>{A&&(t==="legislator"?i&&z.some(l=>l.value===i.value)||(j&&z.length>0?s(z[0]):i&&s(null)):t==="department"&&(r&&S.some(l=>l.value===r.value)||(L&&S.length>0?h(S[0]):r&&h(null))))},[t,S,A,z,r,i,L,j]),a.useEffect(()=>{if(!x||t!=="department")return;!(r&&S.some(l=>l.value===r.value))&&S.length>0&&(h(S[0]),D(!1))},[t,S,x,r]);const T=a.useMemo(()=>{var u;if(!g)return null;let n=null;if(t==="legislator"&&$?n=$:t==="department"&&O&&(n=O),!n)return g;const l=((u=g.proposals)==null?void 0:u.filter(N=>{if(!N)return!1;const v=Z(ae,N),P=Z(Ne,v).id;return P!=null&&(n==null?void 0:n.has(P))}))??[];return{...g,proposals:l}},[t,g,O,$]),Q=T??g??null,X=a.useMemo(()=>{if(!T)return null;const n=be(T,d);if(!(!x&&t==="legislator"&&i))return n;const u=n[""];if(!(u!=null&&u.children))return n;const N=u.children.filter(v=>v.proposerId===i.value||v.proposerKey===i.value);return{...n,"":{...u,children:N}}},[t,T,x,d,i]);return{activeTab:t,handleTabChange:B,mode:d,setMode:m,selectedYear:c,handleYearChange:E,yearOptions:le,legislatorOptions:z,selectedLegislatorOption:i,handleLegislatorChange:k,departmentOptions:S,selectedDepartmentOption:r,handleDepartmentChange:_,handleToggleShowAll:W,isShowingAll:t==="legislator"&&!i||t==="department"&&!r,isDesktop:x,isMobile:A,isLoading:V,isError:F,rawData:g,visualizationData:Q,legislatorVisualizationData:X,selectedDepartmentCategorizedData:Y}},Oe=({selectedLegislatorOption:t,activeTab:o})=>{const d=["budget","legislators",(t==null?void 0:t.value)??"all"],m=async()=>{const r=await fetch(ve);if(!r.ok)throw new Error("無法載入立委預算資料");return Ce.parse(await r.json())},{data:c,isLoading:f,isError:i}=te({queryKey:d,queryFn:m,enabled:o==="legislator"}),s=a.useMemo(()=>{var C;const r=(C=c==null?void 0:c[0])==null?void 0:C.overall,h=(r==null?void 0:r.reductionAmount)??0,y=(r==null?void 0:r.freezeAmount)??0;return{formattedReductionAmount:G(h),formattedFreezeAmount:G(y),reductionCount:(r==null?void 0:r.reductionCount)??0,freezeCount:(r==null?void 0:r.freezeCount)??0,mainResolutionCount:(r==null?void 0:r.otherCount)??0}},[c]);return{legislatorBudgetSummaryData:c,legislatorSummary:s,isLegislatorBudgetLoading:f,isLegislatorBudgetError:i}},qe=K({budgetYearId:ee(),year:M()}),Ge=K({reductionAmount:M(),reductionCount:M(),freezeAmount:M(),freezeCount:M(),otherCount:M()}),Ue=K({governmentId:ee(),name:ee(),reductionAmount:M(),reductionCount:M(),freezeAmount:M(),freezeCount:M(),otherCount:M()}),We=K({yearInfo:qe,overall:Ge,departments:ce(Ue)}),Ye=ce(We),He=({activeTab:t})=>{const o=async()=>{const s=await fetch(we);if(!s.ok)throw new Error("無法載入部會預算資料");return Ye.parse(await s.json())},d=["budget","departments"],{data:m,isLoading:c,isError:f}=te({queryKey:d,queryFn:o,enabled:t==="department"}),i=a.useMemo(()=>{var y;const s=(y=m==null?void 0:m[0])==null?void 0:y.overall,r=(s==null?void 0:s.reductionAmount)??0,h=(s==null?void 0:s.freezeAmount)??0;return{formattedReductionAmount:G(r),formattedFreezeAmount:G(h),reductionCount:(s==null?void 0:s.reductionCount)??0,freezeCount:(s==null?void 0:s.freezeCount)??0,mainResolutionCount:(s==null?void 0:s.otherCount)??0}},[m]);return{departmentBudgetSummaryData:m,departmentSummary:i,isDepartmentBudgetLoading:c,isDepartmentBudgetError:f}},Ke=({children:t})=>{const{ref:o,width:d,height:m}=ie(),{ref:c,width:f,height:i}=ie(),s=he(),{activeTab:r,handleTabChange:h,mode:y,setMode:C,selectedYear:j,handleYearChange:p,yearOptions:L,legislatorOptions:D,selectedLegislatorOption:x,handleLegislatorChange:A,departmentOptions:b,selectedDepartmentOption:g,handleDepartmentChange:V,handleToggleShowAll:F,isShowingAll:B,isDesktop:E,isLoading:k,isError:_,visualizationData:w,legislatorVisualizationData:z,selectedDepartmentCategorizedData:S}=Te(),{legislatorSummary:W,isLegislatorBudgetLoading:q,isLegislatorBudgetError:$}=Oe({selectedLegislatorOption:x,activeTab:r}),{departmentSummary:O,isDepartmentBudgetLoading:Y,isDepartmentBudgetError:T}=He({activeTab:r}),Q=a.useMemo(()=>{if(y==="amount")return I=>{var n;return(n=I.children)!=null&&n.length?I.depth===0?20:I.depth===1?36:18:10}},[y]),X=a.useCallback(I=>{var n;if(I.proposalId)return s(`/budget/${I.proposalId}`),!0;if(I.proposerId&&!((n=I.children)!=null&&n.length)){const l=j.value,u=new URLSearchParams({year:l}).toString();return s(`/visualization/legislator/${I.proposerId}?${u}`),!0}return!1},[s,j.value]);return k||q||Y?e.jsx($e,{isDesktop:E}):_||$||T?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):w?t({activeTab:r,onTabChange:h,yearOptions:L,selectedYear:j,onYearChange:p,mode:y,onModeChange:C,isShowingAll:B,onToggleShowAll:F,legislatorOptions:D,selectedLegislatorOption:x,onLegislatorChange:A,departmentOptions:b,selectedDepartmentOption:g,onDepartmentChange:V,isDesktop:E,isLoading:k,legislatorChartContainerRef:o,legislatorChartWidth:d,legislatorChartHeight:m,departmentChartContainerRef:c,departmentChartWidth:f,departmentChartHeight:i,visualizationData:w,legislatorVisualizationData:z,legislatorSummary:W,departmentSummary:O,legislatorPadding:Q,selectedDepartmentCategorizedData:S,selectedDepartmentTitle:(g==null?void 0:g.label)??null,showSelectedDepartmentChart:!!S,onNodeClick:X}):null},Qe=()=>e.jsx(Ke,{children:t=>e.jsx(Ve,{...t})}),ut=ge(Qe);export{ut as default};

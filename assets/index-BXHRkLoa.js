import{p as e,y as U,J as K,D as V,a as c,H as Q,L as W}from"./chunk-WWGJGFF6-C1k8rglg.js";import{t as H,u as T,P as X,j as O,O as J}from"./gql-wXtZbEb8.js";import{Y as Z,l as b}from"./floating-ui.dom-CSgo-9lt.js";import{b as y}from"./index-DrVPcFH7.js";import{C as ee,i as re,m as se,f as S,S as ae,B as te,a as ne,P as oe,c as le,d as de}from"./budget-by-legislator.schema-BN3-NfvX.js";import{p as ie,f as ce}from"./visualization.queries-DxAHAK8q.js";import"./index-CeHjcr3Z.js";import"./index-SkmILjJ3.js";import"./helpers-CnuBAGxO.js";const me=(r,s)=>s>1&&r<s-1?"border-b border-gray-200":"",ue=({data:r,presenterDescription:s="",yearToCommitteeMap:a,onNodeClick:t})=>{const m=y("(min-width: 768px)"),i=y("(min-width: 1024px)"),h=y("(min-width: 1440px)"),g=y("(min-width: 1920px)"),C=()=>g?1800:h?1400:i?1e3:720;if(!r||r.length===0)return e.jsx("div",{className:"flex w-full items-center justify-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"目前無提案資料"})});const j=C(),P={maxWidth:`${j}px`};return e.jsx(e.Fragment,{children:r.map((u,A)=>{const x=a.get(u.name),n=x!=null&&x.termNumber?`第${x.termNumber}屆`:u.name,f=(x==null?void 0:x.committeeName)??"委員會";return e.jsxs("div",{className:`mb-2 flex w-full flex-col items-start justify-center ${me(A,r.length)} mx-auto`,style:P,children:[e.jsxs("div",{className:"flex w-full flex-col items-start justify-center",children:[e.jsx("p",{children:n}),e.jsx("p",{children:f}),s?e.jsx("div",{className:"flex w-full flex-col items-start justify-center mb-5 lg:mb-8",children:e.jsx("p",{className:"text-sm leading-relaxed text-black/80",children:s})}):null]}),e.jsx("div",{className:"w-full md:mx-auto",children:e.jsx(ee,{data:{id:u.id,name:"root",children:u.children},width:j,padding:50,onNodeClick:t})})]},u.id)})})},xe=H(`
  query People($where: PeopleWhereUniqueInput!) {
    people(where: $where) {
      id
      name
      description
      party {
        id
        color
        name
      }
      term {
        termNumber
        id
      }
      termCount
      committees {
        id
        name
        session
        term {
          id
          startDate
          termNumber
        }
      }
    }
  }
`),E={all:["people"],details:()=>[...E.all,"detail"],detail:r=>[...E.details(),r]},pe=()=>e.jsx("div",{className:"animate-pulse",children:e.jsxs("div",{className:"md:max-w-visualization-body flex flex-col items-center gap-y-6 px-3 md:mx-auto",children:[e.jsx("div",{className:"h-4 w-24 self-start rounded bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-6 w-32 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-40 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex gap-x-4",children:[e.jsx("div",{className:"h-9 w-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-9 w-24 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"h-5 w-44 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-56 rounded bg-gray-200"})]}),e.jsx("div",{className:"w-full rounded-lg border-2 border-dashed border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-52 rounded bg-gray-200"})]})}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"flex w-full flex-col gap-y-6",children:[0,1].map(r=>e.jsxs("div",{className:"flex flex-col gap-y-3 rounded-lg border border-dashed border-gray-200 p-4",children:[e.jsx("div",{className:"h-5 w-32 rounded bg-gray-200"}),e.jsx("div",{className:"h-72 w-full rounded bg-gray-200"})]},r))})]})}),he=()=>e.jsx("div",{className:"animate-pulse px-3",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-5",children:[e.jsx("div",{className:"h-4 w-20 self-start rounded bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-5 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-36 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex w-full flex-col gap-y-3",children:[e.jsx("div",{className:"h-9 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-9 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-y-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-44 rounded bg-gray-200"})]}),e.jsx("div",{className:"w-full rounded-lg border-2 border-dashed border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-4 w-36 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-32 rounded bg-gray-200"})]})}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"flex w-full flex-col gap-y-5",children:[0,1].map(r=>e.jsxs("div",{className:"flex flex-col gap-y-2 rounded-lg border border-dashed border-gray-200 p-4",children:[e.jsx("div",{className:"h-4 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-64 w-full rounded bg-gray-200"})]},r))})]})}),ge=({isDesktop:r})=>r?e.jsx(pe,{}):e.jsx(he,{}),fe=(r,s,a)=>{const t={mergedParentProposals:null,historicalParentProposals:null,result:{in:[...oe]},year:{year:{equals:a}}};return r==="proposal-cosign"?{...t,OR:[{proposers:{some:{id:{equals:s}}}},{coSigners:{some:{id:{equals:s}}}}]}:{...t,proposers:{some:{id:{equals:s}}}}},Ne=/(\d+)\s*年度/,be=/第(\d+)屆/,ye=r=>{var a,t;if((a=r.term)!=null&&a.startDate)return`${new Date(r.term.startDate).getFullYear()-1911+1}年度`;const s=(t=r.session)==null?void 0:t.match(Ne);if(s!=null&&s[1])return`${s[1]}年度`},je=r=>{var a,t;if(typeof((a=r.term)==null?void 0:a.termNumber)=="number")return r.term.termNumber;const s=(t=r.session)==null?void 0:t.match(be);if(s!=null&&s[1]){const l=Number(s[1]);return Number.isNaN(l)?void 0:l}},ve=r=>{if(!r)return new Map;const s=new Map;return r.forEach(a=>{const t=ye(a);t&&s.set(t,{committeeName:a.name??"委員會",termNumber:je(a)})}),s},F=r=>r?r.map(s=>s==null?void 0:s.termNumber).filter(s=>s!=null):[],we=(r,s)=>{const a=F(s);if(a.length>0)return[...new Set(a)].sort((l,m)=>l-m);const t=F((r==null?void 0:r.map(l=>l.term))??[]);return[...new Set(t)].sort((l,m)=>l-m)},Se=r=>{const s=b.sumBy(r,i=>i.reductionAmount||0),a=b.sumBy(r,i=>i.freezeAmount||0),t=b.filter(r,i=>i.reductionAmount).length,l=b.filter(r,i=>i.freezeAmount).length,m=b.filter(r,i=>{var h;return(h=i.proposalTypes)==null?void 0:h.includes(X.Other)}).length;return{formattedReductionAmount:S(s),formattedFreezeAmount:S(a),reductionProposalsCount:t,freezeProposalsCount:l,mainResolutionCount:m}},Ce=({personName:r,partyName:s,termNumbers:a})=>{const t=a.length?`第${a.join("、")}屆`:"";return e.jsxs("div",{className:"mt-4 flex min-w-[254px] flex-col items-center justify-center gap-y-2 border-b-2 border-black pb-3 lg:flex-row lg:items-end lg:gap-x-5",children:[e.jsx("p",{className:"text-[36px] md:text-[32px]",children:r}),e.jsx("p",{children:s}),t?e.jsxs("p",{className:"flex flex-wrap justify-center gap-x-2",children:[e.jsx("span",{className:"whitespace-nowrap",children:t}),e.jsx("span",{children:"立法委員"})]}):e.jsx("p",{children:"立法委員"})]})},Pe=({selectedType:r,onChange:s})=>e.jsxs("div",{className:"mt-6 flex items-center gap-x-4",children:[e.jsx("button",{className:`rounded border-2 border-black px-2.5 ${r==="proposal"?"bg-brand-primary text-white":""}`,onClick:()=>s("proposal"),children:"提案"}),e.jsx("button",{className:`rounded border-2 border-black px-2.5 ${r==="proposal-cosign"?"bg-brand-primary text-white":""}`,onClick:()=>s("proposal-cosign"),children:"提案＋連署"})]}),Ae=({mode:r,onChange:s})=>e.jsx("div",{children:e.jsxs("div",{className:"mt-4 flex flex-col items-center justify-center gap-4 lg:flex-row lg:gap-6 lg:text-left",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:r==="amount",onChange:()=>s("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:r==="count",onChange:()=>s("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),Re=()=>{var z;const{id:r}=K(),[s]=V(),[a,t]=c.useState("proposal"),[l,m]=c.useState("amount"),i=c.useMemo(()=>{var w;const d=s.get("year"),o=d?parseInt(d,10):NaN;if(!Number.isNaN(o))return o;const p=(w=Z[0])==null?void 0:w.value,v=p?parseInt(p,10):0;return Number.isNaN(v)?0:v},[s]),h=c.useMemo(()=>fe(a,r,i),[a,r,i]),{data:g,isLoading:C,isError:j}=T({queryKey:ie.list({whereFilter:h}),queryFn:()=>O(ce,{skip:0,orderBy:[{id:J.Desc}],where:h})}),P=c.useMemo(()=>g?re(g,l):[],[g,l]),{data:u,isLoading:A,isError:x}=T({queryKey:E.detail(r??""),queryFn:()=>O(xe,{where:{id:r}}),enabled:!!r}),n=u==null?void 0:u.people,f=n==null?void 0:n.committees,B=c.useMemo(()=>ve(f),[f]),M=c.useMemo(()=>we(f,n==null?void 0:n.term),[f,n==null?void 0:n.term]),_=se(g),N=c.useMemo(()=>Se(_),[_]),{data:R}=T({queryKey:["budget","legislators",r??"all"],queryFn:async()=>{const d=await fetch(le);if(!d.ok)throw new Error("無法載入立委預算資料");return de.parse(await d.json())},enabled:!!r}),L=c.useMemo(()=>{var D,I;if(!R)return;const d=R[0];if(!d)return;const o=((D=d.legislators)==null?void 0:D.find($=>$.peopleId===r))??((I=d.legislators)==null?void 0:I[0]),p=a==="proposal-cosign"?(o==null?void 0:o.allInvolved)??(o==null?void 0:o.proposerOnly)??d.overall:(o==null?void 0:o.proposerOnly)??(o==null?void 0:o.allInvolved)??d.overall;if(!p)return;const v=p.reductionAmount??0,w=p.freezeAmount??0;return{formattedReductionAmount:S(v),formattedFreezeAmount:S(w),reductionCount:p.reductionCount??0,freezeCount:p.freezeCount??0,mainResolutionCount:p.otherCount??0}},[R,r,a]),Y=c.useMemo(()=>L??{formattedReductionAmount:N.formattedReductionAmount,formattedFreezeAmount:N.formattedFreezeAmount,reductionCount:N.reductionProposalsCount,freezeCount:N.freezeProposalsCount,mainResolutionCount:N.mainResolutionCount},[L,N]),q=y("(min-width: 768px)"),k=Q(),G=c.useCallback(d=>{var o;return!((o=d.children)!=null&&o.length)&&d.id?(k(`/budget/${d.id}`),!0):!1},[k]);return C||A?e.jsx(ge,{isDesktop:q}):j||x?e.jsx("div",{children:"Error fetching data"}):e.jsx("div",{children:e.jsxs("div",{className:"md:max-w-visualization-body flex flex-col items-center justify-center px-3 md:mx-auto",children:[e.jsxs(W,{to:"/visualization",children:["<"," 回到視覺化主頁"]}),e.jsx(Ce,{personName:n==null?void 0:n.name,partyName:(z=n==null?void 0:n.party)==null?void 0:z.name,termNumbers:M}),e.jsx(Pe,{selectedType:a,onChange:t}),e.jsx(Ae,{mode:l,onChange:m}),e.jsx(ae,{summary:Y}),e.jsx("div",{className:"mt-6",children:e.jsx(te,{items:ne})}),e.jsx(ue,{data:P,presenterDescription:n==null?void 0:n.description,yearToCommitteeMap:B,onNodeClick:G})]})})},Fe=U(Re);export{Fe as default};

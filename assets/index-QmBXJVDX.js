import{a as n,p as e,y as de,G as me}from"./chunk-4WY6JWTD-2Cr-QbDP.js";import{a as J,s as ge}from"./options-COhGXY56.js";import{t as he,C as fe,m as ae,u as ne,f as B,a as pe,o as G,n as S,s as X,b as le,S as xe,B as ye,c as be,d as je,e as ve,g as Ce}from"./budget-by-legislator.schema-C3Lu4TwO.js";import{O as Z,u as ee,P as Ne,V as we,q as Se,l as Ae,j as ze}from"./gql-Mx7Ziu-8.js";import{l as L}from"./lodash-lK2eycnc.js";import{b as De}from"./index-Ck08PhAW.js";import{p as ke,e as Pe}from"./visualization.queries-BUVrj-cD.js";import{B as Me}from"./budget-detail-skeleton-DMxLzU0j.js";import"./hoist-non-react-statics.cjs-BZ9oskQ4.js";import"./index-CtMSh7YR.js";import"./helpers-DCGy3gpM.js";import"./index-CSMLMQiO.js";const Re=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],te=n.forwardRef((a,c)=>e.jsx("div",{className:"w-60",children:e.jsx(J,{ref:c,options:Re,...a})}));te.displayName="VisualizationSelector";const Ee=({activeTab:a,onTabChange:c,yearOptions:x,selectedYear:y,onYearChange:i})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>c("legislator"),className:`rounded px-2.5 transition-colors ${a==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>c("department"),className:`rounded px-2.5 transition-colors ${a==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(te,{options:x,value:y,onChange:f=>{f&&i(f)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),Ie=({activeTab:a,onTabChange:c,yearOptions:x,selectedYear:y,onYearChange:i,isShowingAll:f,onToggleShowAll:l,legislatorOptions:g,selectedLegislator:u,onLegislatorChange:m,departmentOptions:h,selectedDepartment:p,onDepartmentChange:D})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:l,className:`rounded px-2.5 transition-colors ${f?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>c("legislator"),className:`rounded px-2.5 transition-colors ${a==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>c("department"),className:`rounded px-2.5 transition-colors ${a==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(te,{options:x,value:y,onChange:b=>{b&&i(b)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!f&&a==="legislator"&&(g.length>0?e.jsx(J,{className:"w-full",value:u,options:g,onChange:b=>{m(b??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!f&&a==="department"&&(h.length>0?e.jsx(J,{className:"w-full",value:p,options:h,onChange:b=>{D(b??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Oe=a=>{var c;return(c=a.children)!=null&&c.length?a.depth===0?26:22:18},re=({data:a,width:c=928,height:x,onNodeClick:y,mode:i,transformedData:f,padding:l})=>{const g=n.useMemo(()=>f??he(a,i),[a,i,f]),u=n.useMemo(()=>l??Oe,[l]);return Object.keys(g).length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:c},children:"無符合資料"}):e.jsx("div",{className:"flex flex-col items-center justify-center gap-y-8",children:Object.entries(g).map(([h,p])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:p.children&&p.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:h}),e.jsx(fe,{data:p,width:c,height:x??c,padding:u,onNodeClick:y})]})},h))})},oe=[{value:"114",label:"114年度 (2025)"},{value:"113",label:"113年度 (2024)"}],Le=()=>{const[a,c]=n.useState("legislator"),[x,y]=n.useState("amount"),[i,f]=n.useState(oe[0]),[l,g]=n.useState(null),[u,m]=n.useState(null),h=n.useRef(null),p=n.useRef(null),[D,b]=n.useState(!0),[E,P]=n.useState(!0),j=De("(min-width: 768px)"),T=!j,V="id-asc",Y=1,F=1e3,q=n.useCallback(()=>({year:{year:{equals:parseInt(i.value,10)}},mergedParentProposals:null,historicalParentProposals:null}),[i.value]),_=n.useMemo(()=>{const s=L.find(ge,r=>r.value===V);if(!s)return[{id:Z.Desc}];const o=s.direction==="asc"?Z.Asc:Z.Desc;return[{[s.field]:o}]},[V]),{data:C,isLoading:U,isError:$}=ee({queryKey:ke.paginated(Y,F,V,q(),parseInt(i.value,10)),queryFn:()=>ze(Pe,{skip:0,take:F,orderBy:_,where:q()}),placeholderData:Ae}),K=n.useCallback(s=>{c(s),j||(s==="legislator"?b(!0):P(!0))},[j]);n.useEffect(()=>{j&&(g(null),m(null),b(!0),P(!0))},[j]);const I=n.useCallback(s=>{f(s)},[]),Q=n.useCallback(s=>{g(s),b(!1),s&&(h.current=s)},[]),O=n.useCallback(s=>{m(s),P(!1),s&&(p.current=s)},[]),W=n.useCallback(()=>{a==="legislator"?l?(h.current=l,g(null),b(!1)):h.current&&(g(h.current),b(!1)):a==="department"&&(u?(p.current=u,m(null),P(!1)):p.current&&(m(p.current),P(!1)))},[a,l,u]),A=n.useMemo(()=>ae(C),[C]),M=n.useMemo(()=>{const s=new Map;return A.forEach(o=>{var w;const r=(w=o.proposers)==null?void 0:w[0],v=(r==null?void 0:r.id)??(r==null?void 0:r.name)??"",d=(r==null?void 0:r.name)??"未命名立委";v&&s.set(v,{value:v,label:d})}),Array.from(s.values()).sort((o,r)=>o.label.localeCompare(r.label,"zh-Hant"))},[A]),k=n.useMemo(()=>{const s=new Map;return A.forEach(o=>{var d,w;const r=(w=(d=o.government)==null?void 0:d.category)==null?void 0:w.trim(),v=r&&r.length>0?r:"未分類";s.set(v,{value:v,label:v})}),Array.from(s.values()).sort((o,r)=>o.label.localeCompare(r.label,"zh-Hant"))},[A]),t=n.useMemo(()=>{if(j||a!=="legislator"||!l)return null;const s=A.filter(o=>{var d;const r=(d=o.proposers)==null?void 0:d[0];return((r==null?void 0:r.id)??(r==null?void 0:r.name)??"")===l.value}).map(o=>o.id).filter(o=>!!o);return new Set(s)},[a,A,j,l]),N=n.useMemo(()=>{if(j||a!=="department"||!u)return null;const s=A.filter(o=>{var d,w;const r=(w=(d=o.government)==null?void 0:d.category)==null?void 0:w.trim();return(r&&r.length>0?r:"未分類")===u.value}).map(o=>o.id).filter(o=>!!o);return new Set(s)},[a,A,j,u]);n.useEffect(()=>{T&&(a==="legislator"?l&&M.some(o=>o.value===l.value)||(D&&M.length>0?g(M[0]):l&&g(null)):a==="department"&&(u&&k.some(o=>o.value===u.value)||(E&&k.length>0?m(k[0]):u&&m(null))))},[a,k,T,M,u,l,E,D]);const z=n.useMemo(()=>{var r;if(!C)return null;if(j)return C;let s=null;if(a==="legislator"&&t?s=t:a==="department"&&N&&(s=N),!s)return C;const o=((r=C.proposals)==null?void 0:r.filter(v=>{if(!v)return!1;const d=ne(Se,v),se=ne(we,d).id;return se!=null&&(s==null?void 0:s.has(se))}))??[];return{...C,proposals:o}},[a,C,N,t,j]),R=z??C??null,H=n.useMemo(()=>{const s=ae(z),o=L.filter(s,d=>d.reductionAmount&&d.reductionAmount>0),r=L.filter(s,d=>d.freezeAmount&&d.freezeAmount>0),v=L.filter(s,d=>{var w;return(w=d.proposalTypes)==null?void 0:w.includes(Ne.Other)});return{totalReductionAmount:L.sumBy(o,"reductionAmount"),reductionCount:o.length,totalFreezeAmount:L.sumBy(r,"freezeAmount"),freezeCount:r.length,mainResolutionCount:v.length}},[z]),ie=B(H.totalReductionAmount),ce=B(H.totalFreezeAmount),ue=n.useMemo(()=>z?pe(z,x):null,[z,x]);return{activeTab:a,handleTabChange:K,mode:x,setMode:y,selectedYear:i,handleYearChange:I,yearOptions:oe,legislatorOptions:M,selectedLegislatorOption:l,handleLegislatorChange:Q,departmentOptions:k,selectedDepartmentOption:u,handleDepartmentChange:O,handleToggleShowAll:W,isShowingAll:a==="legislator"&&!l||a==="department"&&!u,isDesktop:j,isMobile:T,isLoading:U,isError:$,rawData:C,visualizationData:R,legislatorVisualizationData:ue,summaryStats:H,formattedReductionAmount:ie,formattedFreezeAmount:ce}},Be=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Te=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Ve=({isDesktop:a})=>a?e.jsx(Be,{}):e.jsx(Te,{}),Fe=G({budgetYearId:X(),year:S()}),_e=G({reductionAmount:S(),reductionCount:S(),freezeAmount:S(),freezeCount:S(),otherCount:S()}),Ye=G({governmentId:X(),name:X(),reductionAmount:S(),reductionCount:S(),freezeAmount:S(),freezeCount:S(),otherCount:S()}),qe=G({yearInfo:Fe,overall:_e,departments:le(Ye)}),Ge=le(qe),Ue=()=>{const[a,c]=n.useState(0),[x,y]=n.useState(300),i=n.useRef(null);return{ref:n.useCallback(l=>{if(i.current&&i.current.disconnect(),l){const u=requestAnimationFrame(()=>{const m=l.getBoundingClientRect().width;m>0&&(y(m),c(Math.round(m*9/16)))});return i.current=new ResizeObserver(m=>{const h=m[0];if(h){const p=h.contentRect.width;y(p),c(Math.round(p*9/16))}}),i.current.observe(l),()=>{cancelAnimationFrame(u)}}},[]),width:x,height:a}},$e=()=>{const{ref:a,width:c,height:x}=Ue(),y=me(),{activeTab:i,handleTabChange:f,mode:l,setMode:g,selectedYear:u,handleYearChange:m,yearOptions:h,legislatorOptions:p,selectedLegislatorOption:D,handleLegislatorChange:b,departmentOptions:E,selectedDepartmentOption:P,handleDepartmentChange:j,handleToggleShowAll:T,isShowingAll:V,isDesktop:Y,isLoading:F,isError:q,visualizationData:_,legislatorVisualizationData:C}=Le(),U=["budget","legislators",(D==null?void 0:D.value)??"all"],$=async()=>{const t=await fetch(je);if(!t.ok)throw new Error("無法載入立委預算資料");return ve.parse(await t.json())},K=async()=>{const t=await fetch(Ce);if(!t.ok)throw new Error("無法載入部會預算資料");return Ge.parse(await t.json())},{data:I}=ee({queryKey:U,queryFn:$,enabled:i==="legislator"}),Q=["budget","departments"],{data:O}=ee({queryKey:Q,queryFn:K,enabled:i==="department"}),W=n.useMemo(()=>{var R;const t=(R=I==null?void 0:I[0])==null?void 0:R.overall,N=(t==null?void 0:t.reductionAmount)??0,z=(t==null?void 0:t.freezeAmount)??0;return{formattedReductionAmount:B(N),formattedFreezeAmount:B(z),reductionCount:(t==null?void 0:t.reductionCount)??0,freezeCount:(t==null?void 0:t.freezeCount)??0,mainResolutionCount:(t==null?void 0:t.otherCount)??0}},[I]),A=n.useMemo(()=>{var R;const t=(R=O==null?void 0:O[0])==null?void 0:R.overall,N=(t==null?void 0:t.reductionAmount)??0,z=(t==null?void 0:t.freezeAmount)??0;return{formattedReductionAmount:B(N),formattedFreezeAmount:B(z),reductionCount:(t==null?void 0:t.reductionCount)??0,freezeCount:(t==null?void 0:t.freezeCount)??0,mainResolutionCount:(t==null?void 0:t.otherCount)??0}},[O]),M=n.useMemo(()=>{if(l==="amount")return t=>{var N;return(N=t.children)!=null&&N.length?t.depth===0?20:t.depth===1?36:18:10}},[l]),k=n.useCallback(t=>{var N;return t.proposalId?(y(`/budget/${t.proposalId}`),!0):t.proposerId&&!((N=t.children)!=null&&N.length)?(y(`/visualization/legislator/${t.proposerId}`),!0):!1},[y]);return F?e.jsx(Ve,{isDesktop:Y}):q?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):_?e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Ee,{activeTab:i,onTabChange:f,yearOptions:h,selectedYear:u,onYearChange:m}),e.jsx(Ie,{activeTab:i,onTabChange:f,yearOptions:h,selectedYear:u,onYearChange:m,isShowingAll:V,onToggleShowAll:T,legislatorOptions:p,selectedLegislator:D,onLegislatorChange:b,departmentOptions:E,selectedDepartment:P,onDepartmentChange:j}),e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:l==="amount",onChange:()=>g("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:l==="count",onChange:()=>g("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),e.jsx(xe,{summary:i==="legislator"?W:A}),e.jsx(ye,{items:be}),F&&e.jsx(Me,{isDesktop:Y}),e.jsxs("div",{ref:a,className:"chart-container",children:[i==="legislator"&&C&&e.jsx(re,{data:_,transformedData:C,padding:M,onNodeClick:k,width:c,height:x,mode:l}),i==="department"&&e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"aspect-video md:aspect-video lg:aspect-video",children:e.jsx(re,{data:_,onNodeClick:k,width:c,height:x,mode:l})})})]})]})}):null},ot=de($e);export{ot as default};

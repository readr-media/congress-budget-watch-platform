import{a as n,p as e,y as le,G as oe}from"./chunk-4WY6JWTD-2Cr-QbDP.js";import{a as H,s as ie}from"./options-COhGXY56.js";import{t as ce,C as ue,m as Z,u as J,f as X,a as de,S as me,B as ge,b as he}from"./SummaryPanel-CQ9mGa_Z.js";import{O as U,u as pe,P as fe,V as xe,q as ve,l as ye,j as be}from"./gql-B1HC4FQa.js";import{l as P}from"./lodash-lK2eycnc.js";import{b as je}from"./index-Ck08PhAW.js";import{p as Ce,e as Ne}from"./visualization.queries-BrE3ru3N.js";import{B as Se}from"./budget-detail-skeleton-DMxLzU0j.js";import"./hoist-non-react-statics.cjs-BZ9oskQ4.js";import"./index-CtMSh7YR.js";import"./helpers-vI08C44X.js";import"./index-CSMLMQiO.js";const we=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],Q=n.forwardRef((a,o)=>e.jsx("div",{className:"w-60",children:e.jsx(H,{ref:o,options:we,...a})}));Q.displayName="VisualizationSelector";const ze=({activeTab:a,onTabChange:o,yearOptions:f,selectedYear:x,onYearChange:i})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>o("legislator"),className:`rounded px-2.5 transition-colors ${a==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>o("department"),className:`rounded px-2.5 transition-colors ${a==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(Q,{options:f,value:x,onChange:h=>{h&&i(h)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),De=({activeTab:a,onTabChange:o,yearOptions:f,selectedYear:x,onYearChange:i,isShowingAll:h,onToggleShowAll:l,legislatorOptions:m,selectedLegislator:c,onLegislatorChange:u,departmentOptions:g,selectedDepartment:p,onDepartmentChange:D})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:l,className:`rounded px-2.5 transition-colors ${h?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>o("legislator"),className:`rounded px-2.5 transition-colors ${a==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>o("department"),className:`rounded px-2.5 transition-colors ${a==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(Q,{options:f,value:x,onChange:v=>{v&&i(v)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!h&&a==="legislator"&&(m.length>0?e.jsx(H,{className:"w-full",value:c,options:m,onChange:v=>{u(v??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!h&&a==="department"&&(g.length>0?e.jsx(H,{className:"w-full",value:p,options:g,onChange:v=>{D(v??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Ae=a=>{var o;return(o=a.children)!=null&&o.length?a.depth===0?26:22:18},ee=({data:a,width:o=928,height:f,onNodeClick:x,mode:i,transformedData:h,padding:l})=>{const m=n.useMemo(()=>h??ce(a,i),[a,i,h]),c=n.useMemo(()=>l??Ae,[l]),u=Object.keys(m);return console.log({categories:u}),u.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:o},children:"無符合資料"}):e.jsx("div",{className:"flex flex-col items-center justify-center gap-y-8",children:Object.entries(m).map(([g,p])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:p.children&&p.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:g}),e.jsx(ue,{data:p,width:o,height:f??o,padding:c,onNodeClick:x})]})},g))})},te=[{value:"114",label:"114年度 (2025)"},{value:"113",label:"113年度 (2024)"}],ke=()=>{const[a,o]=n.useState("legislator"),[f,x]=n.useState("amount"),[i,h]=n.useState(te[0]),[l,m]=n.useState(null),[c,u]=n.useState(null),g=n.useRef(null),p=n.useRef(null),[D,v]=n.useState(!0),[A,z]=n.useState(!0),y=je("(min-width: 768px)"),M=!y,O="id-asc",E=1,R=1e3,T=n.useCallback(()=>({year:{year:{equals:parseInt(i.value,10)}},mergedParentProposals:null,historicalParentProposals:null}),[i.value]),I=n.useMemo(()=>{const t=P.find(ie,s=>s.value===O);if(!t)return[{id:U.Desc}];const r=t.direction==="asc"?U.Asc:U.Desc;return[{[t.field]:r}]},[O]),{data:C,isLoading:w,isError:F}=pe({queryKey:Ce.paginated(E,R,O,T(),parseInt(i.value,10)),queryFn:()=>be(Ne,{skip:0,take:R,orderBy:I,where:T()}),placeholderData:ye}),B=n.useCallback(t=>{o(t),y||(t==="legislator"?v(!0):z(!0))},[y]);n.useEffect(()=>{y&&(m(null),u(null),v(!0),z(!0))},[y]);const _=n.useCallback(t=>{h(t)},[]),$=n.useCallback(t=>{m(t),v(!1),t&&(g.current=t)},[]),Y=n.useCallback(t=>{u(t),z(!1),t&&(p.current=t)},[]),S=n.useCallback(()=>{a==="legislator"?l?(g.current=l,m(null),v(!1)):g.current&&(m(g.current),v(!1)):a==="department"&&(c?(p.current=c,u(null),z(!1)):p.current&&(u(p.current),z(!1)))},[a,l,c]),b=n.useMemo(()=>Z(C),[C]),L=n.useMemo(()=>{const t=new Map;return b.forEach(r=>{var N;const s=(N=r.proposers)==null?void 0:N[0],j=(s==null?void 0:s.id)??(s==null?void 0:s.name)??"",d=(s==null?void 0:s.name)??"未命名立委";j&&t.set(j,{value:j,label:d})}),Array.from(t.values()).sort((r,s)=>r.label.localeCompare(s.label,"zh-Hant"))},[b]),V=n.useMemo(()=>{const t=new Map;return b.forEach(r=>{var d,N;const s=(N=(d=r.government)==null?void 0:d.category)==null?void 0:N.trim(),j=s&&s.length>0?s:"未分類";t.set(j,{value:j,label:j})}),Array.from(t.values()).sort((r,s)=>r.label.localeCompare(s.label,"zh-Hant"))},[b]),q=n.useMemo(()=>{if(y||a!=="legislator"||!l)return null;const t=b.filter(r=>{var d;const s=(d=r.proposers)==null?void 0:d[0];return((s==null?void 0:s.id)??(s==null?void 0:s.name)??"")===l.value}).map(r=>r.id).filter(r=>!!r);return new Set(t)},[a,b,y,l]),G=n.useMemo(()=>{if(y||a!=="department"||!c)return null;const t=b.filter(r=>{var d,N;const s=(N=(d=r.government)==null?void 0:d.category)==null?void 0:N.trim();return(s&&s.length>0?s:"未分類")===c.value}).map(r=>r.id).filter(r=>!!r);return new Set(t)},[a,b,y,c]);n.useEffect(()=>{M&&(a==="legislator"?l&&L.some(r=>r.value===l.value)||(D&&L.length>0?m(L[0]):l&&m(null)):a==="department"&&(c&&V.some(r=>r.value===c.value)||(A&&V.length>0?u(V[0]):c&&u(null))))},[a,V,M,L,c,l,A,D]);const k=n.useMemo(()=>{var s;if(!C)return null;if(y)return C;let t=null;if(a==="legislator"&&q?t=q:a==="department"&&G&&(t=G),!t)return C;const r=((s=C.proposals)==null?void 0:s.filter(j=>{if(!j)return!1;const d=J(ve,j),K=J(xe,d).id;return K!=null&&(t==null?void 0:t.has(K))}))??[];return{...C,proposals:r}},[a,C,G,q,y]),ae=k??C??null,W=n.useMemo(()=>{const t=Z(k),r=P.filter(t,d=>d.reductionAmount&&d.reductionAmount>0),s=P.filter(t,d=>d.freezeAmount&&d.freezeAmount>0),j=P.filter(t,d=>{var N;return(N=d.proposalTypes)==null?void 0:N.includes(fe.Other)});return{totalReductionAmount:P.sumBy(r,"reductionAmount"),reductionCount:r.length,totalFreezeAmount:P.sumBy(s,"freezeAmount"),freezeCount:s.length,mainResolutionCount:j.length}},[k]),se=X(W.totalReductionAmount),ne=X(W.totalFreezeAmount),re=n.useMemo(()=>k?de(k,f):null,[k,f]);return{activeTab:a,handleTabChange:B,mode:f,setMode:x,selectedYear:i,handleYearChange:_,yearOptions:te,legislatorOptions:L,selectedLegislatorOption:l,handleLegislatorChange:$,departmentOptions:V,selectedDepartmentOption:c,handleDepartmentChange:Y,handleToggleShowAll:S,isShowingAll:a==="legislator"&&!l||a==="department"&&!c,isDesktop:y,isMobile:M,isLoading:w,isError:F,rawData:C,visualizationData:ae,legislatorVisualizationData:re,summaryStats:W,formattedReductionAmount:se,formattedFreezeAmount:ne}},Pe=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Me=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Oe=({isDesktop:a})=>a?e.jsx(Pe,{}):e.jsx(Me,{}),Re=()=>{const[a,o]=n.useState(0),[f,x]=n.useState(300),i=n.useRef(null);return{ref:n.useCallback(l=>{if(i.current&&i.current.disconnect(),l){const c=requestAnimationFrame(()=>{const u=l.getBoundingClientRect().width;u>0&&(x(u),o(Math.round(u*9/16)))});return i.current=new ResizeObserver(u=>{const g=u[0];if(g){const p=g.contentRect.width;x(p),o(Math.round(p*9/16))}}),i.current.observe(l),()=>{cancelAnimationFrame(c)}}},[]),width:f,height:a}},Ie=()=>{const{ref:a,width:o,height:f}=Re(),x=oe(),{activeTab:i,handleTabChange:h,mode:l,setMode:m,selectedYear:c,handleYearChange:u,yearOptions:g,legislatorOptions:p,selectedLegislatorOption:D,handleLegislatorChange:v,departmentOptions:A,selectedDepartmentOption:z,handleDepartmentChange:y,handleToggleShowAll:M,isShowingAll:O,isDesktop:E,isLoading:R,isError:T,visualizationData:I,legislatorVisualizationData:C,summaryStats:w,formattedReductionAmount:F,formattedFreezeAmount:B}=ke(),_=n.useMemo(()=>({formattedReductionAmount:F,formattedFreezeAmount:B,reductionCount:w.reductionCount,freezeCount:w.freezeCount,mainResolutionCount:w.mainResolutionCount}),[F,B,w.reductionCount,w.freezeCount,w.mainResolutionCount]),$=n.useMemo(()=>{if(l==="amount")return S=>{var b;return(b=S.children)!=null&&b.length?S.depth===0?20:S.depth===1?36:18:10}},[l]),Y=n.useCallback(S=>{var b;return S.proposalId?(x(`/budget/${S.proposalId}`),!0):S.proposerId&&!((b=S.children)!=null&&b.length)?(x(`/visualization/legislator/${S.proposerId}`),!0):!1},[x]);return R?e.jsx(Oe,{isDesktop:E}):T?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):I?e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(ze,{activeTab:i,onTabChange:h,yearOptions:g,selectedYear:c,onYearChange:u}),e.jsx(De,{activeTab:i,onTabChange:h,yearOptions:g,selectedYear:c,onYearChange:u,isShowingAll:O,onToggleShowAll:M,legislatorOptions:p,selectedLegislator:D,onLegislatorChange:v,departmentOptions:A,selectedDepartment:z,onDepartmentChange:y}),e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:l==="amount",onChange:()=>m("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:l==="count",onChange:()=>m("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),e.jsx(me,{summary:_}),e.jsx(ge,{items:he}),R&&e.jsx(Se,{isDesktop:E}),e.jsxs("div",{ref:a,className:"chart-container",children:[i==="legislator"&&C&&e.jsx(ee,{data:I,transformedData:C,padding:$,onNodeClick:Y,width:o,height:f,mode:l}),i==="department"&&e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"aspect-video md:aspect-video lg:aspect-video",children:e.jsx(ee,{data:I,onNodeClick:Y,width:o,height:f,mode:l})})})]})]})}):null},He=le(Ie);export{He as default};

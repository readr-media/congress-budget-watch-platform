import{a as r,p as e,y as ce,H as de}from"./chunk-FGUA77HG-BrA7_UWl.js";import{S as Z,s as me}from"./react-select.esm-CnZKZ7WR.js";import{t as ge,C as he,m as se,u as ne,f as q,a as fe,o as K,n as A,s as J,b as oe,S as pe,B as xe,c as ye,d as be,e as je,g as ve}from"./budget-by-legislator.schema-D80k0MP0.js";import{O as H,u as X,P as Ce,V as we,q as Ne,l as Se,j as Ae}from"./gql-B-mwqB7Q.js";import{l as _}from"./floating-ui.dom-D7dPsNSj.js";import{b as ze}from"./index-D4o5tLmX.js";import{p as De,e as ke}from"./visualization.queries-9AKN3csb.js";import{B as Pe}from"./budget-detail-skeleton-DdreXLgs.js";import"./hoist-non-react-statics.cjs-Dro-b_67.js";import"./index-BU5Ik6l7.js";import"./helpers-j5VDf7UR.js";import"./index-CneDlBJs.js";const Me=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],ee=r.forwardRef((s,i)=>e.jsx("div",{className:"w-60",children:e.jsx(Z,{ref:i,options:Me,...s})}));ee.displayName="VisualizationSelector";const Re=({activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${s==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${s==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ee,{options:y,value:h,onChange:m=>{m&&u(m)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),Ee=({activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u,isShowingAll:m,onToggleShowAll:l,legislatorOptions:f,selectedLegislator:c,onLegislatorChange:g,departmentOptions:p,selectedDepartment:x,onDepartmentChange:S})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:l,className:`rounded px-2.5 transition-colors ${m?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${s==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${s==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ee,{options:y,value:h,onChange:b=>{b&&u(b)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!m&&s==="legislator"&&(f.length>0?e.jsx(Z,{className:"w-full",value:c,options:f,onChange:b=>{g(b??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!m&&s==="department"&&(p.length>0?e.jsx(Z,{className:"w-full",value:x,options:p,onChange:b=>{S(b??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Ie=s=>{var i;return(i=s.children)!=null&&i.length?s.depth===0?26:22:18},re=({data:s,width:i=928,height:y,onNodeClick:h,mode:u,transformedData:m,padding:l})=>{const f=r.useMemo(()=>m??ge(s,u),[s,u,m]),c=r.useMemo(()=>l??Ie,[l]);return Object.keys(f).length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:i},children:"無符合資料"}):e.jsx("div",{className:"flex flex-col items-center justify-center gap-y-8",children:Object.entries(f).map(([p,x])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:x.children&&x.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:p}),e.jsx(he,{data:x,width:i,height:y??i,padding:c,onNodeClick:h})]})},p))})},ae=[{value:"114",label:"114年度 (2025)"},{value:"113",label:"113年度 (2024)"}],Le=()=>{const[s,i]=r.useState("legislator"),[y,h]=r.useState("amount"),[u,m]=r.useState(ae[0]),[l,f]=r.useState(null),[c,g]=r.useState(null),p=r.useRef(null),x=r.useRef(null),[S,b]=r.useState(!0),[P,D]=r.useState(!0),j=ze("(min-width: 768px)"),E=!j,M="id-asc",I=1,R=r.useCallback(()=>({year:{year:{equals:parseInt(u.value,10)}},mergedParentProposals:null,historicalParentProposals:null,result:{equals:"passed"}}),[u.value]),B=r.useMemo(()=>{const n=_.find(me,a=>a.value===M);if(!n)return[{id:H.Desc}];const o=n.direction==="asc"?H.Asc:H.Desc;return[{[n.field]:o}]},[M]),{data:C,isLoading:Y,isError:U}=X({queryKey:De.paginated(I,M,R(),parseInt(u.value,10)),queryFn:()=>Ae(ke,{skip:0,orderBy:B,where:R()}),placeholderData:Se}),V=r.useCallback(n=>{if(i(n),!j){if(n==="legislator"){b(!0);return}D(!0)}},[j]);r.useEffect(()=>{j&&(f(null),g(null),b(!0),D(!0))},[j]);const Q=r.useCallback(n=>{m(n)},[]),F=r.useCallback(n=>{f(n),b(!1),n&&(p.current=n)},[]),W=r.useCallback(n=>{g(n),D(!1),n&&(x.current=n)},[]),T=r.useCallback(()=>{s==="legislator"?l?(p.current=l,f(null),b(!1)):p.current&&(f(p.current),b(!1)):s==="department"&&(c?(x.current=c,g(null),D(!1)):x.current&&(g(x.current),D(!1)))},[s,l,c]),z=r.useMemo(()=>se(C),[C]),L=r.useMemo(()=>{const n=new Map;return z.forEach(o=>{var N;const a=(N=o.proposers)==null?void 0:N[0],w=(a==null?void 0:a.id)??(a==null?void 0:a.name)??"",d=(a==null?void 0:a.name)??"未命名立委";w&&n.set(w,{value:w,label:d})}),Array.from(n.values()).sort((o,a)=>o.label.localeCompare(a.label,"zh-Hant"))},[z]),O=r.useMemo(()=>{const n=new Map;return z.forEach(o=>{var d,N;const a=(N=(d=o.government)==null?void 0:d.category)==null?void 0:N.trim(),w=a&&a.length>0?a:"未分類";n.set(w,{value:w,label:w})}),Array.from(n.values()).sort((o,a)=>o.label.localeCompare(a.label,"zh-Hant"))},[z]),G=r.useMemo(()=>{if(j||s!=="legislator"||!l)return null;const n=z.filter(o=>{var d;const a=(d=o.proposers)==null?void 0:d[0];return((a==null?void 0:a.id)??(a==null?void 0:a.name)??"")===l.value}).map(o=>o.id).filter(o=>!!o);return new Set(n)},[s,z,j,l]),t=r.useMemo(()=>{if(j||s!=="department"||!c)return null;const n=z.filter(o=>{var d,N;const a=(N=(d=o.government)==null?void 0:d.category)==null?void 0:N.trim();return(a&&a.length>0?a:"未分類")===c.value}).map(o=>o.id).filter(o=>!!o);return new Set(n)},[s,z,j,c]);r.useEffect(()=>{E&&(s==="legislator"?l&&L.some(o=>o.value===l.value)||(S&&L.length>0?f(L[0]):l&&f(null)):s==="department"&&(c&&O.some(o=>o.value===c.value)||(P&&O.length>0?g(O[0]):c&&g(null))))},[s,O,E,L,c,l,P,S]);const v=r.useMemo(()=>{var a;if(!C)return null;if(j)return C;let n=null;if(s==="legislator"&&G?n=G:s==="department"&&t&&(n=t),!n)return C;const o=((a=C.proposals)==null?void 0:a.filter(w=>{if(!w)return!1;const d=ne(Ne,w),te=ne(we,d).id;return te!=null&&(n==null?void 0:n.has(te))}))??[];return{...C,proposals:o}},[s,C,t,G,j]),$=v??C??null,k=r.useMemo(()=>{const n=se(v),o=_.filter(n,d=>d.reductionAmount&&d.reductionAmount>0),a=_.filter(n,d=>d.freezeAmount&&d.freezeAmount>0),w=_.filter(n,d=>{var N;return(N=d.proposalTypes)==null?void 0:N.includes(Ce.Other)});return{totalReductionAmount:_.sumBy(o,"reductionAmount"),reductionCount:o.length,totalFreezeAmount:_.sumBy(a,"freezeAmount"),freezeCount:a.length,mainResolutionCount:w.length}},[v]),le=q(k.totalReductionAmount),ie=q(k.totalFreezeAmount),ue=r.useMemo(()=>v?fe(v,y):null,[v,y]);return{activeTab:s,handleTabChange:V,mode:y,setMode:h,selectedYear:u,handleYearChange:Q,yearOptions:ae,legislatorOptions:L,selectedLegislatorOption:l,handleLegislatorChange:F,departmentOptions:O,selectedDepartmentOption:c,handleDepartmentChange:W,handleToggleShowAll:T,isShowingAll:s==="legislator"&&!l||s==="department"&&!c,isDesktop:j,isMobile:E,isLoading:Y,isError:U,rawData:C,visualizationData:$,legislatorVisualizationData:ue,summaryStats:k,formattedReductionAmount:le,formattedFreezeAmount:ie}},Oe=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Be=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Ve=({isDesktop:s})=>s?e.jsx(Oe,{}):e.jsx(Be,{}),Fe=K({budgetYearId:J(),year:A()}),Te=K({reductionAmount:A(),reductionCount:A(),freezeAmount:A(),freezeCount:A(),otherCount:A()}),_e=K({governmentId:J(),name:J(),reductionAmount:A(),reductionCount:A(),freezeAmount:A(),freezeCount:A(),otherCount:A()}),qe=K({yearInfo:Fe,overall:Te,departments:oe(_e)}),Ye=oe(qe),Ue=()=>{const[s,i]=r.useState(0),[y,h]=r.useState(300),u=r.useRef(null);return{ref:r.useCallback(l=>{if(u.current&&u.current.disconnect(),l){const c=requestAnimationFrame(()=>{const g=l.getBoundingClientRect().width;g>0&&(h(g),i(Math.round(g*9/16)))});return u.current=new ResizeObserver(g=>{const p=g[0];if(p){const x=p.contentRect.width;h(x),i(Math.round(x*9/16))}}),u.current.observe(l),()=>{cancelAnimationFrame(c)}}},[]),width:y,height:s}},Ge=({activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u,mode:m,onModeChange:l,isShowingAll:f,onToggleShowAll:c,legislatorOptions:g,selectedLegislatorOption:p,onLegislatorChange:x,departmentOptions:S,selectedDepartmentOption:b,onDepartmentChange:P,isDesktop:D,isLoading:j,chartContainerRef:E,chartWidth:M,chartHeight:I,visualizationData:R,legislatorVisualizationData:B,legislatorSummary:C,departmentSummary:Y,legislatorPadding:U,onNodeClick:V})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Re,{activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u}),e.jsx(Ee,{activeTab:s,onTabChange:i,yearOptions:y,selectedYear:h,onYearChange:u,isShowingAll:f,onToggleShowAll:c,legislatorOptions:g,selectedLegislator:p,onLegislatorChange:x,departmentOptions:S,selectedDepartment:b,onDepartmentChange:P}),e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:m==="amount",onChange:()=>l("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:m==="count",onChange:()=>l("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),e.jsx(pe,{summary:s==="legislator"?C:Y}),e.jsx(xe,{items:ye}),j&&e.jsx(Pe,{isDesktop:D}),e.jsxs("div",{ref:E,className:"chart-container",children:[s==="legislator"&&B&&e.jsx(re,{data:R,transformedData:B,padding:U,onNodeClick:V,width:M,height:I,mode:m}),s==="department"&&e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"aspect-video md:aspect-video lg:aspect-video",children:e.jsx(re,{data:R,onNodeClick:V,width:M,height:I,mode:m})})})]})]})}),$e=()=>{const{ref:s,width:i,height:y}=Ue(),h=de(),{activeTab:u,handleTabChange:m,mode:l,setMode:f,selectedYear:c,handleYearChange:g,yearOptions:p,legislatorOptions:x,selectedLegislatorOption:S,handleLegislatorChange:b,departmentOptions:P,selectedDepartmentOption:D,handleDepartmentChange:j,handleToggleShowAll:E,isShowingAll:M,isDesktop:I,isLoading:R,isError:B,visualizationData:C,legislatorVisualizationData:Y}=Le(),U=["budget","legislators",(S==null?void 0:S.value)??"all"],V=async()=>{const t=await fetch(be);if(!t.ok)throw new Error("無法載入立委預算資料");return je.parse(await t.json())},Q=async()=>{const t=await fetch(ve);if(!t.ok)throw new Error("無法載入部會預算資料");return Ye.parse(await t.json())},{data:F}=X({queryKey:U,queryFn:V,enabled:u==="legislator"}),W=["budget","departments"],{data:T}=X({queryKey:W,queryFn:Q,enabled:u==="department"}),z=r.useMemo(()=>{var k;const t=(k=F==null?void 0:F[0])==null?void 0:k.overall,v=(t==null?void 0:t.reductionAmount)??0,$=(t==null?void 0:t.freezeAmount)??0;return{formattedReductionAmount:q(v),formattedFreezeAmount:q($),reductionCount:(t==null?void 0:t.reductionCount)??0,freezeCount:(t==null?void 0:t.freezeCount)??0,mainResolutionCount:(t==null?void 0:t.otherCount)??0}},[F]),L=r.useMemo(()=>{var k;const t=(k=T==null?void 0:T[0])==null?void 0:k.overall,v=(t==null?void 0:t.reductionAmount)??0,$=(t==null?void 0:t.freezeAmount)??0;return{formattedReductionAmount:q(v),formattedFreezeAmount:q($),reductionCount:(t==null?void 0:t.reductionCount)??0,freezeCount:(t==null?void 0:t.freezeCount)??0,mainResolutionCount:(t==null?void 0:t.otherCount)??0}},[T]),O=r.useMemo(()=>{if(l==="amount")return t=>{var v;return(v=t.children)!=null&&v.length?t.depth===0?20:t.depth===1?36:18:10}},[l]),G=r.useCallback(t=>{var v;return t.proposalId?(h(`/budget/${t.proposalId}`),!0):t.proposerId&&!((v=t.children)!=null&&v.length)?(h(`/visualization/legislator/${t.proposerId}`),!0):!1},[h]);return R?e.jsx(Ve,{isDesktop:I}):B?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):C?e.jsx(Ge,{activeTab:u,onTabChange:m,yearOptions:p,selectedYear:c,onYearChange:g,mode:l,onModeChange:f,isShowingAll:M,onToggleShowAll:E,legislatorOptions:x,selectedLegislatorOption:S,onLegislatorChange:b,departmentOptions:P,selectedDepartmentOption:D,onDepartmentChange:j,isDesktop:I,isLoading:R,chartContainerRef:s,chartWidth:i,chartHeight:y,visualizationData:C,legislatorVisualizationData:Y,legislatorSummary:z,departmentSummary:L,legislatorPadding:O,onNodeClick:G}):null},ot=ce($e);export{ot as default};

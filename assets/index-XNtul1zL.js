import{a as n,p as e,H as de,y as me}from"./chunk-EPOLDU6W-BUbbWhPN.js";import{t as ie,G as ge,f as U,C as te,S as he,B as pe,a as fe,m as xe,g as se,u as Z,b as ye,c as je,d as be,e as ve,h as we}from"./budget-endpoints-CMHyXkPv.js";import{B as Ce}from"./budget-detail-skeleton-Dp8GXHLT.js";import{S as H}from"./react-select.esm-D75C9S97.js";import{u as K,k as ue,V as re,t as Ne,q as Se}from"./gql-BxFV-4F3.js";import{b as Ae,a as De,p as Ee,g as Le}from"./visualization.queries-thfxbE4W.js";import{Y as ae}from"./floating-ui.dom-Bxq-dYPq.js";import"./helpers-gYzQ5zWH.js";import{b as ke}from"./index-yRWPS69A.js";import"./index-IDBlchwH.js";import"./index-CFRUIq19.js";import"./hoist-non-react-statics.cjs-Cim0U2tB.js";const ze=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],ee=n.forwardRef((t,u)=>e.jsx("div",{className:"w-60",children:e.jsx(H,{ref:u,options:ze,...t})}));ee.displayName="VisualizationSelector";var $=(t=>(t.Legislator="legislator",t.Department="department",t))($||{}),q=(t=>(t.Amount="amount",t.Count="count",t))(q||{});const Me=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:m,onYearChange:p})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>u($.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>u($.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ee,{options:h,value:m,onChange:d=>{d&&p(d)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),Pe=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:m,onYearChange:p,isShowingAll:d,onToggleShowAll:c,legislatorOptions:r,selectedLegislator:o,onLegislatorChange:i,departmentOptions:x,selectedDepartment:v,onDepartmentChange:y})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:c,className:`rounded px-2.5 transition-colors ${d?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>u($.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>u($.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ee,{options:h,value:m,onChange:a=>{a&&p(a)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!d&&t==="legislator"&&(r.length>0?e.jsx(H,{className:"w-full",value:o,options:r,onChange:a=>{i(a??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!d&&t==="department"&&(x.length>0?e.jsx(H,{className:"w-full",value:v,options:x,onChange:a=>{y(a??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Be=t=>{var u;return(u=t.children)!=null&&u.length?t.depth===0?26:22:18},J=.45,ne=({data:t,width:u=928,height:h,onNodeClick:m,mode:p,transformedData:d,padding:c,selectedDepartmentCategorizedData:r,selectedDepartmentTitle:o,showSelectedDepartmentChart:i})=>{const x=n.useMemo(()=>d??ie(t,p),[t,p,d]),v=n.useMemo(()=>c??Be,[c]),y=n.useMemo(()=>{if(!r)return null;const j=Object.values(r).flatMap(w=>w.children??[]);if(!j.length)return null;const E=new Map;return j.forEach(w=>{var _;const f=[w.proposerId??w.name??"unknown",w.proposalType??"unknown-type"].join("-"),I=((_=w.name)==null?void 0:_.split(`
`)[0])??w.name??"無名提案者",V=w.value??0,k=V>0?Math.pow(V,1/J):0,z=ge[w.proposalType]??"",M=E.get(f);if(M){const S=M.totalAmount+k;E.set(f,{totalAmount:S,node:{...M.node,name:`${I}
${z}
${U(S)}`,value:Math.pow(S,J)}})}else E.set(f,{totalAmount:k,node:{...w,id:`merged-${f}`,name:`${I}
${z}
${U(k)}`,value:Math.pow(k,J)}})}),Array.from(E.values()).map(w=>w.node)},[r]),a=n.useMemo(()=>!y||!i?null:{id:`selected-department-${o??"selected"}`,name:o??"目前部會",children:y},[y,o,i]),b=Object.keys(x),N=a;return b.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:u},children:"無符合資料"}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-y-8",children:[N&&e.jsxs("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:[e.jsx("p",{className:"text-xl",children:"看全部"}),e.jsx(te,{data:N,width:u,height:h??u,padding:v,onNodeClick:m})]},"selected-department-highlight"),Object.entries(x).map(([j,E])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:E.children&&E.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:j}),e.jsx(te,{data:E,width:u,height:h??u,padding:v,onNodeClick:m})]})},j))]})},Re=({mode:t,onModeChange:u})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:q.Amount,checked:t===q.Amount,onChange:()=>u(q.Amount),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:q.Count,checked:t===q.Count,onChange:()=>u(q.Count),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),Ie=({departmentOptions:t,selectedDepartmentOption:u,onDepartmentChange:h})=>t.length===0?e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"})}):e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx(H,{className:"w-full md:max-w-xl",value:u,options:t,onChange:m=>{h(m??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department-desktop"})}),le="資料尚未建置完成或立法院尚在審議中，此處預算視覺化非最終通過狀態",Ve=()=>{var d;const{data:t,isLoading:u,isError:h}=K({queryKey:Ae.latest(),queryFn:()=>ue(De,{skip:0,take:1}),staleTime:3e5});if(u||h)return null;const m=((d=t==null?void 0:t.budgetYears)==null?void 0:d[0])??null;return(m==null?void 0:m.dataProgress)!=="in-progress"?null:e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"md:flex hidden justify-center",children:e.jsx("div",{className:"bg-budget-accent w-[488px] rounded-[11px] px-[27px] py-[16px]",children:e.jsx("p",{className:"text-[14px] font-medium text-black text-center",children:le})})}),e.jsx("div",{className:"md:hidden marquee-container bg-budget-accent py-[6px]",children:e.jsx("p",{className:"animate-marquee px-[10px] text-[14px] font-normal text-black",children:le})})]})},_e=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:m,onYearChange:p,mode:d,onModeChange:c,isShowingAll:r,onToggleShowAll:o,legislatorOptions:i,selectedLegislatorOption:x,onLegislatorChange:v,departmentOptions:y,selectedDepartmentOption:a,onDepartmentChange:b,isDesktop:N,isLoading:j,legislatorChartContainerRef:E,legislatorChartWidth:w,legislatorChartHeight:f,departmentChartContainerRef:I,departmentChartWidth:V,departmentChartHeight:k,visualizationData:z,legislatorVisualizationData:M,legislatorSummary:_,departmentSummary:S,legislatorPadding:L,selectedDepartmentCategorizedData:A,selectedDepartmentTitle:Y,showSelectedDepartmentChart:G,onNodeClick:F})=>{const O=N&&t==="department",W=t==="department"&&z,T=t==="legislator"&&M;return j?e.jsx(Ce,{isDesktop:N}):e.jsxs("div",{children:[e.jsx(Ve,{}),e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Me,{activeTab:t,onTabChange:u,yearOptions:h,selectedYear:m,onYearChange:p}),e.jsx(Pe,{activeTab:t,onTabChange:u,yearOptions:h,selectedYear:m,onYearChange:p,isShowingAll:r,onToggleShowAll:o,legislatorOptions:i,selectedLegislator:x,onLegislatorChange:v,departmentOptions:y,selectedDepartment:a,onDepartmentChange:b}),e.jsx(Re,{mode:d,onModeChange:c}),e.jsx(he,{summary:t==="legislator"?_:S}),O&&e.jsx(Ie,{departmentOptions:y,selectedDepartmentOption:a,onDepartmentChange:b}),e.jsx(pe,{items:fe}),T&&e.jsx("div",{ref:E,className:"chart-container",children:e.jsx(ne,{data:z,transformedData:M,padding:L,onNodeClick:F,width:w,height:f,mode:d},"legislator-chart")}),W&&e.jsx("div",{ref:I,className:"chart-container",children:e.jsx(ne,{data:z,onNodeClick:F,width:V,height:k,mode:d,selectedDepartmentCategorizedData:A,selectedDepartmentTitle:Y??null,showSelectedDepartmentChart:G},"department-chart")})]})]})},Fe=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Te=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),qe=({isDesktop:t})=>t?e.jsx(Fe,{}):e.jsx(Te,{}),oe=()=>{const h=Math.round(225),[m,p]=n.useState(h),[d,c]=n.useState(300),r=n.useRef(null);return{ref:n.useCallback(i=>{if(r.current&&r.current.disconnect(),!i)return;const v=requestAnimationFrame(()=>{const y=i.getBoundingClientRect().width;y<=0||(c(y),p(Math.round(y*.75)))});return r.current=new ResizeObserver(y=>{const a=y[0];if(!a)return;const b=a.contentRect.width;c(b),p(Math.round(b*.75))}),r.current.observe(i),()=>{cancelAnimationFrame(v)}},[]),width:d,height:m}},Oe=()=>{const[t,u]=n.useState($.Legislator),[h,m]=n.useState(q.Amount),[p,d]=n.useState(ae[0]),[c,r]=n.useState(null),[o,i]=n.useState(null),x=n.useRef(null),v=n.useRef(null),[y,a]=n.useState(!0),[b,N]=n.useState(!0),j=ke("(min-width: 768px)"),E=!j,w=n.useCallback(()=>({year:{year:{equals:parseInt(p.value,10)}},mergedParentProposals:null,historicalParentProposals:null,result:{equals:"passed"}}),[p.value]),{data:f,isLoading:I,isError:V}=K({queryKey:Ee.paginated(w(),parseInt(p.value,10)),queryFn:()=>ue(Le,{where:w()}),placeholderData:Se}),k=n.useCallback(s=>{if(u(s),!j){if(s==="legislator"){a(!0);return}N(!0)}},[j]);n.useEffect(()=>{j&&(r(null),i(null),a(!0),N(!0))},[j]);const z=n.useCallback(s=>{d(s)},[]),M=n.useCallback(s=>{r(s),a(!1),s&&(x.current=s)},[]),_=n.useCallback(s=>{i(s),N(!1),s&&(v.current=s)},[]),S=n.useMemo(()=>xe(f),[f]),L=n.useMemo(()=>{const s=new Map;return S.forEach(l=>{var D;((D=l.proposers)!=null&&D.length?l.proposers:[]).forEach((C,B)=>{const R=se(C,l.id,B);if(!R)return;const ce=(C==null?void 0:C.name)??"未命名立委";s.has(R)||s.set(R,{value:R,label:ce})})}),Array.from(s.values()).sort((l,g)=>l.label.localeCompare(g.label,"zh-Hant"))},[S]),A=n.useMemo(()=>{const s=new Map;return S.forEach(l=>{var C,B;const g=(B=(C=l.government)==null?void 0:C.category)==null?void 0:B.trim(),D=g&&g.length>0?g:"未分類";s.set(D,{value:D,label:D})}),Array.from(s.values()).sort((l,g)=>l.label.localeCompare(g.label,"zh-Hant"))},[S]),Y=n.useCallback(()=>{t==="legislator"?c?(x.current=c,r(null),a(!1)):x.current?(r(x.current),a(!1)):L.length>0&&(r(L[0]),a(!1)):t==="department"&&(o?(v.current=o,i(null),N(!1)):v.current?(i(v.current),N(!1)):A.length>0&&(i(A[0]),N(!1)))},[t,c,o,L,A]),G=n.useCallback(s=>{const l=s==null?void 0:s.trim();return l&&l.length>0?l:"未分類"},[]),F=n.useMemo(()=>{if(j||t!=="legislator"||!c)return null;const s=S.filter(l=>{const g=l.proposers??[];return g.length===0?!1:g.some((D,C)=>se(D,l.id,C)===c.value)}).map(l=>l.id).filter(l=>!!l);return new Set(s)},[t,S,j,c]),O=n.useMemo(()=>{if(t!=="department"||!o)return null;const s=S.filter(l=>{var C,B;const g=(B=(C=l.government)==null?void 0:C.category)==null?void 0:B.trim();return(g&&g.length>0?g:"未分類")===o.value}).map(l=>l.id).filter(l=>!!l);return new Set(s)},[t,S,o]),W=n.useMemo(()=>{var g;if(!f||t!=="department"||!o||!o.value)return null;const s=((g=f.proposals)==null?void 0:g.filter(D=>{var R;if(!D)return!1;const C=Z(re,D);return G(((R=C.government)==null?void 0:R.category)??null)===o.value}))??[];if(!s.length)return null;const l={...f,proposals:s};return ie(l,h)},[t,f,h,G,o]);n.useEffect(()=>{E&&(t==="legislator"?c&&L.some(l=>l.value===c.value)||(y&&L.length>0?r(L[0]):c&&r(null)):t==="department"&&(o&&A.some(l=>l.value===o.value)||(b&&A.length>0?i(A[0]):o&&i(null))))},[t,A,E,L,o,c,b,y]),n.useEffect(()=>{if(!j||t!=="department")return;!(o&&A.some(l=>l.value===o.value))&&A.length>0&&(i(A[0]),N(!1))},[t,A,j,o]);const T=n.useMemo(()=>{var g;if(!f)return null;let s=null;if(t==="legislator"&&F?s=F:t==="department"&&O&&(s=O),!s)return f;const l=((g=f.proposals)==null?void 0:g.filter(D=>{if(!D)return!1;const C=Z(re,D),R=Z(Ne,C).id;return R!=null&&(s==null?void 0:s.has(R))}))??[];return{...f,proposals:l}},[t,f,O,F]),Q=T??f??null,X=n.useMemo(()=>{if(!T)return null;const s=ye(T,h);if(!(!j&&t==="legislator"&&c))return s;const g=s[""];if(!(g!=null&&g.children))return s;const D=g.children.filter(C=>C.proposerId===c.value||C.proposerKey===c.value);return{...s,"":{...g,children:D}}},[t,T,j,h,c]);return{activeTab:t,handleTabChange:k,mode:h,setMode:m,selectedYear:p,handleYearChange:z,yearOptions:ae,legislatorOptions:L,selectedLegislatorOption:c,handleLegislatorChange:M,departmentOptions:A,selectedDepartmentOption:o,handleDepartmentChange:_,handleToggleShowAll:Y,isShowingAll:t==="legislator"&&!c||t==="department"&&!o,isDesktop:j,isMobile:E,isLoading:I,isError:V,rawData:f,visualizationData:Q,legislatorVisualizationData:X,selectedDepartmentCategorizedData:W}},$e=({selectedLegislatorOption:t,activeTab:u,isShowingAll:h})=>{const m=["budget","legislators"],p=async()=>{const i=await fetch(je);if(!i.ok)throw new Error("無法載入立委預算資料");const x=await i.json(),v=be.safeParse(x);if(!v.success)throw new Error("立委預算資料格式不符合預期");return v.data},{data:d,isLoading:c,isError:r}=K({queryKey:m,queryFn:p,enabled:u==="legislator"}),o=n.useMemo(()=>{var y;const i=d==null?void 0:d[0],x=i==null?void 0:i.overall,v=a=>{const b=(a==null?void 0:a.reductionAmount)??0,N=(a==null?void 0:a.freezeAmount)??0;return{formattedReductionAmount:U(b),formattedFreezeAmount:U(N),reductionCount:(a==null?void 0:a.reductionCount)??0,freezeCount:(a==null?void 0:a.freezeCount)??0,mainResolutionCount:(a==null?void 0:a.otherCount)??0}};if(u===$.Legislator&&!h&&t&&((y=i==null?void 0:i.legislators)!=null&&y.length)){const a=i.legislators.find(b=>b.peopleId===t.value)??i.legislators.find(b=>b.name===t.label);if(a){const b=a.allInvolved??a.proposerOnly;return v(b)}}return v(x)},[u,h,d,t]);return{legislatorBudgetSummaryData:d,legislatorSummary:o,isLegislatorBudgetLoading:c,isLegislatorBudgetError:r}},Ge=({activeTab:t})=>{const u=async()=>{const r=await fetch(ve);if(!r.ok)throw new Error("無法載入部會預算資料");const o=await r.json(),i=we.safeParse(o);if(!i.success)throw new Error("部會預算資料格式不符合預期");return i.data},h=["budget","departments"],{data:m,isLoading:p,isError:d}=K({queryKey:h,queryFn:u,enabled:t==="department"}),c=n.useMemo(()=>{var x;const r=(x=m==null?void 0:m[0])==null?void 0:x.overall,o=(r==null?void 0:r.reductionAmount)??0,i=(r==null?void 0:r.freezeAmount)??0;return{formattedReductionAmount:U(o),formattedFreezeAmount:U(i),reductionCount:(r==null?void 0:r.reductionCount)??0,freezeCount:(r==null?void 0:r.freezeCount)??0,mainResolutionCount:(r==null?void 0:r.otherCount)??0}},[m]);return{departmentBudgetSummaryData:m,departmentSummary:c,isDepartmentBudgetLoading:p,isDepartmentBudgetError:d}},Ue=({children:t})=>{const{ref:u,width:h,height:m}=oe(),{ref:p,width:d,height:c}=oe(),r=de(),{activeTab:o,handleTabChange:i,mode:x,setMode:v,selectedYear:y,handleYearChange:a,yearOptions:b,legislatorOptions:N,selectedLegislatorOption:j,handleLegislatorChange:E,departmentOptions:w,selectedDepartmentOption:f,handleDepartmentChange:I,handleToggleShowAll:V,isShowingAll:k,isDesktop:z,isLoading:M,isError:_,visualizationData:S,legislatorVisualizationData:L,selectedDepartmentCategorizedData:A}=Oe(),{legislatorSummary:Y,isLegislatorBudgetLoading:G,isLegislatorBudgetError:F}=$e({selectedLegislatorOption:j,activeTab:o,isShowingAll:k}),{departmentSummary:O,isDepartmentBudgetLoading:W,isDepartmentBudgetError:T}=Ge({activeTab:o}),Q=n.useMemo(()=>{if(x==="amount")return P=>{var s;return(s=P.children)!=null&&s.length?P.depth===0?20:P.depth===1?36:18:10}},[x]),X=n.useCallback(P=>{var s;if(P.proposalId)return r(`/budget/${P.proposalId}`),!0;if(P.proposerId&&!((s=P.children)!=null&&s.length)){const l=y.value,g=new URLSearchParams({year:l}).toString();return r(`/visualization/legislator/${P.proposerId}?${g}`),!0}return!1},[r,y.value]);return M||G||W?e.jsx(qe,{isDesktop:z}):_||F||T?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):S?t({activeTab:o,onTabChange:i,yearOptions:b,selectedYear:y,onYearChange:a,mode:x,onModeChange:v,isShowingAll:k,onToggleShowAll:V,legislatorOptions:N,selectedLegislatorOption:j,onLegislatorChange:E,departmentOptions:w,selectedDepartmentOption:f,onDepartmentChange:I,isDesktop:z,isLoading:M,legislatorChartContainerRef:u,legislatorChartWidth:h,legislatorChartHeight:m,departmentChartContainerRef:p,departmentChartWidth:d,departmentChartHeight:c,visualizationData:S,legislatorVisualizationData:L,legislatorSummary:Y,departmentSummary:O,legislatorPadding:Q,selectedDepartmentCategorizedData:A,selectedDepartmentTitle:(f==null?void 0:f.label)??null,showSelectedDepartmentChart:!!A,onNodeClick:X}):null},Ye=()=>e.jsx(Ue,{children:t=>e.jsx(_e,{...t})}),nt=me(Ye);export{nt as default};

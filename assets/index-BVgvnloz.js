import{p as e,y as W,I as H,D as X,a as c,H as Z,L as J}from"./chunk-JZWAC4HX-Ct9RjdWh.js";import{v as ee,u as z,P as re,k as B,O as se}from"./gql-O11rvESk.js";import{Y as b,l as j}from"./react-select.esm-DdJz1C4J.js";import{b as v}from"./index-Y9OsAbSh.js";import{C as ae,i as te,m as ne,f as P,V as le,S as oe,B as ie,a as de,P as ce,c as me,d as ue}from"./budget-endpoints-CFNdu5ts.js";import{g as xe,p as pe}from"./visualization.queries-DcDuSFa6.js";import"./hoist-non-react-statics.cjs-DwzeC8GI.js";import"./index-DWhu2-He.js";import"./index-CGdvuWtd.js";import"./helpers-RynDArtI.js";const ge=(r,s)=>s>1&&r<s-1?"border-b border-gray-200":"",he=({data:r,presenterDescription:s="",yearToCommitteeMap:a,onNodeClick:t})=>{const m=v("(min-width: 768px)"),d=v("(min-width: 1024px)"),u=v("(min-width: 1440px)"),A=v("(min-width: 1920px)"),E=()=>A?1800:u?1400:d?1e3:720;if(!r||r.length===0)return e.jsx("div",{className:"flex w-full items-center justify-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"目前無提案資料"})});const y=E(),h={maxWidth:`${y}px`};return e.jsx(e.Fragment,{children:r.map((g,R)=>{const p=a.get(g.name),N=p!=null&&p.termNumber?`第${p.termNumber}屆`:g.name,T=(p==null?void 0:p.committeeName)??"委員會";return e.jsxs("div",{className:`mb-2 flex w-full flex-col items-start justify-center ${ge(R,r.length)} mx-auto`,style:h,children:[e.jsxs("div",{className:"flex w-full flex-col items-start justify-center",children:[e.jsx("p",{children:N}),e.jsx("p",{children:T}),s?e.jsx("div",{className:"flex w-full flex-col items-start justify-center mb-5 lg:mb-8",children:e.jsx("p",{className:"text-sm leading-relaxed text-black/80",children:s})}):null]}),e.jsx("div",{className:"w-full md:mx-auto",children:e.jsx(ae,{data:{id:g.id,name:"root",children:g.children},width:y,padding:50,onNodeClick:t})})]},g.id)})})},fe=ee(`
  query People($where: PeopleWhereUniqueInput!) {
    people(where: $where) {
      id
      name
      description
      party {
        id
        color
        name
      }
      term {
        termNumber
        id
      }
      termCount
      committees {
        id
        name
        session
        term {
          id
          startDate
          termNumber
        }
      }
    }
  }
`),L={all:["people"],details:()=>[...L.all,"detail"],detail:r=>[...L.details(),r]},ye=()=>e.jsx("div",{className:"animate-pulse",children:e.jsxs("div",{className:"md:max-w-visualization-body flex flex-col items-center gap-y-6 px-3 md:mx-auto",children:[e.jsx("div",{className:"h-4 w-24 self-start rounded bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-6 w-32 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-40 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex gap-x-4",children:[e.jsx("div",{className:"h-9 w-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-9 w-24 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"h-5 w-44 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-56 rounded bg-gray-200"})]}),e.jsx("div",{className:"w-full rounded-lg border-2 border-dashed border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-52 rounded bg-gray-200"})]})}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"flex w-full flex-col gap-y-6",children:[0,1].map(r=>e.jsxs("div",{className:"flex flex-col gap-y-3 rounded-lg border border-dashed border-gray-200 p-4",children:[e.jsx("div",{className:"h-5 w-32 rounded bg-gray-200"}),e.jsx("div",{className:"h-72 w-full rounded bg-gray-200"})]},r))})]})}),Ne=()=>e.jsx("div",{className:"animate-pulse px-3",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-5",children:[e.jsx("div",{className:"h-4 w-20 self-start rounded bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-5 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-36 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex w-full flex-col gap-y-3",children:[e.jsx("div",{className:"h-9 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-9 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-y-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-44 rounded bg-gray-200"})]}),e.jsx("div",{className:"w-full rounded-lg border-2 border-dashed border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-4 w-36 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-32 rounded bg-gray-200"})]})}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"flex w-full flex-col gap-y-5",children:[0,1].map(r=>e.jsxs("div",{className:"flex flex-col gap-y-2 rounded-lg border border-dashed border-gray-200 p-4",children:[e.jsx("div",{className:"h-4 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-64 w-full rounded bg-gray-200"})]},r))})]})}),be=({isDesktop:r})=>r?e.jsx(ye,{}):e.jsx(Ne,{}),je=(r,s,a)=>{const t={mergedParentProposals:null,historicalParentProposals:null,result:{in:[...ce]},year:{year:{equals:a}}};return r==="proposal-cosign"?{...t,OR:[{proposers:{some:{id:{equals:s}}}},{coSigners:{some:{id:{equals:s}}}}]}:{...t,proposers:{some:{id:{equals:s}}}}},ve=/(\d+)\s*年度/,we=/第(\d+)屆/,Se=r=>{var a,t;if((a=r.term)!=null&&a.startDate)return`${new Date(r.term.startDate).getFullYear()-1911+1}年度`;const s=(t=r.session)==null?void 0:t.match(ve);if(s!=null&&s[1])return`${s[1]}年度`},Ce=r=>{var a,t;if(typeof((a=r.term)==null?void 0:a.termNumber)=="number")return r.term.termNumber;const s=(t=r.session)==null?void 0:t.match(we);if(s!=null&&s[1]){const i=Number(s[1]);return Number.isNaN(i)?void 0:i}},Pe=r=>{if(!r)return new Map;const s=new Map;return r.forEach(a=>{const t=Se(a);t&&s.set(t,{committeeName:a.name??"委員會",termNumber:Ce(a)})}),s},q=r=>r?r.map(s=>s==null?void 0:s.termNumber).filter(s=>s!=null):[],Ae=(r,s)=>{const a=q(s);if(a.length>0)return[...new Set(a)].sort((i,m)=>i-m);const t=q((r==null?void 0:r.map(i=>i.term))??[]);return[...new Set(t)].sort((i,m)=>i-m)},Ee=r=>{const s=j.sumBy(r,d=>d.reductionAmount||0),a=j.sumBy(r,d=>d.freezeAmount||0),t=j.filter(r,d=>d.reductionAmount).length,i=j.filter(r,d=>d.freezeAmount).length,m=j.filter(r,d=>{var u;return(u=d.proposalTypes)==null?void 0:u.includes(re.Other)}).length;return{formattedReductionAmount:P(s),formattedFreezeAmount:P(a),reductionProposalsCount:t,freezeProposalsCount:i,mainResolutionCount:m}},Re=({personName:r,partyName:s,termNumbers:a})=>{const t=a.length?`第${a.join("、")}屆`:"";return e.jsxs("div",{className:"mt-4 flex min-w-[254px] flex-col items-center justify-center gap-y-2 border-b-2 border-black pb-3 lg:flex-row lg:items-end lg:gap-x-5",children:[e.jsx("p",{className:"text-[36px] md:text-[32px]",children:r}),e.jsx("p",{children:s}),t?e.jsxs("p",{className:"flex flex-wrap justify-center gap-x-2",children:[e.jsx("span",{className:"whitespace-nowrap",children:t}),e.jsx("span",{children:"立法委員"})]}):e.jsx("p",{children:"立法委員"})]})},Te=({selectedType:r,onChange:s,className:a})=>e.jsxs("div",{className:`flex items-center gap-x-4 ${a??""}`.trim(),children:[e.jsx("button",{className:`rounded border-2 border-black px-2.5 ${r==="proposal"?"bg-brand-primary text-white":""}`,onClick:()=>s("proposal"),children:"提案"}),e.jsx("button",{className:`rounded border-2 border-black px-2.5 ${r==="proposal-cosign"?"bg-brand-primary text-white":""}`,onClick:()=>s("proposal-cosign"),children:"提案＋連署"})]}),_e=({mode:r,onChange:s})=>e.jsx("div",{children:e.jsxs("div",{className:"mt-4 flex flex-col items-center justify-center gap-4 lg:flex-row lg:gap-6 lg:text-left",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:r==="amount",onChange:()=>s("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:r==="count",onChange:()=>s("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),ke=()=>{var Y;const{id:r}=H(),[s,a]=X(),[t,i]=c.useState("proposal"),[m,d]=c.useState("amount"),u=c.useMemo(()=>{var C;const n=s.get("year"),l=n?parseInt(n,10):NaN;if(!Number.isNaN(l))return l;const x=(C=b[0])==null?void 0:C.value,S=x?parseInt(x,10):0;return Number.isNaN(S)?0:S},[s]),A=c.useMemo(()=>b.length?b.find(n=>n.value===String(u))??b[0]:null,[u]),E=c.useCallback(n=>{n&&a({year:n.value})},[a]),y=c.useMemo(()=>je(t,r,u),[t,r,u]),{data:h,isLoading:g,isError:R}=z({queryKey:pe.list({whereFilter:y}),queryFn:()=>B(xe,{skip:0,orderBy:[{id:se.Desc}],where:y})}),p=c.useMemo(()=>h?te(h,m):[],[h,m]),{data:N,isLoading:T,isError:$}=z({queryKey:L.detail(r??""),queryFn:()=>B(fe,{where:{id:r}}),enabled:!!r}),o=N==null?void 0:N.people,w=o==null?void 0:o.committees,G=c.useMemo(()=>Pe(w),[w]),V=c.useMemo(()=>Ae(w,o==null?void 0:o.term),[w,o==null?void 0:o.term]),D=ne(h),f=c.useMemo(()=>Ee(D),[D]),{data:_}=z({queryKey:["budget","legislators",r??"all",u],queryFn:async()=>{const n=await fetch(me);if(!n.ok)throw new Error("無法載入立委預算資料");const l=await n.json(),x=ue.safeParse(l);if(!x.success)throw new Error("立委預算資料格式不符合預期");return x.data},enabled:!!r}),I=c.useMemo(()=>{var F,M;if(!_)return;const n=_.find(k=>k.yearInfo.year===u);if(!n)return;const l=((F=n.legislators)==null?void 0:F.find(k=>k.peopleId===r))??((M=n.legislators)==null?void 0:M[0]),x=t==="proposal-cosign"?(l==null?void 0:l.allInvolved)??(l==null?void 0:l.proposerOnly)??n.overall:(l==null?void 0:l.proposerOnly)??(l==null?void 0:l.allInvolved)??n.overall;if(!x)return;const S=x.reductionAmount??0,C=x.freezeAmount??0;return{formattedReductionAmount:P(S),formattedFreezeAmount:P(C),reductionCount:x.reductionCount??0,freezeCount:x.freezeCount??0,mainResolutionCount:x.otherCount??0}},[_,r,t,u]),U=c.useMemo(()=>I??{formattedReductionAmount:f.formattedReductionAmount,formattedFreezeAmount:f.formattedFreezeAmount,reductionCount:f.reductionProposalsCount,freezeCount:f.freezeProposalsCount,mainResolutionCount:f.mainResolutionCount},[I,f]),K=v("(min-width: 768px)"),O=Z(),Q=c.useCallback(n=>{var l;return!((l=n.children)!=null&&l.length)&&n.id?(O(`/budget/${n.id}`),!0):!1},[O]);return g||T?e.jsx(be,{isDesktop:K}):R||$?e.jsx("div",{children:"Error fetching data"}):e.jsx("div",{children:e.jsxs("div",{className:"md:max-w-visualization-body flex flex-col items-center justify-center px-3 md:mx-auto",children:[e.jsxs(J,{to:"/visualization",children:["<"," 回到視覺化主頁"]}),e.jsx(Re,{personName:o==null?void 0:o.name,partyName:(Y=o==null?void 0:o.party)==null?void 0:Y.name,termNumbers:V}),e.jsxs("div",{className:"mt-4 flex flex-col items-center gap-3 md:flex-row md:gap-4",children:[e.jsx(Te,{selectedType:t,onChange:i,className:"mt-1 md:mt-0"}),e.jsx("div",{className:"flex flex-wrap items-center justify-center gap-x-3 gap-y-2",children:e.jsx(le,{options:b,value:A,onChange:n=>{E(n)},"aria-label":"選擇年度",inputId:"visualization-legislator-year",variant:"year-dropdown",wrapperClassName:"w-[200px]"})})]}),e.jsx(_e,{mode:m,onChange:d}),e.jsx(oe,{summary:U}),e.jsx("div",{className:"mt-6",children:e.jsx(ie,{items:de})}),e.jsx(he,{data:p,presenterDescription:o==null?void 0:o.description,yearToCommitteeMap:G,onNodeClick:Q})]})})},$e=W(ke);export{$e as default};

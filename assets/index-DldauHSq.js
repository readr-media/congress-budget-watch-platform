import{p as e,y as $,I as U,a as c,G as Y,J as K}from"./chunk-4WY6JWTD-2Cr-QbDP.js";import{t as Q,u as P,P as W,j as L,O as V}from"./gql-Mx7Ziu-8.js";import{l as f}from"./lodash-lK2eycnc.js";import{b as j}from"./index-Ck08PhAW.js";import{C as H,h as J,m as Z,f as b,S as X,B as ee,c as se,d as re,e as ae}from"./budget-by-legislator.schema-C3Lu4TwO.js";import{p as te,e as le}from"./visualization.queries-BUVrj-cD.js";import"./helpers-DCGy3gpM.js";import"./index-CSMLMQiO.js";import"./index-CtMSh7YR.js";const oe=(s,r)=>r>1&&s<r-1?"border-b border-gray-200":"",ne=({data:s,presenterDescription:r="",yearToCommitteeMap:l,onNodeClick:o})=>{const d=j("(min-width: 768px)"),t=j("(min-width: 1024px)"),x=j("(min-width: 1440px)"),N=j("(min-width: 1920px)"),v=()=>N?1800:x?1400:t?1e3:720;if(!s||s.length===0)return e.jsx("div",{className:"flex w-full items-center justify-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"目前無提案資料"})});const p=v(),w={maxWidth:`${p}px`};return e.jsx(e.Fragment,{children:s.map((m,a)=>e.jsxs("div",{className:`mb-2 flex w-full flex-col items-start justify-center ${oe(a,s.length)} mx-auto`,style:w,children:[e.jsxs("div",{className:"flex w-full flex-col items-start justify-center",children:[e.jsx("p",{children:m.name}),e.jsx("p",{children:l.get(m.name)??"委員會"}),r?e.jsx("div",{className:"flex w-full flex-col items-start justify-center mb-5 lg:mb-8",children:e.jsx("p",{className:"text-sm leading-relaxed text-black/80",children:r})}):null]}),e.jsx("div",{className:"w-full md:mx-auto",children:e.jsx(H,{data:{id:m.id,name:"root",children:m.children},width:p,padding:50,onNodeClick:o})})]},m.id))})},de=Q(`
  query People($where: PeopleWhereUniqueInput!) {
    people(where: $where) {
      id
      name
      description
      party {
        id
        color
        name
      }
      term {
        termNumber
        id
      }
      termCount
      committees {
        id
        name
        session
        term {
          id
          startDate
          termNumber
        }
      }
    }
  }
`),S={all:["people"],details:()=>[...S.all,"detail"],detail:s=>[...S.details(),s]},ie=()=>e.jsx("div",{className:"animate-pulse",children:e.jsxs("div",{className:"md:max-w-visualization-body flex flex-col items-center gap-y-6 px-3 md:mx-auto",children:[e.jsx("div",{className:"h-4 w-24 self-start rounded bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-6 w-32 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-40 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex gap-x-4",children:[e.jsx("div",{className:"h-9 w-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-9 w-24 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"h-5 w-44 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-56 rounded bg-gray-200"})]}),e.jsx("div",{className:"w-full rounded-lg border-2 border-dashed border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-52 rounded bg-gray-200"})]})}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"flex w-full flex-col gap-y-6",children:[0,1].map(s=>e.jsxs("div",{className:"flex flex-col gap-y-3 rounded-lg border border-dashed border-gray-200 p-4",children:[e.jsx("div",{className:"h-5 w-32 rounded bg-gray-200"}),e.jsx("div",{className:"h-72 w-full rounded bg-gray-200"})]},s))})]})}),ce=()=>e.jsx("div",{className:"animate-pulse px-3",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-5",children:[e.jsx("div",{className:"h-4 w-20 self-start rounded bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-5 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-36 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex w-full flex-col gap-y-3",children:[e.jsx("div",{className:"h-9 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-9 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-y-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-44 rounded bg-gray-200"})]}),e.jsx("div",{className:"w-full rounded-lg border-2 border-dashed border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-4 w-36 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-32 rounded bg-gray-200"})]})}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"flex w-full flex-col gap-y-5",children:[0,1].map(s=>e.jsxs("div",{className:"flex flex-col gap-y-2 rounded-lg border border-dashed border-gray-200 p-4",children:[e.jsx("div",{className:"h-4 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-64 w-full rounded bg-gray-200"})]},s))})]})}),me=({isDesktop:s})=>s?e.jsx(ie,{}):e.jsx(ce,{}),ue=(s,r)=>{const l={mergedParentProposals:null,historicalParentProposals:null};return s==="proposal-cosign"?{...l,OR:[{proposers:{some:{id:{equals:r}}}},{coSigners:{some:{id:{equals:r}}}}]}:{...l,proposers:{some:{id:{equals:r}}}}},xe=s=>{if(!s)return new Map;const r=new Map;return s.forEach(l=>{var o;if((o=l.term)!=null&&o.startDate){const d=new Date(l.term.startDate).getFullYear()-1911+1;r.set(`${d}年度`,l.name??"委員會")}}),r},_=s=>s?s.map(r=>r==null?void 0:r.termNumber).filter(r=>r!=null):[],pe=(s,r)=>{if(!s&&!r)return[];const l=_((s==null?void 0:s.map(d=>d.term))??[]),o=_(r);return[...new Set([...l,...o])].sort((d,t)=>d-t)},he=s=>{const r=f.sumBy(s,t=>t.reductionAmount||0),l=f.sumBy(s,t=>t.freezeAmount||0),o=f.filter(s,t=>t.reductionAmount).length,u=f.filter(s,t=>t.freezeAmount).length,d=f.filter(s,t=>{var x;return(x=t.proposalTypes)==null?void 0:x.includes(W.Other)}).length;return{formattedReductionAmount:b(r),formattedFreezeAmount:b(l),reductionProposalsCount:o,freezeProposalsCount:u,mainResolutionCount:d}},ge=({personName:s,partyName:r,termNumbers:l})=>{const o=l.length?`第${l.join("、")}屆`:"";return e.jsxs("div",{className:"mt-4 flex min-w-[254px] flex-col items-center justify-center gap-y-2 border-b-2 border-black pb-3 lg:flex-row lg:items-end lg:gap-x-5",children:[e.jsx("p",{className:"text-[36px] md:text-[32px]",children:s}),e.jsx("p",{children:r}),o?e.jsxs("p",{className:"flex flex-wrap justify-center gap-x-2",children:[e.jsx("span",{className:"whitespace-nowrap",children:o}),e.jsx("span",{children:"立法委員"})]}):e.jsx("p",{children:"立法委員"})]})},fe=({selectedType:s,onChange:r})=>e.jsxs("div",{className:"mt-6 flex items-center gap-x-4",children:[e.jsx("button",{className:`rounded border-2 border-black px-2.5 ${s==="proposal"?"bg-brand-primary text-white":""}`,onClick:()=>r("proposal"),children:"提案"}),e.jsx("button",{className:`rounded border-2 border-black px-2.5 ${s==="proposal-cosign"?"bg-brand-primary text-white":""}`,onClick:()=>r("proposal-cosign"),children:"提案＋連署"})]}),je=({mode:s,onChange:r})=>e.jsx("div",{children:e.jsxs("div",{className:"mt-4 flex flex-col items-center justify-center gap-4 lg:flex-row lg:gap-6 lg:text-left",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:s==="amount",onChange:()=>r("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:s==="count",onChange:()=>r("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),ye=()=>{var z;const{id:s}=U(),[r,l]=c.useState("proposal"),[o,u]=c.useState("amount"),d=c.useMemo(()=>ue(r,s),[r,s]),{data:t,isLoading:x,isError:N}=P({queryKey:te.list({whereFilter:d}),queryFn:()=>L(le,{skip:0,take:1e3,orderBy:[{id:V.Desc}],where:d})}),v=c.useMemo(()=>t?J(t,o):[],[t,o]),{data:p,isLoading:w,isError:m}=P({queryKey:S.detail(s??""),queryFn:()=>L(de,{where:{id:s}}),enabled:!!s}),a=p==null?void 0:p.people,y=a==null?void 0:a.committees,M=c.useMemo(()=>xe(y),[y]),E=c.useMemo(()=>pe(y,a==null?void 0:a.term),[y,a==null?void 0:a.term]),A=Z(t),h=c.useMemo(()=>he(A),[A]),{data:C}=P({queryKey:["budget","legislators",s??"all"],queryFn:async()=>{const i=await fetch(re);if(!i.ok)throw new Error("無法載入立委預算資料");return ae.parse(await i.json())},enabled:!!s}),T=c.useMemo(()=>{var R,D;if(!C)return;const i=C[0];if(!i)return;const n=((R=i.legislators)==null?void 0:R.find(G=>G.peopleId===s))??((D=i.legislators)==null?void 0:D[0]),g=r==="proposal-cosign"?(n==null?void 0:n.allInvolved)??(n==null?void 0:n.proposerOnly)??i.overall:(n==null?void 0:n.proposerOnly)??(n==null?void 0:n.allInvolved)??i.overall;if(!g)return;const q=g.reductionAmount??0,O=g.freezeAmount??0;return{formattedReductionAmount:b(q),formattedFreezeAmount:b(O),reductionCount:g.reductionCount??0,freezeCount:g.freezeCount??0,mainResolutionCount:g.otherCount??0}},[C,s,r]),F=c.useMemo(()=>T??{formattedReductionAmount:h.formattedReductionAmount,formattedFreezeAmount:h.formattedFreezeAmount,reductionCount:h.reductionProposalsCount,freezeCount:h.freezeProposalsCount,mainResolutionCount:h.mainResolutionCount},[T,h]),B=j("(min-width: 768px)"),k=Y(),I=c.useCallback(i=>{var n;return!((n=i.children)!=null&&n.length)&&i.id?(k(`/budget/${i.id}`),!0):!1},[k]);return x||w?e.jsx(me,{isDesktop:B}):N||m?e.jsx("div",{children:"Error fetching data"}):e.jsx("div",{children:e.jsxs("div",{className:"md:max-w-visualization-body flex flex-col items-center justify-center px-3 md:mx-auto",children:[e.jsxs(K,{to:"/visualization",children:["<"," 回到視覺化主頁"]}),e.jsx(ge,{personName:a==null?void 0:a.name,partyName:(z=a==null?void 0:a.party)==null?void 0:z.name,termNumbers:E}),e.jsx(fe,{selectedType:r,onChange:l}),e.jsx(je,{mode:o,onChange:u}),e.jsx(X,{summary:F}),e.jsx("div",{className:"mt-6",children:e.jsx(ee,{items:se})}),e.jsx(ne,{data:v,presenterDescription:a==null?void 0:a.description,yearToCommitteeMap:M,onNodeClick:I})]})})},ke=$(ye);export{ke as default};

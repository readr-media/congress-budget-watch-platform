import{a,p as e,H as he,y as fe}from"./chunk-FGUA77HG-dksgsGW9.js";import{t as le,G as pe,f as T,C as ne,S as xe,B as ye,a as je,m as se,u as X,b as be,c as ve,d as we,o as H,n as B,s as J,e as ie,g as Ce}from"./budget-by-legislator.schema-lyFuB5fd.js";import{B as Ne}from"./budget-detail-skeleton-D4wn77XC.js";import{S as W,Y as re}from"./react-select.esm-B0JbKfUD.js";import{u as ee,P as Se,V as ae,q as Ae,l as ze,j as De}from"./gql-Cne1VORc.js";import{l as Y}from"./floating-ui.dom-BXm6EoQS.js";import{b as Le}from"./index-BJnc-sEt.js";import{p as Ee,f as Me}from"./visualization.queries-Bp5_Fv1-.js";import"./index-C1D2B4eN.js";import"./index-BAl1NSbH.js";import"./helpers-CS5YjK4-.js";import"./hoist-non-react-statics.cjs-DySuCaBR.js";const ke=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],te=a.forwardRef((t,i)=>e.jsx("div",{className:"w-60",children:e.jsx(W,{ref:i,options:ke,...t})}));te.displayName="VisualizationSelector";const Be=({activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(te,{options:d,value:m,onChange:g=>{g&&u(g)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),Re=({activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u,isShowingAll:g,onToggleShowAll:c,legislatorOptions:s,selectedLegislator:n,onLegislatorChange:h,departmentOptions:j,selectedDepartment:w,onDepartmentChange:v})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:c,className:`rounded px-2.5 transition-colors ${g?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(te,{options:d,value:m,onChange:f=>{f&&u(f)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!g&&t==="legislator"&&(s.length>0?e.jsx(W,{className:"w-full",value:n,options:s,onChange:f=>{h(f??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!g&&t==="department"&&(j.length>0?e.jsx(W,{className:"w-full",value:w,options:j,onChange:f=>{v(f??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),Pe=t=>{var i;return(i=t.children)!=null&&i.length?t.depth===0?26:22:18},Z=.45,oe=({data:t,width:i=928,height:d,onNodeClick:m,mode:u,transformedData:g,padding:c,selectedDepartmentCategorizedData:s,selectedDepartmentTitle:n,showSelectedDepartmentChart:h})=>{const j=a.useMemo(()=>g??le(t,u),[t,u,g]),w=a.useMemo(()=>c??Pe,[c]),v=a.useMemo(()=>{if(!s)return null;const p=Object.values(s).flatMap(b=>b.children??[]);if(!p.length)return null;const S=new Map;return p.forEach(b=>{var F;const x=[b.proposerId??b.name??"unknown",b.proposalType??"unknown-type"].join("-"),k=((F=b.name)==null?void 0:F.split(`
`)[0])??b.name??"無名提案者",R=b.value??0,P=R>0?Math.pow(R,1/Z):0,I=pe[b.proposalType]??"",V=S.get(x);if(V){const A=V.totalAmount+P;S.set(x,{totalAmount:A,node:{...V.node,name:`${k}
${I}
${T(A)}`,value:Math.pow(A,Z)}})}else S.set(x,{totalAmount:P,node:{...b,id:`merged-${x}`,name:`${k}
${I}
${T(P)}`,value:Math.pow(P,Z)}})}),Array.from(S.values()).map(b=>b.node)},[s]),f=a.useMemo(()=>!v||!h?null:{id:`selected-department-${n??"selected"}`,name:n??"目前部會",children:v},[v,n,h]),L=Object.keys(j),D=f;return L.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:i},children:"無符合資料"}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-y-8",children:[D&&e.jsxs("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:[e.jsx("p",{className:"text-xl",children:"看全部"}),e.jsx(ne,{data:D,width:i,height:d??i,padding:w,onNodeClick:m})]},"selected-department-highlight"),Object.entries(j).map(([p,S])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:S.children&&S.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:p}),e.jsx(ne,{data:S,width:i,height:d??i,padding:w,onNodeClick:m})]})},p))]})},Ie=({mode:t,onModeChange:i})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:t==="amount",onChange:()=>i("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:t==="count",onChange:()=>i("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),Ve=({departmentOptions:t,selectedDepartmentOption:i,onDepartmentChange:d})=>t.length===0?e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"})}):e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx(W,{className:"w-full md:max-w-xl",value:i,options:t,onChange:m=>{d(m??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department-desktop"})}),Fe=({activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u,mode:g,onModeChange:c,isShowingAll:s,onToggleShowAll:n,legislatorOptions:h,selectedLegislatorOption:j,onLegislatorChange:w,departmentOptions:v,selectedDepartmentOption:f,onDepartmentChange:L,isDesktop:D,isLoading:p,chartContainerRef:S,chartWidth:b,chartHeight:x,visualizationData:k,legislatorVisualizationData:R,legislatorSummary:P,departmentSummary:I,legislatorPadding:V,selectedDepartmentCategorizedData:F,selectedDepartmentTitle:A,showSelectedDepartmentChart:M,onNodeClick:C})=>{const q=D&&t==="department",O=t==="department"&&k,_=t==="legislator"&&R;return p?e.jsx(Ne,{isDesktop:D}):e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Be,{activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u}),e.jsx(Re,{activeTab:t,onTabChange:i,yearOptions:d,selectedYear:m,onYearChange:u,isShowingAll:s,onToggleShowAll:n,legislatorOptions:h,selectedLegislator:j,onLegislatorChange:w,departmentOptions:v,selectedDepartment:f,onDepartmentChange:L}),e.jsx(Ie,{mode:g,onModeChange:c}),e.jsx(xe,{summary:t==="legislator"?P:I}),q&&e.jsx(Ve,{departmentOptions:v,selectedDepartmentOption:f,onDepartmentChange:L}),e.jsx(ye,{items:je}),e.jsxs("div",{ref:S,className:"chart-container",children:[_&&e.jsx(oe,{data:k,transformedData:R,padding:V,onNodeClick:C,width:b,height:x,mode:g}),O&&e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"aspect-video md:aspect-video lg:aspect-video",children:e.jsx(oe,{data:k,onNodeClick:C,width:b,height:x,mode:g,selectedDepartmentCategorizedData:F,selectedDepartmentTitle:A??null,showSelectedDepartmentChart:M})})})]})]})})},Te=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),_e=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),$e=({isDesktop:t})=>t?e.jsx(Te,{}):e.jsx(_e,{}),Oe=()=>{const d=Math.round(225),[m,u]=a.useState(d),[g,c]=a.useState(300),s=a.useRef(null);return{ref:a.useCallback(h=>{if(s.current&&s.current.disconnect(),!h)return;const w=requestAnimationFrame(()=>{const v=h.getBoundingClientRect().width;v<=0||(c(v),u(Math.round(v*.75)))});return s.current=new ResizeObserver(v=>{const f=v[0];if(!f)return;const L=f.contentRect.width;c(L),u(Math.round(L*.75))}),s.current.observe(h),()=>{cancelAnimationFrame(w)}},[]),width:g,height:m}};var ue=(t=>(t.Legislator="legislator",t.Department="department",t))(ue||{}),ce=(t=>(t.Amount="amount",t.Count="count",t))(ce||{});const qe=()=>{const[t,i]=a.useState(ue.Legislator),[d,m]=a.useState(ce.Amount),[u,g]=a.useState(re[0]),[c,s]=a.useState(null),[n,h]=a.useState(null),j=a.useRef(null),w=a.useRef(null),[v,f]=a.useState(!0),[L,D]=a.useState(!0),p=Le("(min-width: 768px)"),S=!p,b=a.useCallback(()=>({year:{year:{equals:parseInt(u.value,10)}},mergedParentProposals:null,historicalParentProposals:null,result:{equals:"passed"}}),[u.value]),{data:x,isLoading:k,isError:R}=ee({queryKey:Ee.paginated(b(),parseInt(u.value,10)),queryFn:()=>De(Me,{where:b()}),placeholderData:ze}),P=a.useCallback(r=>{if(i(r),!p){if(r==="legislator"){f(!0);return}D(!0)}},[p]);a.useEffect(()=>{p&&(s(null),h(null),f(!0),D(!0))},[p]);const I=a.useCallback(r=>{g(r)},[]),V=a.useCallback(r=>{s(r),f(!1),r&&(j.current=r)},[]),F=a.useCallback(r=>{h(r),D(!1),r&&(w.current=r)},[]),A=a.useMemo(()=>se(x),[x]),M=a.useMemo(()=>{const r=new Map;return A.forEach(l=>{var E;const o=(E=l.proposers)==null?void 0:E[0],N=(o==null?void 0:o.id)??(o==null?void 0:o.name)??"",y=(o==null?void 0:o.name)??"未命名立委";N&&r.set(N,{value:N,label:y})}),Array.from(r.values()).sort((l,o)=>l.label.localeCompare(o.label,"zh-Hant"))},[A]),C=a.useMemo(()=>{const r=new Map;return A.forEach(l=>{var y,E;const o=(E=(y=l.government)==null?void 0:y.category)==null?void 0:E.trim(),N=o&&o.length>0?o:"未分類";r.set(N,{value:N,label:N})}),Array.from(r.values()).sort((l,o)=>l.label.localeCompare(o.label,"zh-Hant"))},[A]),q=a.useCallback(()=>{t==="legislator"?c?(j.current=c,s(null),f(!1)):j.current?(s(j.current),f(!1)):M.length>0&&(s(M[0]),f(!1)):t==="department"&&(n?(w.current=n,h(null),D(!1)):w.current?(h(w.current),D(!1)):C.length>0&&(h(C[0]),D(!1)))},[t,c,n,M,C]),O=a.useCallback(r=>{const l=r==null?void 0:r.trim();return l&&l.length>0?l:"未分類"},[]),_=a.useMemo(()=>{if(p||t!=="legislator"||!c)return null;const r=A.filter(l=>{var y;const o=(y=l.proposers)==null?void 0:y[0];return((o==null?void 0:o.id)??(o==null?void 0:o.name)??"")===c.value}).map(l=>l.id).filter(l=>!!l);return new Set(r)},[t,A,p,c]),G=a.useMemo(()=>{if(t!=="department"||!n)return null;const r=A.filter(l=>{var y,E;const o=(E=(y=l.government)==null?void 0:y.category)==null?void 0:E.trim();return(o&&o.length>0?o:"未分類")===n.value}).map(l=>l.id).filter(l=>!!l);return new Set(r)},[t,A,n]),K=a.useMemo(()=>{var o;if(!x||t!=="department"||!n||!n.value)return null;const r=((o=x.proposals)==null?void 0:o.filter(N=>{var U;if(!N)return!1;const y=X(ae,N);return O(((U=y.government)==null?void 0:U.category)??null)===n.value}))??[];if(!r.length)return null;const l={...x,proposals:r};return le(l,d)},[t,x,d,O,n]);a.useEffect(()=>{S&&(t==="legislator"?c&&M.some(l=>l.value===c.value)||(v&&M.length>0?s(M[0]):c&&s(null)):t==="department"&&(n&&C.some(l=>l.value===n.value)||(L&&C.length>0?h(C[0]):n&&h(null))))},[t,C,S,M,n,c,L,v]),a.useEffect(()=>{if(!p||t!=="department")return;!(n&&C.some(l=>l.value===n.value))&&C.length>0&&(h(C[0]),D(!1))},[t,C,p,n]);const z=a.useMemo(()=>{var o;if(!x)return null;let r=null;if(t==="legislator"&&_?r=_:t==="department"&&G&&(r=G),!r)return x;const l=((o=x.proposals)==null?void 0:o.filter(N=>{if(!N)return!1;const y=X(ae,N),U=X(Ae,y).id;return U!=null&&(r==null?void 0:r.has(U))}))??[];return{...x,proposals:l}},[t,x,G,_]),$=z??x??null,Q=a.useMemo(()=>{const r=se(z),l=Y.filter(r,y=>y.reductionAmount&&y.reductionAmount>0),o=Y.filter(r,y=>y.freezeAmount&&y.freezeAmount>0),N=Y.filter(r,y=>{var E;return(E=y.proposalTypes)==null?void 0:E.includes(Se.Other)});return{totalReductionAmount:Y.sumBy(l,"reductionAmount"),reductionCount:l.length,totalFreezeAmount:Y.sumBy(o,"freezeAmount"),freezeCount:o.length,mainResolutionCount:N.length}},[z]),de=T(Q.totalReductionAmount),me=T(Q.totalFreezeAmount),ge=a.useMemo(()=>z?be(z,d):null,[z,d]);return{activeTab:t,handleTabChange:P,mode:d,setMode:m,selectedYear:u,handleYearChange:I,yearOptions:re,legislatorOptions:M,selectedLegislatorOption:c,handleLegislatorChange:V,departmentOptions:C,selectedDepartmentOption:n,handleDepartmentChange:F,handleToggleShowAll:q,isShowingAll:t==="legislator"&&!c||t==="department"&&!n,isDesktop:p,isMobile:S,isLoading:k,isError:R,rawData:x,visualizationData:$,legislatorVisualizationData:ge,summaryStats:Q,formattedReductionAmount:de,formattedFreezeAmount:me,selectedDepartmentCategorizedData:K}},Ge=({selectedLegislatorOption:t,activeTab:i})=>{const d=["budget","legislators",(t==null?void 0:t.value)??"all"],m=async()=>{const n=await fetch(ve);if(!n.ok)throw new Error("無法載入立委預算資料");return we.parse(await n.json())},{data:u,isLoading:g,isError:c}=ee({queryKey:d,queryFn:m,enabled:i==="legislator"}),s=a.useMemo(()=>{var w;const n=(w=u==null?void 0:u[0])==null?void 0:w.overall,h=(n==null?void 0:n.reductionAmount)??0,j=(n==null?void 0:n.freezeAmount)??0;return{formattedReductionAmount:T(h),formattedFreezeAmount:T(j),reductionCount:(n==null?void 0:n.reductionCount)??0,freezeCount:(n==null?void 0:n.freezeCount)??0,mainResolutionCount:(n==null?void 0:n.otherCount)??0}},[u]);return{legislatorBudgetSummaryData:u,legislatorSummary:s,isLegislatorBudgetLoading:g,isLegislatorBudgetError:c}},Ue=H({budgetYearId:J(),year:B()}),Ye=H({reductionAmount:B(),reductionCount:B(),freezeAmount:B(),freezeCount:B(),otherCount:B()}),We=H({governmentId:J(),name:J(),reductionAmount:B(),reductionCount:B(),freezeAmount:B(),freezeCount:B(),otherCount:B()}),He=H({yearInfo:Ue,overall:Ye,departments:ie(We)}),Ke=ie(He),Qe=({activeTab:t})=>{const i=async()=>{const s=await fetch(Ce);if(!s.ok)throw new Error("無法載入部會預算資料");return Ke.parse(await s.json())},d=["budget","departments"],{data:m,isLoading:u,isError:g}=ee({queryKey:d,queryFn:i,enabled:t==="department"}),c=a.useMemo(()=>{var j;const s=(j=m==null?void 0:m[0])==null?void 0:j.overall,n=(s==null?void 0:s.reductionAmount)??0,h=(s==null?void 0:s.freezeAmount)??0;return{formattedReductionAmount:T(n),formattedFreezeAmount:T(h),reductionCount:(s==null?void 0:s.reductionCount)??0,freezeCount:(s==null?void 0:s.freezeCount)??0,mainResolutionCount:(s==null?void 0:s.otherCount)??0}},[m]);return{departmentBudgetSummaryData:m,departmentSummary:c,isDepartmentBudgetLoading:u,isDepartmentBudgetError:g}},Xe=({children:t})=>{const{ref:i,width:d,height:m}=Oe(),u=he(),{activeTab:g,handleTabChange:c,mode:s,setMode:n,selectedYear:h,handleYearChange:j,yearOptions:w,legislatorOptions:v,selectedLegislatorOption:f,handleLegislatorChange:L,departmentOptions:D,selectedDepartmentOption:p,handleDepartmentChange:S,handleToggleShowAll:b,isShowingAll:x,isDesktop:k,isLoading:R,isError:P,visualizationData:I,legislatorVisualizationData:V,selectedDepartmentCategorizedData:F}=qe(),{legislatorSummary:A,isLegislatorBudgetLoading:M,isLegislatorBudgetError:C}=Ge({selectedLegislatorOption:f,activeTab:g}),{departmentSummary:q,isDepartmentBudgetLoading:O,isDepartmentBudgetError:_}=Qe({activeTab:g}),G=a.useMemo(()=>{if(s==="amount")return z=>{var $;return($=z.children)!=null&&$.length?z.depth===0?20:z.depth===1?36:18:10}},[s]),K=a.useCallback(z=>{var $;return z.proposalId?(u(`/budget/${z.proposalId}`),!0):z.proposerId&&!(($=z.children)!=null&&$.length)?(u(`/visualization/legislator/${z.proposerId}`),!0):!1},[u]);return R||M||O?e.jsx($e,{isDesktop:k}):P||C||_?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):I?t({activeTab:g,onTabChange:c,yearOptions:w,selectedYear:h,onYearChange:j,mode:s,onModeChange:n,isShowingAll:x,onToggleShowAll:b,legislatorOptions:v,selectedLegislatorOption:f,onLegislatorChange:L,departmentOptions:D,selectedDepartmentOption:p,onDepartmentChange:S,isDesktop:k,isLoading:R,chartContainerRef:i,chartWidth:d,chartHeight:m,visualizationData:I,legislatorVisualizationData:V,legislatorSummary:A,departmentSummary:q,legislatorPadding:G,selectedDepartmentCategorizedData:F,selectedDepartmentTitle:(p==null?void 0:p.label)??null,showSelectedDepartmentChart:!!F,onNodeClick:K}):null},Ze=()=>e.jsx(Xe,{children:t=>e.jsx(Fe,{...t})}),mt=fe(Ze);export{mt as default};

import{a as n,p as e,H as ue,y as ce}from"./chunk-WWGJGFF6-C1k8rglg.js";import{t as le,G as de,f as G,C as ee,S as me,B as he,a as ge,m as fe,g as te,u as Q,b as pe,c as xe,d as ye,e as je,h as be}from"./budget-endpoints-ChSdjAmF.js";import{B as ve}from"./budget-detail-skeleton-CmpMzIYN.js";import{S as H}from"./react-select.esm-CLkMQovX.js";import{u as Z,V as re,q as we,l as Ce,j as Ne}from"./gql-CryelyAX.js";import{Y as ae}from"./floating-ui.dom-KgpTsM_O.js";import"./helpers-DQxArCU3.js";import{b as Se}from"./index-DrVPcFH7.js";import{p as De,f as Ae}from"./visualization.queries-BVSP8xBb.js";import"./index-CeHjcr3Z.js";import"./index-SkmILjJ3.js";import"./hoist-non-react-statics.cjs-1LUWegar.js";const Le=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],J=n.forwardRef((t,u)=>e.jsx("div",{className:"w-60",children:e.jsx(H,{ref:u,options:Le,...t})}));J.displayName="VisualizationSelector";var q=(t=>(t.Legislator="legislator",t.Department="department",t))(q||{}),oe=(t=>(t.Amount="amount",t.Count="count",t))(oe||{});const Ee=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>u(q.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>u(q.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(J,{options:h,value:g,onChange:m=>{m&&p(m)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),ze=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p,isShowingAll:m,onToggleShowAll:c,legislatorOptions:a,selectedLegislator:o,onLegislatorChange:i,departmentOptions:x,selectedDepartment:v,onDepartmentChange:y})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:c,className:`rounded px-2.5 transition-colors ${m?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>u(q.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>u(q.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(J,{options:h,value:g,onChange:s=>{s&&p(s)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!m&&t==="legislator"&&(a.length>0?e.jsx(H,{className:"w-full",value:o,options:a,onChange:s=>{i(s??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!m&&t==="department"&&(x.length>0?e.jsx(H,{className:"w-full",value:v,options:x,onChange:s=>{y(s??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),ke=t=>{var u;return(u=t.children)!=null&&u.length?t.depth===0?26:22:18},X=.45,se=({data:t,width:u=928,height:h,onNodeClick:g,mode:p,transformedData:m,padding:c,selectedDepartmentCategorizedData:a,selectedDepartmentTitle:o,showSelectedDepartmentChart:i})=>{const x=n.useMemo(()=>m??le(t,p),[t,p,m]),v=n.useMemo(()=>c??ke,[c]),y=n.useMemo(()=>{if(!a)return null;const j=Object.values(a).flatMap(w=>w.children??[]);if(!j.length)return null;const L=new Map;return j.forEach(w=>{var F;const f=[w.proposerId??w.name??"unknown",w.proposalType??"unknown-type"].join("-"),I=((F=w.name)==null?void 0:F.split(`
`)[0])??w.name??"無名提案者",V=w.value??0,z=V>0?Math.pow(V,1/X):0,k=de[w.proposalType]??"",M=L.get(f);if(M){const S=M.totalAmount+z;L.set(f,{totalAmount:S,node:{...M.node,name:`${I}
${k}
${G(S)}`,value:Math.pow(S,X)}})}else L.set(f,{totalAmount:z,node:{...w,id:`merged-${f}`,name:`${I}
${k}
${G(z)}`,value:Math.pow(z,X)}})}),Array.from(L.values()).map(w=>w.node)},[a]),s=n.useMemo(()=>!y||!i?null:{id:`selected-department-${o??"selected"}`,name:o??"目前部會",children:y},[y,o,i]),b=Object.keys(x),N=s;return b.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:u},children:"無符合資料"}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-y-8",children:[N&&e.jsxs("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:[e.jsx("p",{className:"text-xl",children:"看全部"}),e.jsx(ee,{data:N,width:u,height:h??u,padding:v,onNodeClick:g})]},"selected-department-highlight"),Object.entries(x).map(([j,L])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:L.children&&L.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:j}),e.jsx(ee,{data:L,width:u,height:h??u,padding:v,onNodeClick:g})]})},j))]})},Me=({mode:t,onModeChange:u})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:t==="amount",onChange:()=>u("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:t==="count",onChange:()=>u("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),Be=({departmentOptions:t,selectedDepartmentOption:u,onDepartmentChange:h})=>t.length===0?e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"})}):e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx(H,{className:"w-full md:max-w-xl",value:u,options:t,onChange:g=>{h(g??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department-desktop"})}),Pe=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p,mode:m,onModeChange:c,isShowingAll:a,onToggleShowAll:o,legislatorOptions:i,selectedLegislatorOption:x,onLegislatorChange:v,departmentOptions:y,selectedDepartmentOption:s,onDepartmentChange:b,isDesktop:N,isLoading:j,legislatorChartContainerRef:L,legislatorChartWidth:w,legislatorChartHeight:f,departmentChartContainerRef:I,departmentChartWidth:V,departmentChartHeight:z,visualizationData:k,legislatorVisualizationData:M,legislatorSummary:F,departmentSummary:S,legislatorPadding:E,selectedDepartmentCategorizedData:D,selectedDepartmentTitle:U,showSelectedDepartmentChart:T,onNodeClick:_})=>{const O=N&&t==="department",W=t==="department"&&k,$=t==="legislator"&&M;return j?e.jsx(ve,{isDesktop:N}):e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Ee,{activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p}),e.jsx(ze,{activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p,isShowingAll:a,onToggleShowAll:o,legislatorOptions:i,selectedLegislator:x,onLegislatorChange:v,departmentOptions:y,selectedDepartment:s,onDepartmentChange:b}),e.jsx(Me,{mode:m,onModeChange:c}),e.jsx(me,{summary:t==="legislator"?F:S}),O&&e.jsx(Be,{departmentOptions:y,selectedDepartmentOption:s,onDepartmentChange:b}),e.jsx(he,{items:ge}),$&&e.jsx("div",{ref:L,className:"chart-container",children:e.jsx(se,{data:k,transformedData:M,padding:E,onNodeClick:_,width:w,height:f,mode:m},"legislator-chart")}),W&&e.jsx("div",{ref:I,className:"chart-container",children:e.jsx(se,{data:k,onNodeClick:_,width:V,height:z,mode:m,selectedDepartmentCategorizedData:D,selectedDepartmentTitle:U??null,showSelectedDepartmentChart:T},"department-chart")})]})})},Re=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Ie=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Ve=({isDesktop:t})=>t?e.jsx(Re,{}):e.jsx(Ie,{}),ne=()=>{const h=Math.round(225),[g,p]=n.useState(h),[m,c]=n.useState(300),a=n.useRef(null);return{ref:n.useCallback(i=>{if(a.current&&a.current.disconnect(),!i)return;const v=requestAnimationFrame(()=>{const y=i.getBoundingClientRect().width;y<=0||(c(y),p(Math.round(y*.75)))});return a.current=new ResizeObserver(y=>{const s=y[0];if(!s)return;const b=s.contentRect.width;c(b),p(Math.round(b*.75))}),a.current.observe(i),()=>{cancelAnimationFrame(v)}},[]),width:m,height:g}},Fe=()=>{const[t,u]=n.useState(q.Legislator),[h,g]=n.useState(oe.Amount),[p,m]=n.useState(ae[0]),[c,a]=n.useState(null),[o,i]=n.useState(null),x=n.useRef(null),v=n.useRef(null),[y,s]=n.useState(!0),[b,N]=n.useState(!0),j=Se("(min-width: 768px)"),L=!j,w=n.useCallback(()=>({year:{year:{equals:parseInt(p.value,10)}},mergedParentProposals:null,historicalParentProposals:null,result:{equals:"passed"}}),[p.value]),{data:f,isLoading:I,isError:V}=Z({queryKey:De.paginated(w(),parseInt(p.value,10)),queryFn:()=>Ne(Ae,{where:w()}),placeholderData:Ce}),z=n.useCallback(r=>{if(u(r),!j){if(r==="legislator"){s(!0);return}N(!0)}},[j]);n.useEffect(()=>{j&&(a(null),i(null),s(!0),N(!0))},[j]);const k=n.useCallback(r=>{m(r)},[]),M=n.useCallback(r=>{a(r),s(!1),r&&(x.current=r)},[]),F=n.useCallback(r=>{i(r),N(!1),r&&(v.current=r)},[]),S=n.useMemo(()=>fe(f),[f]),E=n.useMemo(()=>{const r=new Map;return S.forEach(l=>{var A;((A=l.proposers)!=null&&A.length?l.proposers:[]).forEach((C,P)=>{const R=te(C,l.id,P);if(!R)return;const ie=(C==null?void 0:C.name)??"未命名立委";r.has(R)||r.set(R,{value:R,label:ie})})}),Array.from(r.values()).sort((l,d)=>l.label.localeCompare(d.label,"zh-Hant"))},[S]),D=n.useMemo(()=>{const r=new Map;return S.forEach(l=>{var C,P;const d=(P=(C=l.government)==null?void 0:C.category)==null?void 0:P.trim(),A=d&&d.length>0?d:"未分類";r.set(A,{value:A,label:A})}),Array.from(r.values()).sort((l,d)=>l.label.localeCompare(d.label,"zh-Hant"))},[S]),U=n.useCallback(()=>{t==="legislator"?c?(x.current=c,a(null),s(!1)):x.current?(a(x.current),s(!1)):E.length>0&&(a(E[0]),s(!1)):t==="department"&&(o?(v.current=o,i(null),N(!1)):v.current?(i(v.current),N(!1)):D.length>0&&(i(D[0]),N(!1)))},[t,c,o,E,D]),T=n.useCallback(r=>{const l=r==null?void 0:r.trim();return l&&l.length>0?l:"未分類"},[]),_=n.useMemo(()=>{if(j||t!=="legislator"||!c)return null;const r=S.filter(l=>{const d=l.proposers??[];return d.length===0?!1:d.some((A,C)=>te(A,l.id,C)===c.value)}).map(l=>l.id).filter(l=>!!l);return new Set(r)},[t,S,j,c]),O=n.useMemo(()=>{if(t!=="department"||!o)return null;const r=S.filter(l=>{var C,P;const d=(P=(C=l.government)==null?void 0:C.category)==null?void 0:P.trim();return(d&&d.length>0?d:"未分類")===o.value}).map(l=>l.id).filter(l=>!!l);return new Set(r)},[t,S,o]),W=n.useMemo(()=>{var d;if(!f||t!=="department"||!o||!o.value)return null;const r=((d=f.proposals)==null?void 0:d.filter(A=>{var R;if(!A)return!1;const C=Q(re,A);return T(((R=C.government)==null?void 0:R.category)??null)===o.value}))??[];if(!r.length)return null;const l={...f,proposals:r};return le(l,h)},[t,f,h,T,o]);n.useEffect(()=>{L&&(t==="legislator"?c&&E.some(l=>l.value===c.value)||(y&&E.length>0?a(E[0]):c&&a(null)):t==="department"&&(o&&D.some(l=>l.value===o.value)||(b&&D.length>0?i(D[0]):o&&i(null))))},[t,D,L,E,o,c,b,y]),n.useEffect(()=>{if(!j||t!=="department")return;!(o&&D.some(l=>l.value===o.value))&&D.length>0&&(i(D[0]),N(!1))},[t,D,j,o]);const $=n.useMemo(()=>{var d;if(!f)return null;let r=null;if(t==="legislator"&&_?r=_:t==="department"&&O&&(r=O),!r)return f;const l=((d=f.proposals)==null?void 0:d.filter(A=>{if(!A)return!1;const C=Q(re,A),R=Q(we,C).id;return R!=null&&(r==null?void 0:r.has(R))}))??[];return{...f,proposals:l}},[t,f,O,_]),Y=$??f??null,K=n.useMemo(()=>{if(!$)return null;const r=pe($,h);if(!(!j&&t==="legislator"&&c))return r;const d=r[""];if(!(d!=null&&d.children))return r;const A=d.children.filter(C=>C.proposerId===c.value||C.proposerKey===c.value);return{...r,"":{...d,children:A}}},[t,$,j,h,c]);return{activeTab:t,handleTabChange:z,mode:h,setMode:g,selectedYear:p,handleYearChange:k,yearOptions:ae,legislatorOptions:E,selectedLegislatorOption:c,handleLegislatorChange:M,departmentOptions:D,selectedDepartmentOption:o,handleDepartmentChange:F,handleToggleShowAll:U,isShowingAll:t==="legislator"&&!c||t==="department"&&!o,isDesktop:j,isMobile:L,isLoading:I,isError:V,rawData:f,visualizationData:Y,legislatorVisualizationData:K,selectedDepartmentCategorizedData:W}},_e=({selectedLegislatorOption:t,activeTab:u,isShowingAll:h})=>{const g=["budget","legislators"],p=async()=>{const i=await fetch(xe);if(!i.ok)throw new Error("無法載入立委預算資料");const x=await i.json(),v=ye.safeParse(x);if(!v.success)throw new Error("立委預算資料格式不符合預期");return v.data},{data:m,isLoading:c,isError:a}=Z({queryKey:g,queryFn:p,enabled:u==="legislator"}),o=n.useMemo(()=>{var y;const i=m==null?void 0:m[0],x=i==null?void 0:i.overall,v=s=>{const b=(s==null?void 0:s.reductionAmount)??0,N=(s==null?void 0:s.freezeAmount)??0;return{formattedReductionAmount:G(b),formattedFreezeAmount:G(N),reductionCount:(s==null?void 0:s.reductionCount)??0,freezeCount:(s==null?void 0:s.freezeCount)??0,mainResolutionCount:(s==null?void 0:s.otherCount)??0}};if(u===q.Legislator&&!h&&t&&((y=i==null?void 0:i.legislators)!=null&&y.length)){const s=i.legislators.find(b=>b.peopleId===t.value)??i.legislators.find(b=>b.name===t.label);if(s){const b=s.allInvolved??s.proposerOnly;return v(b)}}return v(x)},[u,h,m,t]);return{legislatorBudgetSummaryData:m,legislatorSummary:o,isLegislatorBudgetLoading:c,isLegislatorBudgetError:a}},$e=({activeTab:t})=>{const u=async()=>{const a=await fetch(je);if(!a.ok)throw new Error("無法載入部會預算資料");const o=await a.json(),i=be.safeParse(o);if(!i.success)throw new Error("部會預算資料格式不符合預期");return i.data},h=["budget","departments"],{data:g,isLoading:p,isError:m}=Z({queryKey:h,queryFn:u,enabled:t==="department"}),c=n.useMemo(()=>{var x;const a=(x=g==null?void 0:g[0])==null?void 0:x.overall,o=(a==null?void 0:a.reductionAmount)??0,i=(a==null?void 0:a.freezeAmount)??0;return{formattedReductionAmount:G(o),formattedFreezeAmount:G(i),reductionCount:(a==null?void 0:a.reductionCount)??0,freezeCount:(a==null?void 0:a.freezeCount)??0,mainResolutionCount:(a==null?void 0:a.otherCount)??0}},[g]);return{departmentBudgetSummaryData:g,departmentSummary:c,isDepartmentBudgetLoading:p,isDepartmentBudgetError:m}},Oe=({children:t})=>{const{ref:u,width:h,height:g}=ne(),{ref:p,width:m,height:c}=ne(),a=ue(),{activeTab:o,handleTabChange:i,mode:x,setMode:v,selectedYear:y,handleYearChange:s,yearOptions:b,legislatorOptions:N,selectedLegislatorOption:j,handleLegislatorChange:L,departmentOptions:w,selectedDepartmentOption:f,handleDepartmentChange:I,handleToggleShowAll:V,isShowingAll:z,isDesktop:k,isLoading:M,isError:F,visualizationData:S,legislatorVisualizationData:E,selectedDepartmentCategorizedData:D}=Fe(),{legislatorSummary:U,isLegislatorBudgetLoading:T,isLegislatorBudgetError:_}=_e({selectedLegislatorOption:j,activeTab:o,isShowingAll:z}),{departmentSummary:O,isDepartmentBudgetLoading:W,isDepartmentBudgetError:$}=$e({activeTab:o}),Y=n.useMemo(()=>{if(x==="amount")return B=>{var r;return(r=B.children)!=null&&r.length?B.depth===0?20:B.depth===1?36:18:10}},[x]),K=n.useCallback(B=>{var r;if(B.proposalId)return a(`/budget/${B.proposalId}`),!0;if(B.proposerId&&!((r=B.children)!=null&&r.length)){const l=y.value,d=new URLSearchParams({year:l}).toString();return a(`/visualization/legislator/${B.proposerId}?${d}`),!0}return!1},[a,y.value]);return M||T||W?e.jsx(Ve,{isDesktop:k}):F||_||$?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):S?t({activeTab:o,onTabChange:i,yearOptions:b,selectedYear:y,onYearChange:s,mode:x,onModeChange:v,isShowingAll:z,onToggleShowAll:V,legislatorOptions:N,selectedLegislatorOption:j,onLegislatorChange:L,departmentOptions:w,selectedDepartmentOption:f,onDepartmentChange:I,isDesktop:k,isLoading:M,legislatorChartContainerRef:u,legislatorChartWidth:h,legislatorChartHeight:g,departmentChartContainerRef:p,departmentChartWidth:m,departmentChartHeight:c,visualizationData:S,legislatorVisualizationData:E,legislatorSummary:U,departmentSummary:O,legislatorPadding:Y,selectedDepartmentCategorizedData:D,selectedDepartmentTitle:(f==null?void 0:f.label)??null,showSelectedDepartmentChart:!!D,onNodeClick:K}):null},qe=()=>e.jsx(Oe,{children:t=>e.jsx(Pe,{...t})}),tt=ce(qe);export{tt as default};

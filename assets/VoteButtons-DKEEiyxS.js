var B=s=>{throw TypeError(s)};var U=(s,e,t)=>e.has(s)||B("Cannot "+t);var r=(s,e,t)=>(U(s,e,"read from private field"),t?t.call(s):e.get(s)),R=(s,e,t)=>e.has(s)?B("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),V=(s,e,t,n)=>(U(s,e,"write to private field"),n?n.call(s,t):e.set(s,t),t),N=(s,e,t)=>(U(s,e,"access private method"),t);import{a as u,p as v}from"./chunk-EPOLDU6W-BUbbWhPN.js";import{u as te,a as se}from"./index-yRWPS69A.js";import{I as q}from"./image-NJJ2A6N6.js";import{f as ne}from"./helpers-C8A9RZ9v.js";import{z as oe,A as re,B as ae,w as ie,x as ce}from"./middleware-BUHS2tjB.js";import{S as ue,u as le,j as Q,n as G,C as J,d as de,B as he}from"./QueryClientProvider-CzuGl5xs.js";import{g as ve}from"./mutation-BXWzKbsO.js";import{U as ge}from"./visualization.queries-B1IIJwAx.js";import{e as pe}from"./gql-CXkKbLhy.js";var x,S,g,_,w,F,I,Y,me=(Y=class extends ue{constructor(e,t){super();R(this,w);R(this,x);R(this,S);R(this,g);R(this,_);V(this,x,e),this.setOptions(t),this.bindMethods(),N(this,w,F).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var n;const t=this.options;this.options=r(this,x).defaultMutationOptions(e),le(this.options,t)||r(this,x).getMutationCache().notify({type:"observerOptionsUpdated",mutation:r(this,g),observer:this}),t!=null&&t.mutationKey&&this.options.mutationKey&&Q(t.mutationKey)!==Q(this.options.mutationKey)?this.reset():((n=r(this,g))==null?void 0:n.state.status)==="pending"&&r(this,g).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=r(this,g))==null||e.removeObserver(this)}onMutationUpdate(e){N(this,w,F).call(this),N(this,w,I).call(this,e)}getCurrentResult(){return r(this,S)}reset(){var e;(e=r(this,g))==null||e.removeObserver(this),V(this,g,void 0),N(this,w,F).call(this),N(this,w,I).call(this)}mutate(e,t){var n;return V(this,_,t),(n=r(this,g))==null||n.removeObserver(this),V(this,g,r(this,x).getMutationCache().build(r(this,x),this.options)),r(this,g).addObserver(this),r(this,g).execute(e)}},x=new WeakMap,S=new WeakMap,g=new WeakMap,_=new WeakMap,w=new WeakSet,F=function(){var t;const e=((t=r(this,g))==null?void 0:t.state)??ve();V(this,S,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},I=function(e){G.batch(()=>{var t,n,a,c,i,p,E,m;if(r(this,_)&&this.hasListeners()){const h=r(this,S).variables,y=r(this,S).context,l={client:r(this,x),meta:this.options.meta,mutationKey:this.options.mutationKey};if((e==null?void 0:e.type)==="success"){try{(n=(t=r(this,_)).onSuccess)==null||n.call(t,e.data,h,y,l)}catch(d){Promise.reject(d)}try{(c=(a=r(this,_)).onSettled)==null||c.call(a,e.data,null,h,y,l)}catch(d){Promise.reject(d)}}else if((e==null?void 0:e.type)==="error"){try{(p=(i=r(this,_)).onError)==null||p.call(i,e.error,h,y,l)}catch(d){Promise.reject(d)}try{(m=(E=r(this,_)).onSettled)==null||m.call(E,void 0,e.error,h,y,l)}catch(d){Promise.reject(d)}}}this.listeners.forEach(h=>{h(r(this,S))})})},Y);function fe(s,e){const t=J(),[n]=u.useState(()=>new me(t,s));u.useEffect(()=>{n.setOptions(s)},[n,s]);const a=u.useSyncExternalStore(u.useCallback(i=>n.subscribe(G.batchCalls(i)),[n]),()=>n.getCurrentResult(),()=>n.getCurrentResult()),c=u.useCallback((i,p)=>{n.mutate(i,p).catch(de)},[n]);if(a.error&&he(n.options.throwOnError,[a.error]))throw a.error;return{...a,mutate:c,mutateAsync:a.mutate}}const ye={votes:{},pending:{}},be=()=>ce(ye),z=()=>({react_good:0,react_angry:0,react_disappoint:0,react_whatever:0}),xe=s=>({react_good:s.react_good??0,react_angry:s.react_angry??0,react_disappoint:s.react_disappoint??0,react_whatever:s.react_whatever??0}),A=s=>(s.pending||(s.pending={}),s.pending),b=oe()(re(ae(ie(s=>({state:be(),actions:{initProposal:e=>{s(t=>{const a=A(t.state)[e.id],c=a&&Object.keys(a).length>0;(!(e.id in t.state.votes)||!c)&&(t.state.votes[e.id]=xe(e))})},queueVote:(e,t)=>s(n=>{const a=A(n.state);e in n.state.votes||(n.state.votes[e]=z()),n.state.votes[e][t]+=1,e in a||(a[e]={}),a[e][t]=!0}),setProposalCounts:(e,t)=>s(n=>{n.state.votes[e]={...z(),...t}}),refreshProposalCounts:e=>s(t=>{const n=t.state.votes[e];n&&(t.state.votes[e]={...n})}),removePendingReactions:(e,t)=>s(n=>{const c=A(n.state)[e];c&&(t.forEach(i=>{delete c[i]}),Object.keys(c).length===0&&delete n.state.pending[e])}),clearProposalPending:e=>s(t=>{const n=A(t.state);delete n[e]})}})),{name:"vote-storage",partialize:s=>({state:{votes:s.state.votes,pending:s.state.pending}})}),{name:"vote-store",enabled:!1})),_e=()=>b(s=>s.actions),we=s=>b(e=>e.state.votes[s]),Ce=()=>{const s=J();return fe({mutationFn:({proposalId:e,apiPayload:t})=>pe(ge,{where:{id:e},data:t}),onSettled:(e,t,n,a)=>{s.invalidateQueries({queryKey:["proposal",n.proposalId]}),s.invalidateQueries({queryKey:["proposals"]});try{const c=e;if(c!=null&&c.updateProposal){const i=c.updateProposal;b.getState().actions.setProposalCounts(n.proposalId,{react_good:i.react_good??0,react_angry:i.react_angry??0,react_disappoint:i.react_disappoint??0,react_whatever:i.react_whatever??0})}}catch{}}})},Se=2e3,Ee=(s=Se)=>{const{mutateAsync:e}=Ce(),t=u.useRef(null),n=u.useRef(!1),a=u.useRef(e),c=u.useRef(s);u.useEffect(()=>{a.current=e},[e]),u.useEffect(()=>{c.current=s},[s]);const i=u.useCallback(async()=>{if(n.current)return{success:!0,errors:[]};const m=[],h=[],y=Object.entries(b.getState().state.pending);if(!y.length)return{success:!0,errors:m};n.current=!0;try{for(const[l,d]of y){const f=Object.keys(d);if(!f.length){b.getState().actions.clearProposalPending(l);continue}const{votes:P}=b.getState().state,O=P[l];if(!O){b.getState().actions.clearProposalPending(l);continue}const C={};if(f.forEach(k=>{C[k]=O[k]}),!Object.keys(C).length){b.getState().actions.removePendingReactions(l,f);continue}try{await a.current({proposalId:l,apiPayload:C}),h.push({proposalId:l,reactions:f})}catch(k){m.push({proposalId:l,error:k})}}}finally{n.current=!1}if(h.length){const{removePendingReactions:l}=b.getState().actions;h.forEach(({proposalId:d,reactions:f})=>{l(d,f)})}return{success:m.length===0,errors:m}},[]),p=u.useCallback(()=>{t.current&&(window.clearTimeout(t.current),t.current=null)},[]),E=u.useCallback(()=>{p(),t.current=window.setTimeout(()=>{t.current=null,i()},c.current)},[p,i]);return u.useEffect(()=>{const m=()=>{document.visibilityState==="hidden"&&i()},h=()=>{i()};return window.addEventListener("beforeunload",h),document.addEventListener("visibilitychange",m),()=>{p(),window.removeEventListener("beforeunload",h),document.removeEventListener("visibilitychange",m),i()}},[p,i]),{scheduleFlush:E,cancelScheduledFlush:p,flushPending:i}},D={react_good:{default:"/image/vote-good-default.svg",hover:"/image/vote-good-hover.svg",active:"/image/vote-good-active.svg"},react_angry:{default:"/image/vote-angry-default.svg",hover:"/image/vote-angry-hover.svg",active:"/image/vote-angry-active.svg"},react_disappoint:{default:"/image/vote-sad-default.svg",hover:"/image/vote-sad-hover.svg",active:"/image/vote-sad-active.svg"},react_whatever:{default:"/image/vote-whatever-default.svg",hover:"/image/vote-whatever-hover.svg",active:"/image/vote-whatever-active.svg"}},H=[{type:"react_good",label:"我覺得很讚"},{type:"react_angry",label:"我感到生氣"},{type:"react_disappoint",label:"我有點失望"},{type:"react_whatever",label:"我不在意"}];function Fe({proposal:s,shouldShowCount:e=!0,singleButtonStyle:t="",displayMode:n="inline"}){const{initProposal:a,queueVote:c}=_e(),{scheduleFlush:i,flushPending:p,cancelScheduledFlush:E}=Ee(),[m,h,y]=te(),l=u.useRef(null),{id:d,react_good:f,react_angry:P,react_disappoint:O,react_whatever:C}=s;se(l,()=>{y(!1),M(null),E(),p()});const W=u.useMemo(()=>({react_good:f??0,react_angry:P??0,react_disappoint:O??0,react_whatever:C??0}),[f,P,O,C]),X=we(d)??W,[j,Z]=u.useState(null),[ee,M]=u.useState(null),K=o=>j===o?D[o].active:ee===o?D[o].hover:D[o].default,$=o=>{Z(o),c(d,o),M(null),n==="popup"?(y(!1),E(),p()):i()};return u.useEffect(()=>{a({id:d,react_good:f,react_angry:P,react_disappoint:O,react_whatever:C})},[a,d,f,P,O,C]),n==="popup"?v.jsxs("div",{ref:l,className:"relative",children:[v.jsx("button",{onClick:o=>{o.preventDefault(),h()},className:`flex h-8 min-w-[68px] cursor-pointer items-center justify-center rounded-sm border-2 bg-white text-[8px] ${j?"border-transparent":"px-2 py-1"}`,children:j?v.jsx(q,{src:K(j),alt:"Selected reaction",className:"h-full w-auto"}):v.jsx("span",{children:"請支援心情"})}),m&&v.jsx("div",{className:"right-0 bottom-0 z-10 w-[69px] rounded-[24px] border-2 bg-white p-2.5 text-[9px] md:absolute md:translate-x-8 md:translate-y-[10.5rem] lg:translate-x-11 lg:translate-y-[10.5rem]",children:H.map(({type:o,label:T})=>v.jsxs("div",{onClick:()=>$(o),onMouseEnter:()=>M(o),onMouseLeave:()=>M(L=>L===o?null:L),className:`mt-1.5 flex cursor-pointer flex-col items-center justify-center first:mt-0 ${j===o?"shadow-lg":""}`,children:[v.jsx(q,{src:K(o),alt:T,className:"w-12"}),v.jsx("p",{children:T})]},o))})]}):v.jsx("div",{className:"flex justify-center gap-4 px-3 py-2.5",children:H.map(({type:o,label:T})=>v.jsxs("div",{className:`flex flex-col items-center text-center ${t}`,onMouseEnter:()=>M(o),onMouseLeave:()=>M(L=>L===o?null:L),children:[v.jsx("p",{className:"text-sm font-medium",children:T}),e&&v.jsx("p",{className:"font-base text-base",children:ne(X[o])}),v.jsx("button",{type:"button",onClick:()=>$(o),className:`mt-3 flex w-full cursor-pointer items-center justify-center rounded-lg bg-transparent transition-opacity ${j===o?"opacity-100":"opacity-80"}`,children:v.jsx(q,{src:K(o),alt:T,className:"max-w-full"})})]},o))})}export{Fe as V,we as u};

import{a as n,p as e,H as ue,y as ce}from"./chunk-EPOLDU6W-BUbbWhPN.js";import{t as oe,G as de,f as U,C as te,S as me,B as he,a as ge,m as fe,g as re,u as X,b as pe,c as xe,d as ye,e as je,h as be}from"./budget-endpoints-B7Ie_aVt.js";import{B as ve}from"./budget-detail-skeleton-Dp8GXHLT.js";import{S as Y}from"./react-select.esm-D75C9S97.js";import{u as J,V as se,t as we,q as Ce,k as Ne}from"./gql-LkxxGARM.js";import{Y as ae}from"./floating-ui.dom-Bxq-dYPq.js";import"./helpers-DAftcCeU.js";import{b as Se}from"./index-yRWPS69A.js";import{p as Ae,f as De}from"./visualization.queries-M4n9rV1P.js";import"./index-IDBlchwH.js";import"./index-CFRUIq19.js";import"./hoist-non-react-statics.cjs-Cim0U2tB.js";const Le=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],ee=n.forwardRef((t,u)=>e.jsx("div",{className:"w-60",children:e.jsx(Y,{ref:u,options:Le,...t})}));ee.displayName="VisualizationSelector";var T=(t=>(t.Legislator="legislator",t.Department="department",t))(T||{}),O=(t=>(t.Amount="amount",t.Count="count",t))(O||{});const Ee=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>u(T.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>u(T.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ee,{options:h,value:g,onChange:m=>{m&&p(m)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),ke=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p,isShowingAll:m,onToggleShowAll:c,legislatorOptions:s,selectedLegislator:o,onLegislatorChange:i,departmentOptions:x,selectedDepartment:v,onDepartmentChange:y})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:c,className:`rounded px-2.5 transition-colors ${m?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>u(T.Legislator),className:`rounded px-2.5 transition-colors ${t==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>u(T.Department),className:`rounded px-2.5 transition-colors ${t==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(ee,{options:h,value:g,onChange:a=>{a&&p(a)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!m&&t==="legislator"&&(s.length>0?e.jsx(Y,{className:"w-full",value:o,options:s,onChange:a=>{i(a??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!m&&t==="department"&&(x.length>0?e.jsx(Y,{className:"w-full",value:v,options:x,onChange:a=>{y(a??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),ze=t=>{var u;return(u=t.children)!=null&&u.length?t.depth===0?26:22:18},Z=.45,ne=({data:t,width:u=928,height:h,onNodeClick:g,mode:p,transformedData:m,padding:c,selectedDepartmentCategorizedData:s,selectedDepartmentTitle:o,showSelectedDepartmentChart:i})=>{const x=n.useMemo(()=>m??oe(t,p),[t,p,m]),v=n.useMemo(()=>c??ze,[c]),y=n.useMemo(()=>{if(!s)return null;const j=Object.values(s).flatMap(w=>w.children??[]);if(!j.length)return null;const L=new Map;return j.forEach(w=>{var F;const f=[w.proposerId??w.name??"unknown",w.proposalType??"unknown-type"].join("-"),I=((F=w.name)==null?void 0:F.split(`
`)[0])??w.name??"無名提案者",V=w.value??0,k=V>0?Math.pow(V,1/Z):0,z=de[w.proposalType]??"",M=L.get(f);if(M){const S=M.totalAmount+k;L.set(f,{totalAmount:S,node:{...M.node,name:`${I}
${z}
${U(S)}`,value:Math.pow(S,Z)}})}else L.set(f,{totalAmount:k,node:{...w,id:`merged-${f}`,name:`${I}
${z}
${U(k)}`,value:Math.pow(k,Z)}})}),Array.from(L.values()).map(w=>w.node)},[s]),a=n.useMemo(()=>!y||!i?null:{id:`selected-department-${o??"selected"}`,name:o??"目前部會",children:y},[y,o,i]),b=Object.keys(x),N=a;return b.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:u},children:"無符合資料"}):e.jsxs("div",{className:"flex flex-col items-center justify-center gap-y-8",children:[N&&e.jsxs("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:[e.jsx("p",{className:"text-xl",children:"看全部"}),e.jsx(te,{data:N,width:u,height:h??u,padding:v,onNodeClick:g})]},"selected-department-highlight"),Object.entries(x).map(([j,L])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:L.children&&L.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:j}),e.jsx(te,{data:L,width:u,height:h??u,padding:v,onNodeClick:g})]})},j))]})},Me=({mode:t,onModeChange:u})=>e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:O.Amount,checked:t===O.Amount,onChange:()=>u(O.Amount),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:O.Count,checked:t===O.Count,onChange:()=>u(O.Count),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),Be=({departmentOptions:t,selectedDepartmentOption:u,onDepartmentChange:h})=>t.length===0?e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"})}):e.jsx("div",{className:"mt-4 flex w-full justify-center",children:e.jsx(Y,{className:"w-full md:max-w-xl",value:u,options:t,onChange:g=>{h(g??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department-desktop"})}),Pe=({activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p,mode:m,onModeChange:c,isShowingAll:s,onToggleShowAll:o,legislatorOptions:i,selectedLegislatorOption:x,onLegislatorChange:v,departmentOptions:y,selectedDepartmentOption:a,onDepartmentChange:b,isDesktop:N,isLoading:j,legislatorChartContainerRef:L,legislatorChartWidth:w,legislatorChartHeight:f,departmentChartContainerRef:I,departmentChartWidth:V,departmentChartHeight:k,visualizationData:z,legislatorVisualizationData:M,legislatorSummary:F,departmentSummary:S,legislatorPadding:E,selectedDepartmentCategorizedData:A,selectedDepartmentTitle:W,showSelectedDepartmentChart:G,onNodeClick:_})=>{const q=N&&t==="department",H=t==="department"&&z,$=t==="legislator"&&M;return j?e.jsx(ve,{isDesktop:N}):e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Ee,{activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p}),e.jsx(ke,{activeTab:t,onTabChange:u,yearOptions:h,selectedYear:g,onYearChange:p,isShowingAll:s,onToggleShowAll:o,legislatorOptions:i,selectedLegislator:x,onLegislatorChange:v,departmentOptions:y,selectedDepartment:a,onDepartmentChange:b}),e.jsx(Me,{mode:m,onModeChange:c}),e.jsx(me,{summary:t==="legislator"?F:S}),q&&e.jsx(Be,{departmentOptions:y,selectedDepartmentOption:a,onDepartmentChange:b}),e.jsx(he,{items:ge}),$&&e.jsx("div",{ref:L,className:"chart-container",children:e.jsx(ne,{data:z,transformedData:M,padding:E,onNodeClick:_,width:w,height:f,mode:m},"legislator-chart")}),H&&e.jsx("div",{ref:I,className:"chart-container",children:e.jsx(ne,{data:z,onNodeClick:_,width:V,height:k,mode:m,selectedDepartmentCategorizedData:A,selectedDepartmentTitle:W??null,showSelectedDepartmentChart:G},"department-chart")})]})})},Re=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Ie=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Ve=({isDesktop:t})=>t?e.jsx(Re,{}):e.jsx(Ie,{}),le=()=>{const h=Math.round(225),[g,p]=n.useState(h),[m,c]=n.useState(300),s=n.useRef(null);return{ref:n.useCallback(i=>{if(s.current&&s.current.disconnect(),!i)return;const v=requestAnimationFrame(()=>{const y=i.getBoundingClientRect().width;y<=0||(c(y),p(Math.round(y*.75)))});return s.current=new ResizeObserver(y=>{const a=y[0];if(!a)return;const b=a.contentRect.width;c(b),p(Math.round(b*.75))}),s.current.observe(i),()=>{cancelAnimationFrame(v)}},[]),width:m,height:g}},Fe=()=>{const[t,u]=n.useState(T.Legislator),[h,g]=n.useState(O.Amount),[p,m]=n.useState(ae[0]),[c,s]=n.useState(null),[o,i]=n.useState(null),x=n.useRef(null),v=n.useRef(null),[y,a]=n.useState(!0),[b,N]=n.useState(!0),j=Se("(min-width: 768px)"),L=!j,w=n.useCallback(()=>({year:{year:{equals:parseInt(p.value,10)}},mergedParentProposals:null,historicalParentProposals:null,result:{equals:"passed"}}),[p.value]),{data:f,isLoading:I,isError:V}=J({queryKey:Ae.paginated(w(),parseInt(p.value,10)),queryFn:()=>Ne(De,{where:w()}),placeholderData:Ce}),k=n.useCallback(r=>{if(u(r),!j){if(r==="legislator"){a(!0);return}N(!0)}},[j]);n.useEffect(()=>{j&&(s(null),i(null),a(!0),N(!0))},[j]);const z=n.useCallback(r=>{m(r)},[]),M=n.useCallback(r=>{s(r),a(!1),r&&(x.current=r)},[]),F=n.useCallback(r=>{i(r),N(!1),r&&(v.current=r)},[]),S=n.useMemo(()=>fe(f),[f]),E=n.useMemo(()=>{const r=new Map;return S.forEach(l=>{var D;((D=l.proposers)!=null&&D.length?l.proposers:[]).forEach((C,P)=>{const R=re(C,l.id,P);if(!R)return;const ie=(C==null?void 0:C.name)??"未命名立委";r.has(R)||r.set(R,{value:R,label:ie})})}),Array.from(r.values()).sort((l,d)=>l.label.localeCompare(d.label,"zh-Hant"))},[S]),A=n.useMemo(()=>{const r=new Map;return S.forEach(l=>{var C,P;const d=(P=(C=l.government)==null?void 0:C.category)==null?void 0:P.trim(),D=d&&d.length>0?d:"未分類";r.set(D,{value:D,label:D})}),Array.from(r.values()).sort((l,d)=>l.label.localeCompare(d.label,"zh-Hant"))},[S]),W=n.useCallback(()=>{t==="legislator"?c?(x.current=c,s(null),a(!1)):x.current?(s(x.current),a(!1)):E.length>0&&(s(E[0]),a(!1)):t==="department"&&(o?(v.current=o,i(null),N(!1)):v.current?(i(v.current),N(!1)):A.length>0&&(i(A[0]),N(!1)))},[t,c,o,E,A]),G=n.useCallback(r=>{const l=r==null?void 0:r.trim();return l&&l.length>0?l:"未分類"},[]),_=n.useMemo(()=>{if(j||t!=="legislator"||!c)return null;const r=S.filter(l=>{const d=l.proposers??[];return d.length===0?!1:d.some((D,C)=>re(D,l.id,C)===c.value)}).map(l=>l.id).filter(l=>!!l);return new Set(r)},[t,S,j,c]),q=n.useMemo(()=>{if(t!=="department"||!o)return null;const r=S.filter(l=>{var C,P;const d=(P=(C=l.government)==null?void 0:C.category)==null?void 0:P.trim();return(d&&d.length>0?d:"未分類")===o.value}).map(l=>l.id).filter(l=>!!l);return new Set(r)},[t,S,o]),H=n.useMemo(()=>{var d;if(!f||t!=="department"||!o||!o.value)return null;const r=((d=f.proposals)==null?void 0:d.filter(D=>{var R;if(!D)return!1;const C=X(se,D);return G(((R=C.government)==null?void 0:R.category)??null)===o.value}))??[];if(!r.length)return null;const l={...f,proposals:r};return oe(l,h)},[t,f,h,G,o]);n.useEffect(()=>{L&&(t==="legislator"?c&&E.some(l=>l.value===c.value)||(y&&E.length>0?s(E[0]):c&&s(null)):t==="department"&&(o&&A.some(l=>l.value===o.value)||(b&&A.length>0?i(A[0]):o&&i(null))))},[t,A,L,E,o,c,b,y]),n.useEffect(()=>{if(!j||t!=="department")return;!(o&&A.some(l=>l.value===o.value))&&A.length>0&&(i(A[0]),N(!1))},[t,A,j,o]);const $=n.useMemo(()=>{var d;if(!f)return null;let r=null;if(t==="legislator"&&_?r=_:t==="department"&&q&&(r=q),!r)return f;const l=((d=f.proposals)==null?void 0:d.filter(D=>{if(!D)return!1;const C=X(se,D),R=X(we,C).id;return R!=null&&(r==null?void 0:r.has(R))}))??[];return{...f,proposals:l}},[t,f,q,_]),K=$??f??null,Q=n.useMemo(()=>{if(!$)return null;const r=pe($,h);if(!(!j&&t==="legislator"&&c))return r;const d=r[""];if(!(d!=null&&d.children))return r;const D=d.children.filter(C=>C.proposerId===c.value||C.proposerKey===c.value);return{...r,"":{...d,children:D}}},[t,$,j,h,c]);return{activeTab:t,handleTabChange:k,mode:h,setMode:g,selectedYear:p,handleYearChange:z,yearOptions:ae,legislatorOptions:E,selectedLegislatorOption:c,handleLegislatorChange:M,departmentOptions:A,selectedDepartmentOption:o,handleDepartmentChange:F,handleToggleShowAll:W,isShowingAll:t==="legislator"&&!c||t==="department"&&!o,isDesktop:j,isMobile:L,isLoading:I,isError:V,rawData:f,visualizationData:K,legislatorVisualizationData:Q,selectedDepartmentCategorizedData:H}},_e=({selectedLegislatorOption:t,activeTab:u,isShowingAll:h})=>{const g=["budget","legislators"],p=async()=>{const i=await fetch(xe);if(!i.ok)throw new Error("無法載入立委預算資料");const x=await i.json(),v=ye.safeParse(x);if(!v.success)throw new Error("立委預算資料格式不符合預期");return v.data},{data:m,isLoading:c,isError:s}=J({queryKey:g,queryFn:p,enabled:u==="legislator"}),o=n.useMemo(()=>{var y;const i=m==null?void 0:m[0],x=i==null?void 0:i.overall,v=a=>{const b=(a==null?void 0:a.reductionAmount)??0,N=(a==null?void 0:a.freezeAmount)??0;return{formattedReductionAmount:U(b),formattedFreezeAmount:U(N),reductionCount:(a==null?void 0:a.reductionCount)??0,freezeCount:(a==null?void 0:a.freezeCount)??0,mainResolutionCount:(a==null?void 0:a.otherCount)??0}};if(u===T.Legislator&&!h&&t&&((y=i==null?void 0:i.legislators)!=null&&y.length)){const a=i.legislators.find(b=>b.peopleId===t.value)??i.legislators.find(b=>b.name===t.label);if(a){const b=a.allInvolved??a.proposerOnly;return v(b)}}return v(x)},[u,h,m,t]);return{legislatorBudgetSummaryData:m,legislatorSummary:o,isLegislatorBudgetLoading:c,isLegislatorBudgetError:s}},$e=({activeTab:t})=>{const u=async()=>{const s=await fetch(je);if(!s.ok)throw new Error("無法載入部會預算資料");const o=await s.json(),i=be.safeParse(o);if(!i.success)throw new Error("部會預算資料格式不符合預期");return i.data},h=["budget","departments"],{data:g,isLoading:p,isError:m}=J({queryKey:h,queryFn:u,enabled:t==="department"}),c=n.useMemo(()=>{var x;const s=(x=g==null?void 0:g[0])==null?void 0:x.overall,o=(s==null?void 0:s.reductionAmount)??0,i=(s==null?void 0:s.freezeAmount)??0;return{formattedReductionAmount:U(o),formattedFreezeAmount:U(i),reductionCount:(s==null?void 0:s.reductionCount)??0,freezeCount:(s==null?void 0:s.freezeCount)??0,mainResolutionCount:(s==null?void 0:s.otherCount)??0}},[g]);return{departmentBudgetSummaryData:g,departmentSummary:c,isDepartmentBudgetLoading:p,isDepartmentBudgetError:m}},Oe=({children:t})=>{const{ref:u,width:h,height:g}=le(),{ref:p,width:m,height:c}=le(),s=ue(),{activeTab:o,handleTabChange:i,mode:x,setMode:v,selectedYear:y,handleYearChange:a,yearOptions:b,legislatorOptions:N,selectedLegislatorOption:j,handleLegislatorChange:L,departmentOptions:w,selectedDepartmentOption:f,handleDepartmentChange:I,handleToggleShowAll:V,isShowingAll:k,isDesktop:z,isLoading:M,isError:F,visualizationData:S,legislatorVisualizationData:E,selectedDepartmentCategorizedData:A}=Fe(),{legislatorSummary:W,isLegislatorBudgetLoading:G,isLegislatorBudgetError:_}=_e({selectedLegislatorOption:j,activeTab:o,isShowingAll:k}),{departmentSummary:q,isDepartmentBudgetLoading:H,isDepartmentBudgetError:$}=$e({activeTab:o}),K=n.useMemo(()=>{if(x==="amount")return B=>{var r;return(r=B.children)!=null&&r.length?B.depth===0?20:B.depth===1?36:18:10}},[x]),Q=n.useCallback(B=>{var r;if(B.proposalId)return s(`/budget/${B.proposalId}`),!0;if(B.proposerId&&!((r=B.children)!=null&&r.length)){const l=y.value,d=new URLSearchParams({year:l}).toString();return s(`/visualization/legislator/${B.proposerId}?${d}`),!0}return!1},[s,y.value]);return M||G||H?e.jsx(Ve,{isDesktop:z}):F||_||$?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):S?t({activeTab:o,onTabChange:i,yearOptions:b,selectedYear:y,onYearChange:a,mode:x,onModeChange:v,isShowingAll:k,onToggleShowAll:V,legislatorOptions:N,selectedLegislatorOption:j,onLegislatorChange:L,departmentOptions:w,selectedDepartmentOption:f,onDepartmentChange:I,isDesktop:z,isLoading:M,legislatorChartContainerRef:u,legislatorChartWidth:h,legislatorChartHeight:g,departmentChartContainerRef:p,departmentChartWidth:m,departmentChartHeight:c,visualizationData:S,legislatorVisualizationData:E,legislatorSummary:W,departmentSummary:q,legislatorPadding:K,selectedDepartmentCategorizedData:A,selectedDepartmentTitle:(f==null?void 0:f.label)??null,showSelectedDepartmentChart:!!A,onNodeClick:Q}):null},qe=()=>e.jsx(Oe,{children:t=>e.jsx(Pe,{...t})}),tt=ce(qe);export{tt as default};

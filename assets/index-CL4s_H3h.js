import{a as n,p as e,y as le,G as ie}from"./chunk-4WY6JWTD-2Cr-QbDP.js";import{a as H,s as oe}from"./options-Tu1gPMXa.js";import{t as ce,C as ue,m as Z,u as J,f as X,a as de,B as me,b as he}from"./legends-DUSOnCbm.js";import{O as U,u as ge,P as pe,V as fe,q as xe,l as be,j as je}from"./gql-HYPlJro8.js";import{l as O}from"./lodash-BSr-28Nd.js";import{b as ve}from"./index-Ck08PhAW.js";import{p as ye,e as Ne}from"./visualization.queries-gMEp7MMc.js";import{B as Ce}from"./budget-detail-skeleton-DMxLzU0j.js";import"./hoist-non-react-statics.cjs-BZ9oskQ4.js";import"./index-CtMSh7YR.js";import"./helpers-CUKl9yx0.js";const we=[{value:"chocolate",label:"Chocolate"},{value:"strawberry",label:"Strawberry"},{value:"vanilla",label:"Vanilla"}],Q=n.forwardRef((s,i)=>e.jsx("div",{className:"w-60",children:e.jsx(H,{ref:i,options:we,...s})}));Q.displayName="VisualizationSelector";const Se=({activeTab:s,onTabChange:i,yearOptions:f,selectedYear:x,onYearChange:o})=>e.jsxs("div",{className:"hidden flex-col gap-y-2 md:flex md:flex-row md:items-center md:justify-center md:gap-x-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5 md:gap-x-6",children:[e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${s==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${s==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(Q,{options:f,value:x,onChange:g=>{g&&o(g)},"aria-label":"選擇年度",inputId:"visualization-year-desktop"})})]}),ze=({activeTab:s,onTabChange:i,yearOptions:f,selectedYear:x,onYearChange:o,isShowingAll:g,onToggleShowAll:l,legislatorOptions:m,selectedLegislator:c,onLegislatorChange:u,departmentOptions:h,selectedDepartment:p,onDepartmentChange:D})=>e.jsxs("div",{className:"flex flex-col gap-y-2 md:hidden",children:[e.jsxs("div",{className:"flex items-center justify-center gap-x-1.5",children:[e.jsx("button",{onClick:l,className:`rounded px-2.5 transition-colors ${g?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"看全部"}),e.jsx("button",{onClick:()=>i("legislator"),className:`rounded px-2.5 transition-colors ${s==="legislator"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依立委"}),e.jsx("button",{onClick:()=>i("department"),className:`rounded px-2.5 transition-colors ${s==="department"?"bg-brand-primary text-white":"border border-gray-300 bg-white text-gray-800"}`,children:"依部會"})]}),e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(Q,{options:f,value:x,onChange:b=>{b&&o(b)},"aria-label":"選擇年度",inputId:"visualization-year-mobile"})}),!g&&s==="legislator"&&(m.length>0?e.jsx(H,{className:"w-full",value:c,options:m,onChange:b=>{u(b??null)},placeholder:"選擇立委",isSearchable:!0,"aria-label":"選擇立委",inputId:"visualization-legislator"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有立委資料"})),!g&&s==="department"&&(h.length>0?e.jsx(H,{className:"w-full",value:p,options:h,onChange:b=>{D(b??null)},placeholder:"選擇部會",isSearchable:!0,"aria-label":"選擇部會",inputId:"visualization-department"}):e.jsx("p",{className:"text-center text-sm text-gray-500",children:"目前沒有部會資料"}))]}),De=s=>{var i;return(i=s.children)!=null&&i.length?s.depth===0?26:22:18},ee=({data:s,width:i=928,height:f,onNodeClick:x,mode:o,transformedData:g,padding:l})=>{const m=n.useMemo(()=>g??ce(s,o),[s,o,g]),c=n.useMemo(()=>l??De,[l]),u=Object.keys(m);return console.log({categories:u}),u.length===0?e.jsx("div",{className:"flex h-96 items-center justify-center text-gray-500",style:{width:i},children:"無符合資料"}):e.jsx("div",{className:"flex flex-col items-center justify-center gap-y-8",children:Object.entries(m).map(([h,p])=>e.jsx("div",{className:"flex w-full flex-col items-center justify-center gap-y-5 font-bold",children:p.children&&p.children.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-xl",children:h}),e.jsx(ue,{data:p,width:i,height:f??i,padding:c,onNodeClick:x})]})},h))})},te=[{value:"114",label:"114年度 (2025)"},{value:"113",label:"113年度 (2024)"}],Ae=()=>{const[s,i]=n.useState("legislator"),[f,x]=n.useState("amount"),[o,g]=n.useState(te[0]),[l,m]=n.useState(null),[c,u]=n.useState(null),h=n.useRef(null),p=n.useRef(null),[D,b]=n.useState(!0),[A,S]=n.useState(!0),j=ve("(min-width: 768px)"),M=!j,P="id-asc",T=1,R=1e3,F=n.useCallback(()=>({year:{year:{equals:parseInt(o.value,10)}}}),[o.value]),I=n.useMemo(()=>{const t=O.find(oe,a=>a.value===P);if(!t)return[{id:U.Desc}];const r=t.direction==="asc"?U.Asc:U.Desc;return[{[t.field]:r}]},[P]),{data:y,isLoading:L,isError:Y}=ge({queryKey:ye.paginated(T,R,P,F(),parseInt(o.value,10)),queryFn:()=>je(Ne,{skip:0,take:R,orderBy:I,where:F()}),placeholderData:be}),_=n.useCallback(t=>{i(t),j||(t==="legislator"?b(!0):S(!0))},[j]);n.useEffect(()=>{j&&(m(null),u(null),b(!0),S(!0))},[j]);const $=n.useCallback(t=>{g(t)},[]),B=n.useCallback(t=>{m(t),b(!1),t&&(h.current=t)},[]),C=n.useCallback(t=>{u(t),S(!1),t&&(p.current=t)},[]),z=n.useCallback(()=>{s==="legislator"?l?(h.current=l,m(null),b(!1)):h.current&&(m(h.current),b(!1)):s==="department"&&(c?(p.current=c,u(null),S(!1)):p.current&&(u(p.current),S(!1)))},[s,l,c]),w=n.useMemo(()=>Z(y),[y]),V=n.useMemo(()=>{const t=new Map;return w.forEach(r=>{var N;const a=(N=r.proposers)==null?void 0:N[0],v=(a==null?void 0:a.id)??(a==null?void 0:a.name)??"",d=(a==null?void 0:a.name)??"未命名立委";v&&t.set(v,{value:v,label:d})}),Array.from(t.values()).sort((r,a)=>r.label.localeCompare(a.label,"zh-Hant"))},[w]),E=n.useMemo(()=>{const t=new Map;return w.forEach(r=>{var d,N;const a=(N=(d=r.government)==null?void 0:d.category)==null?void 0:N.trim(),v=a&&a.length>0?a:"未分類";t.set(v,{value:v,label:v})}),Array.from(t.values()).sort((r,a)=>r.label.localeCompare(a.label,"zh-Hant"))},[w]),q=n.useMemo(()=>{if(j||s!=="legislator"||!l)return null;const t=w.filter(r=>{var d;const a=(d=r.proposers)==null?void 0:d[0];return((a==null?void 0:a.id)??(a==null?void 0:a.name)??"")===l.value}).map(r=>r.id).filter(r=>!!r);return new Set(t)},[s,w,j,l]),G=n.useMemo(()=>{if(j||s!=="department"||!c)return null;const t=w.filter(r=>{var d,N;const a=(N=(d=r.government)==null?void 0:d.category)==null?void 0:N.trim();return(a&&a.length>0?a:"未分類")===c.value}).map(r=>r.id).filter(r=>!!r);return new Set(t)},[s,w,j,c]);n.useEffect(()=>{M&&(s==="legislator"?l&&V.some(r=>r.value===l.value)||(D&&V.length>0?m(V[0]):l&&m(null)):s==="department"&&(c&&E.some(r=>r.value===c.value)||(A&&E.length>0?u(E[0]):c&&u(null))))},[s,E,M,V,c,l,A,D]);const k=n.useMemo(()=>{var a;if(!y)return null;if(j)return y;let t=null;if(s==="legislator"&&q?t=q:s==="department"&&G&&(t=G),!t)return y;const r=((a=y.proposals)==null?void 0:a.filter(v=>{if(!v)return!1;const d=J(xe,v),K=J(fe,d).id;return K!=null&&(t==null?void 0:t.has(K))}))??[];return{...y,proposals:r}},[s,y,G,q,j]),se=k??y??null,W=n.useMemo(()=>{const t=Z(k),r=O.filter(t,d=>d.reductionAmount&&d.reductionAmount>0),a=O.filter(t,d=>d.freezeAmount&&d.freezeAmount>0),v=O.filter(t,d=>{var N;return(N=d.proposalTypes)==null?void 0:N.includes(pe.Other)});return{totalReductionAmount:O.sumBy(r,"reductionAmount"),reductionCount:r.length,totalFreezeAmount:O.sumBy(a,"freezeAmount"),freezeCount:a.length,mainResolutionCount:v.length}},[k]),ae=X(W.totalReductionAmount),ne=X(W.totalFreezeAmount),re=n.useMemo(()=>k?de(k,f):null,[k,f]);return{activeTab:s,handleTabChange:_,mode:f,setMode:x,selectedYear:o,handleYearChange:$,yearOptions:te,legislatorOptions:V,selectedLegislatorOption:l,handleLegislatorChange:B,departmentOptions:E,selectedDepartmentOption:c,handleDepartmentChange:C,handleToggleShowAll:z,isShowingAll:s==="legislator"&&!l||s==="department"&&!c,isDesktop:j,isMobile:M,isLoading:L,isError:Y,rawData:y,visualizationData:se,legislatorVisualizationData:re,summaryStats:W,formattedReductionAmount:ae,formattedFreezeAmount:ne}},ke=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 flex space-x-4",children:[e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-48 rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-24 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-96 w-full rounded bg-gray-200"})]}),Oe=()=>e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-6 w-1/2 rounded bg-gray-200"}),e.jsxs("div",{className:"mt-4 space-y-3",children:[e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"}),e.jsx("div",{className:"h-20 rounded bg-gray-200"})]}),e.jsx("div",{className:"mt-6 h-64 w-full rounded bg-gray-200"})]}),Me=({isDesktop:s})=>s?e.jsx(ke,{}):e.jsx(Oe,{}),Pe=()=>{const[s,i]=n.useState(0),[f,x]=n.useState(300),o=n.useRef(null);return{ref:n.useCallback(l=>{if(o.current&&o.current.disconnect(),l){const c=requestAnimationFrame(()=>{const u=l.getBoundingClientRect().width;u>0&&(x(u),i(Math.round(u*9/16)))});return o.current=new ResizeObserver(u=>{const h=u[0];if(h){const p=h.contentRect.width;x(p),i(Math.round(p*9/16))}}),o.current.observe(l),()=>{cancelAnimationFrame(c)}}},[]),width:f,height:s}},Re=()=>{const{ref:s,width:i,height:f}=Pe(),x=ie(),{activeTab:o,handleTabChange:g,mode:l,setMode:m,selectedYear:c,handleYearChange:u,yearOptions:h,legislatorOptions:p,selectedLegislatorOption:D,handleLegislatorChange:b,departmentOptions:A,selectedDepartmentOption:S,handleDepartmentChange:j,handleToggleShowAll:M,isShowingAll:P,isDesktop:T,isLoading:R,isError:F,visualizationData:I,legislatorVisualizationData:y,summaryStats:L,formattedReductionAmount:Y,formattedFreezeAmount:_}=Ae(),$=n.useMemo(()=>{if(l==="amount")return C=>{var z;return(z=C.children)!=null&&z.length?C.depth===0?20:C.depth===1?36:18:10}},[l]),B=n.useCallback(C=>{var z;return C.proposalId?(x(`/budget/${C.proposalId}`),!0):C.proposerId&&!((z=C.children)!=null&&z.length)?(x(`/visualization/legislator/${C.proposerId}`),!0):!1},[x]);return R?e.jsx(Me,{isDesktop:T}):F?e.jsx("div",{className:"flex h-96 items-center justify-center",children:e.jsx("p",{className:"text-red-600",children:"資料載入失敗，請稍後再試。"})}):I?e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col gap-y-3 p-4",children:[e.jsx(Se,{activeTab:o,onTabChange:g,yearOptions:h,selectedYear:c,onYearChange:u}),e.jsx(ze,{activeTab:o,onTabChange:g,yearOptions:h,selectedYear:c,onYearChange:u,isShowingAll:P,onToggleShowAll:M,legislatorOptions:p,selectedLegislator:D,onLegislatorChange:b,departmentOptions:A,selectedDepartment:S,onDepartmentChange:j}),e.jsx("div",{children:e.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 md:flex-row md:gap-x-6",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:l==="amount",onChange:()=>m("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:l==="count",onChange:()=>m("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),e.jsx("div",{className:"bg-surface-notice md:max-w-visualization-card flex flex-col items-center justify-center rounded-lg border-2 p-2.5 md:mx-auto",children:e.jsxs("div",{children:[e.jsxs("p",{children:["總共刪減"," ",e.jsx("span",{className:"text-budget-accent",children:Y}),"（",e.jsx("span",{className:"text-budget-accent",children:L.reductionCount}),"個提案）"]}),e.jsxs("p",{children:["凍結"," ",e.jsx("span",{className:"text-budget-accent",children:_}),"（",e.jsx("span",{className:"text-budget-accent",children:L.freezeCount}),"個提案）"]}),e.jsxs("p",{children:["主決議提案數：",e.jsx("span",{className:"text-budget-accent",children:L.mainResolutionCount}),"個"]})]})}),e.jsx(me,{items:he}),R&&e.jsx(Ce,{isDesktop:T}),e.jsxs("div",{ref:s,className:"chart-container",children:[o==="legislator"&&y&&e.jsx(ee,{data:I,transformedData:y,padding:$,onNodeClick:B,width:i,height:f,mode:l}),o==="department"&&e.jsx("div",{className:"w-full",children:e.jsx("div",{className:"aspect-video md:aspect-video lg:aspect-video",children:e.jsx(ee,{data:I,onNodeClick:B,width:i,height:f,mode:l})})})]})]})}):null},We=le(Re);export{We as default};

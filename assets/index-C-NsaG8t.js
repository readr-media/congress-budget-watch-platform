import{p as e,y as $,J as Y,a as u,H as K,L as U}from"./chunk-WWGJGFF6-C1k8rglg.js";import{t as Q,u as A,P as V,j as D,O as W}from"./gql-B77SbNtU.js";import{l as b}from"./floating-ui.dom-0N10Lwd1.js";import{b as y}from"./index-DrVPcFH7.js";import{C as H,i as X,m as J,f as j,S as Z,B as ee,a as re,c as se,d as ae}from"./budget-by-legislator.schema-C1IDkj9p.js";import{p as te,f as ne}from"./visualization.queries-BsSTzKn-.js";import"./index-CeHjcr3Z.js";import"./index-SkmILjJ3.js";import"./helpers-DM_2piGp.js";const oe=(r,s)=>s>1&&r<s-1?"border-b border-gray-200":"",le=({data:r,presenterDescription:s="",yearToCommitteeMap:a,onNodeClick:t})=>{const m=y("(min-width: 768px)"),o=y("(min-width: 1024px)"),p=y("(min-width: 1440px)"),N=y("(min-width: 1920px)"),v=()=>N?1800:p?1400:o?1e3:720;if(!r||r.length===0)return e.jsx("div",{className:"flex w-full items-center justify-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"目前無提案資料"})});const h=v(),w={maxWidth:`${h}px`};return e.jsx(e.Fragment,{children:r.map((x,n)=>{const i=a.get(x.name),C=i!=null&&i.termNumber?`第${i.termNumber}屆`:x.name,S=(i==null?void 0:i.committeeName)??"委員會";return e.jsxs("div",{className:`mb-2 flex w-full flex-col items-start justify-center ${oe(n,r.length)} mx-auto`,style:w,children:[e.jsxs("div",{className:"flex w-full flex-col items-start justify-center",children:[e.jsx("p",{children:C}),e.jsx("p",{children:S}),s?e.jsx("div",{className:"flex w-full flex-col items-start justify-center mb-5 lg:mb-8",children:e.jsx("p",{className:"text-sm leading-relaxed text-black/80",children:s})}):null]}),e.jsx("div",{className:"w-full md:mx-auto",children:e.jsx(H,{data:{id:x.id,name:"root",children:x.children},width:h,padding:50,onNodeClick:t})})]},x.id)})})},de=Q(`
  query People($where: PeopleWhereUniqueInput!) {
    people(where: $where) {
      id
      name
      description
      party {
        id
        color
        name
      }
      term {
        termNumber
        id
      }
      termCount
      committees {
        id
        name
        session
        term {
          id
          startDate
          termNumber
        }
      }
    }
  }
`),T={all:["people"],details:()=>[...T.all,"detail"],detail:r=>[...T.details(),r]},ie=()=>e.jsx("div",{className:"animate-pulse",children:e.jsxs("div",{className:"md:max-w-visualization-body flex flex-col items-center gap-y-6 px-3 md:mx-auto",children:[e.jsx("div",{className:"h-4 w-24 self-start rounded bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-6 w-32 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-40 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex gap-x-4",children:[e.jsx("div",{className:"h-9 w-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-9 w-24 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-3",children:[e.jsx("div",{className:"h-5 w-44 rounded bg-gray-200"}),e.jsx("div",{className:"h-5 w-56 rounded bg-gray-200"})]}),e.jsx("div",{className:"w-full rounded-lg border-2 border-dashed border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-48 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-52 rounded bg-gray-200"})]})}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"flex w-full flex-col gap-y-6",children:[0,1].map(r=>e.jsxs("div",{className:"flex flex-col gap-y-3 rounded-lg border border-dashed border-gray-200 p-4",children:[e.jsx("div",{className:"h-5 w-32 rounded bg-gray-200"}),e.jsx("div",{className:"h-72 w-full rounded bg-gray-200"})]},r))})]})}),ce=()=>e.jsx("div",{className:"animate-pulse px-3",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-5",children:[e.jsx("div",{className:"h-4 w-20 self-start rounded bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-5 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-24 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-36 rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex w-full flex-col gap-y-3",children:[e.jsx("div",{className:"h-9 w-full rounded bg-gray-200"}),e.jsx("div",{className:"h-9 w-full rounded bg-gray-200"})]}),e.jsxs("div",{className:"flex flex-col items-center gap-y-3",children:[e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-44 rounded bg-gray-200"})]}),e.jsx("div",{className:"w-full rounded-lg border-2 border-dashed border-gray-200 p-4",children:e.jsxs("div",{className:"flex flex-col items-center gap-y-2",children:[e.jsx("div",{className:"h-4 w-36 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-40 rounded bg-gray-200"}),e.jsx("div",{className:"h-4 w-32 rounded bg-gray-200"})]})}),e.jsx("div",{className:"h-10 w-full rounded bg-gray-200"}),e.jsx("div",{className:"flex w-full flex-col gap-y-5",children:[0,1].map(r=>e.jsxs("div",{className:"flex flex-col gap-y-2 rounded-lg border border-dashed border-gray-200 p-4",children:[e.jsx("div",{className:"h-4 w-28 rounded bg-gray-200"}),e.jsx("div",{className:"h-64 w-full rounded bg-gray-200"})]},r))})]})}),me=({isDesktop:r})=>r?e.jsx(ie,{}):e.jsx(ce,{}),ue=(r,s)=>{const a={mergedParentProposals:null,historicalParentProposals:null};return r==="proposal-cosign"?{...a,OR:[{proposers:{some:{id:{equals:s}}}},{coSigners:{some:{id:{equals:s}}}}]}:{...a,proposers:{some:{id:{equals:s}}}}},xe=/(\d+)\s*年度/,pe=/第(\d+)屆/,he=r=>{var a,t;if((a=r.term)!=null&&a.startDate)return`${new Date(r.term.startDate).getFullYear()-1911+1}年度`;const s=(t=r.session)==null?void 0:t.match(xe);if(s!=null&&s[1])return`${s[1]}年度`},ge=r=>{var a,t;if(typeof((a=r.term)==null?void 0:a.termNumber)=="number")return r.term.termNumber;const s=(t=r.session)==null?void 0:t.match(pe);if(s!=null&&s[1]){const d=Number(s[1]);return Number.isNaN(d)?void 0:d}},fe=r=>{if(!r)return new Map;const s=new Map;return r.forEach(a=>{const t=he(a);t&&s.set(t,{committeeName:a.name??"委員會",termNumber:ge(a)})}),s},F=r=>r?r.map(s=>s==null?void 0:s.termNumber).filter(s=>s!=null):[],be=(r,s)=>{const a=F(s);if(a.length>0)return[...new Set(a)].sort((d,m)=>d-m);const t=F((r==null?void 0:r.map(d=>d.term))??[]);return[...new Set(t)].sort((d,m)=>d-m)},ye=r=>{const s=b.sumBy(r,o=>o.reductionAmount||0),a=b.sumBy(r,o=>o.freezeAmount||0),t=b.filter(r,o=>o.reductionAmount).length,d=b.filter(r,o=>o.freezeAmount).length,m=b.filter(r,o=>{var p;return(p=o.proposalTypes)==null?void 0:p.includes(V.Other)}).length;return{formattedReductionAmount:j(s),formattedFreezeAmount:j(a),reductionProposalsCount:t,freezeProposalsCount:d,mainResolutionCount:m}},je=({personName:r,partyName:s,termNumbers:a})=>{const t=a.length?`第${a.join("、")}屆`:"";return e.jsxs("div",{className:"mt-4 flex min-w-[254px] flex-col items-center justify-center gap-y-2 border-b-2 border-black pb-3 lg:flex-row lg:items-end lg:gap-x-5",children:[e.jsx("p",{className:"text-[36px] md:text-[32px]",children:r}),e.jsx("p",{children:s}),t?e.jsxs("p",{className:"flex flex-wrap justify-center gap-x-2",children:[e.jsx("span",{className:"whitespace-nowrap",children:t}),e.jsx("span",{children:"立法委員"})]}):e.jsx("p",{children:"立法委員"})]})},Ne=({selectedType:r,onChange:s})=>e.jsxs("div",{className:"mt-6 flex items-center gap-x-4",children:[e.jsx("button",{className:`rounded border-2 border-black px-2.5 ${r==="proposal"?"bg-brand-primary text-white":""}`,onClick:()=>s("proposal"),children:"提案"}),e.jsx("button",{className:`rounded border-2 border-black px-2.5 ${r==="proposal-cosign"?"bg-brand-primary text-white":""}`,onClick:()=>s("proposal-cosign"),children:"提案＋連署"})]}),ve=({mode:r,onChange:s})=>e.jsx("div",{children:e.jsxs("div",{className:"mt-4 flex flex-col items-center justify-center gap-4 lg:flex-row lg:gap-6 lg:text-left",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"amount",checked:r==="amount",onChange:()=>s("amount"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依金額（刪減/凍結）"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"viz-mode",value:"count",checked:r==="count",onChange:()=>s("count"),className:"accent-brand-primary h-4 w-4"}),e.jsx("span",{children:"依數量（凍結案/刪減案/建議案）"})]})]})}),we=()=>{var k;const{id:r}=Y(),[s,a]=u.useState("proposal"),[t,d]=u.useState("amount"),m=u.useMemo(()=>ue(s,r),[s,r]),{data:o,isLoading:p,isError:N}=A({queryKey:te.list({whereFilter:m}),queryFn:()=>D(ne,{skip:0,orderBy:[{id:W.Desc}],where:m})}),v=u.useMemo(()=>o?X(o,t):[],[o,t]),{data:h,isLoading:w,isError:x}=A({queryKey:T.detail(r??""),queryFn:()=>D(de,{where:{id:r}}),enabled:!!r}),n=h==null?void 0:h.people,i=n==null?void 0:n.committees,C=u.useMemo(()=>fe(i),[i]),S=u.useMemo(()=>be(i,n==null?void 0:n.term),[i,n==null?void 0:n.term]),R=J(o),g=u.useMemo(()=>ye(R),[R]),{data:P}=A({queryKey:["budget","legislators",r??"all"],queryFn:async()=>{const c=await fetch(se);if(!c.ok)throw new Error("無法載入立委預算資料");return ae.parse(await c.json())},enabled:!!r}),E=u.useMemo(()=>{var z,L;if(!P)return;const c=P[0];if(!c)return;const l=((z=c.legislators)==null?void 0:z.find(G=>G.peopleId===r))??((L=c.legislators)==null?void 0:L[0]),f=s==="proposal-cosign"?(l==null?void 0:l.allInvolved)??(l==null?void 0:l.proposerOnly)??c.overall:(l==null?void 0:l.proposerOnly)??(l==null?void 0:l.allInvolved)??c.overall;if(!f)return;const O=f.reductionAmount??0,q=f.freezeAmount??0;return{formattedReductionAmount:j(O),formattedFreezeAmount:j(q),reductionCount:f.reductionCount??0,freezeCount:f.freezeCount??0,mainResolutionCount:f.otherCount??0}},[P,r,s]),B=u.useMemo(()=>E??{formattedReductionAmount:g.formattedReductionAmount,formattedFreezeAmount:g.formattedFreezeAmount,reductionCount:g.reductionProposalsCount,freezeCount:g.freezeProposalsCount,mainResolutionCount:g.mainResolutionCount},[E,g]),I=y("(min-width: 768px)"),_=K(),M=u.useCallback(c=>{var l;return!((l=c.children)!=null&&l.length)&&c.id?(_(`/budget/${c.id}`),!0):!1},[_]);return p||w?e.jsx(me,{isDesktop:I}):N||x?e.jsx("div",{children:"Error fetching data"}):e.jsx("div",{children:e.jsxs("div",{className:"md:max-w-visualization-body flex flex-col items-center justify-center px-3 md:mx-auto",children:[e.jsxs(U,{to:"/visualization",children:["<"," 回到視覺化主頁"]}),e.jsx(je,{personName:n==null?void 0:n.name,partyName:(k=n==null?void 0:n.party)==null?void 0:k.name,termNumbers:S}),e.jsx(Ne,{selectedType:s,onChange:a}),e.jsx(ve,{mode:t,onChange:d}),e.jsx(Z,{summary:B}),e.jsx("div",{className:"mt-6",children:e.jsx(ee,{items:re})}),e.jsx(le,{data:v,presenterDescription:n==null?void 0:n.description,yearToCommitteeMap:C,onNodeClick:M})]})})},ze=$(we);export{ze as default};
